# 1.网址
https://github.com/dotnet/aspnetcore
https://github.com/dotnet/blazor-samples
https://github.com/microsoft/fluentui-blazor
https://dotnet.microsoft.com/zh-cn/apps/aspnet    asp.net 
https://learn.microsoft.com/zh-cn/ef/core/modeling/
https://www.nuget.org/
https://github.com/spring-projects/spring-boot
https://github.com/facebook/react
https://github.com/ant-design/ant-design
https://github.com/facebook/react-native
https://github.com/expo/expo
 
Yuan1877008@   https://github.com/zuijiaoghb
https://gitee.com/yanshu2025
   
fastgithub_win-x64
   
# 2.使用 Blazor 利用 ASP.NET Core 生成第一个 Web 应用
## 2.1centos8 安装.NET8 SDK
在CentOS 8上安装.NET 8 SDK，您可以按照以下步骤操作：
启用.NET 8的官方Microsoft密钥和存储库。
安装.NET 8 SDK。
以下是具体的命令：
1. 设置Microsoft密钥和存储库
```
sudo rpm -Uvh https://packages.microsoft.com/config/centos/8/packages-microsoft-prod.rpm
```
2. 安装.NET SDK
```
sudo dnf install dotnet-sdk-8.0
sudo dnf install dotnet-sdk-9.0
```
执行上述命令后，.NET 8 SDK将在CentOS 8系统上安装。您可以通过运行dotnet --version来验证安装是否成功。

## 2.2.创建应用
在终端中，运行以下命令来创建应用:
```
dotnet new blazor -o BlazorApp
```
此命令创建新 Blazor Web 应用项目，并将其放置在当前位置内名为 BlazorApp 的新目录中。
导航到由上一条命令创建的新 BlazorApp 目录:
```
cd BlazorApp
```
快速查看 BlazorApp 目录的内容。
```
ls
```
BlazorApp 目录中已经创建了多个文件，为你提供一个可以运行的简单的 Blazor 应用。
Program.cs 是启动服务器以及在其中配置应用服务和中间件的应用的入口点。
在 Components 目录中:
App.razor 为应用的根组件。
Routes.razor 配置 Blazor 路由器。
Pages 目录包含应用的一些示例网页。
BlazorApp.csproj 定义应用项目及其依赖项。
Properties 目录中的 launchSettings.json 文件为本地开发环境定义不同的配置文件设置。创建项目时会自动分配端口号并将其保存在此文件上。
请记下 BlazorApp 目录路径，因为教程后面会用到。
如果一切正常，请选择下面的 继续 按钮以转到下一步。

## 2.3.开放5246端口，并修改Properties 目录中的 launchSettings.json 文件里的http://localhost:5246为http://1.26:5246
```
[root@cpzljc BlazorApp]# firewall-cmd --list-port
[root@cpzljc BlazorApp]# firewall-cmd --zone=public --add-port=5246/tcp --permanent
[root@cpzljc BlazorApp]# systemctl restart firewalld
[root@cpzljc BlazorApp]# firewall-cmd --list-port
```
## 2.4.运行应用
在终端中，运行以下命令:
```
dotnet watch
```
dotnet watch 命令将生成并启动应用，然后在每次更改代码时更新应用。可以选择Ctrl+C，以随时停止应用。
等待应用显示正在侦听 http://localhost:<port number> 然后打开浏览器并导航到该地址。
转到以下页面后，你已成功运行了第一个 Blazor 应用!
站点主页包含一些文本，并在左侧显示了多个选项卡，供你点击和浏览。

显示的页面由位于 Components/Pages 目录内的 Home.razor 文件定义。其内容如下所示:
Components/Pages/Home.razor
```
@page "/"

<PageTitle>Home</PageTitle>

<h1>Hello, world!</h1>

Welcome to your new app.
```
它已包含将它设置为主页的代码，并显示文本Hello, world! 和 Welcome to your new app。PageTitle 组件会设置当前页面的标题，使其显示在浏览器选项卡中。

## 2.5.ant-design-blazor  
https://github.com/ant-design-blazor/ant-design-blazor
https://github.com/MudBlazor/MudBlazor
https://mudblazor.com/
https://github.com/MudBlazor/Templates
https://github.com/CodeBeamOrg/CodeBeam.MudBlazor.Extensions
https://mudextensions.codebeam.org/

## 2.6.Blazor for ASP.NET Web Forms开发人员电子书
https://learn.microsoft.com/zh-cn/dotnet/architecture/blazor-for-web-forms-developers/

## 2.7.在centos8上安装visual studio code
在CentOS 8上安装Visual Studio Code可以通过以下步骤进行：
更新系统软件包列表：
```
sudo dnf update
```
安装必要的依赖：
```
sudo dnf install -y yum-utils
```
设置微软的软件仓库：
```
sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc
sudo dnf config-manager --add-repo https://packages.microsoft.com/yumrepos/vscode
```
安装Visual Studio Code：
```
sudo dnf install -y code
```
安装完成后，你可以通过命令行启动Visual Studio Code，或者通过桌面环境的应用菜单查找并启动它。

# 3.centos8 查询端口运行进程,关闭进程
在CentOS 8上，您可以使用ss或netstat命令来查找端口运行的进程，并使用kill命令来关闭进程。以下是具体的命令示例：
## 查询端口运行的进程：
使用ss命令查找特定端口（例如：8080）的进程
```
ss -ltnp | grep ':8080'
``` 
## 或者使用netstat命令
```
netstat -ltnp | grep ':8080'
```
## 关闭端口运行的进程：
假设查询结果显示进程ID为1234
```
kill 1234
``` 
## 如果进程不响应，可以使用强制选项
```
kill -9 1234
```
请确保您有足够的权限执行这些操作，通常需要root权限。如果没有，请使用sudo前缀来提升权限。

# 4./opt/aspnetcore/BlazorApp/DatabaseUtility.cs(1,17): error CS0234: 命名空间“Microsoft”中不存在类型或命名空间名“EntityFrameworkCore”(是否缺少程序集引用?) [/opt/aspnetcore/BlazorApp/BlazorApp.csproj]
## centos8 安装EntityFrameworkCore
在CentOS 8上安装EntityFrameworkCore，你需要使用.NET Core SDK。以下是安装EntityFrameworkCore的步骤：
安装.NET Core SDK：
访问官方.NET Core下载页面（https://dotnet.microsoft.com/download），选择CentOS 8的适当包进行安装。
安装完成后，打开终端并运行以下命令以安装EntityFrameworkCore包：
```
dotnet tool install --global dotnet-ef
```
使用以下命令来更新EntityFrameworkCore工具：
```
dotnet tool update --global dotnet-ef
```
在你的.NET Core项目中，使用以下命令来安装EntityFrameworkCore：
```
dotnet add package Microsoft.EntityFrameworkCore
```
如果你需要安装特定的数据库提供程序，比如Pomelo EntityFrameworkCore MySQL提供程序，你可以使用以下命令：
```
dotnet add package Pomelo.EntityFrameworkCore.MySql
```
请确保你的CentOS 8系统已经开启了网络连接，并且能够访问.NET Core的包管理服务。如果遇到任何依赖问题，请确保你的包管理器（如NuGet）是最新版本，并且已经正确配置。

# 5.EntityFrameworkCore 连接mysql数据库的方法
在使用EntityFrameworkCore连接MySQL数据库时，你需要安装相应的数据库提供程序包。以下是安装和配置的步骤：
安装Pomelo.EntityFrameworkCore.MySql或MySql.Data.EntityFrameworkCore。
## 使用Pomelo提供程序
```
dotnet add package Pomelo.EntityFrameworkCore.MySql
```
## 或者使用官方MySQL提供程序
```
dotnet add package MySql.Data.EntityFrameworkCore
```
在你的appsettings.json或配置文件中添加数据库连接字符串。
```
{
  "ConnectionStrings": {
    "DefaultConnection": "server=localhost;port=3306;database=mydb;user=root;password=mypassword;"
  }
}
```
配置Startup.cs或你的配置类以使用MySQL提供程序。
```
public void ConfigureServices(IServiceCollection services)
{
    // 使用Pomelo提供程序
    services.AddDbContext<YourDbContext>(options =>
        options.UseMySql(Configuration.GetConnectionString("DefaultConnection")));
 
    // 或者使用官方MySQL提供程序
    services.AddDbContext<YourDbContext>(options =>
        options.UseMySql(Configuration.GetConnectionString("DefaultConnection"), new MySqlServerVersion(new Version(8, 0, 27))));
}
```
定义你的数据模型和DbContext。
```
public class YourDbContext : DbContext
{
    public YourDbContext(DbContextOptions<YourDbContext> options) : base(options)
    {
    }
 
    public DbSet<YourEntity> YourEntities { get; set; }
 
    // 其他DbSet定义...
}
 
public class YourEntity
{
    public int Id { get; set; }
    // 其他属性...
}
使用YourDbContext进行数据库操作。

public class YourRepository
{
    private readonly YourDbContext _context;
 
    public YourRepository(YourDbContext context)
    {
        _context = context;
    }
 
    public List<YourEntity> GetAll()
    {
        return _context.YourEntities.ToList();
    }
 
    // 其他方法...
}
```
以上步骤展示了如何使用EntityFrameworkCore连接MySQL数据库。记得替换示例代码中的YourDbContext, YourEntity, YourRepository和数据库连接字符串为你自己的上下文、实体和配置。

# 7.安装fluentui-blazor
```
PS D:\> dotnet new install Microsoft.FluentUI.AspNetCore.Templates
PS D:\> dotnet new fluentblazor --name jtpjsapp  -au Individual
```
已成功创建模板“Fluent Blazor Web 应用”。
此模板包含除 Microsoft 以外其他方的技术，请参阅 https://aka.ms/aspnetcore/8.0-third-party-notices 以获取详细信息。

正在处理创建后操作...
正在还原 D:\jtpjsapp\jtpjsapp.csproj:
  正在确定要还原的项目…
  已还原 D:\jtpjsapp\jtpjsapp.csproj (用时 35.6 秒)。
已成功还原。	

PS D:\jtpjsapp> dotnet add package Microsoft.FluentUI.AspNetCore.Components.Icons
PS D:\jtpjsapp> dotnet add package Microsoft.FluentUI.AspNetCore.Components.Emoji

添加组件提供程序
在MainLayout.razor文件末尾添加以下组件。 关联服务使用这些提供程序来正确显示 Toast、对话框、工具提示或消息栏。
```
<FluentToastProvider />
<FluentDialogProvider />
<FluentTooltipProvider />
<FluentMessageBarProvider />
<FluentMenuProvider />
```

将 DataGrid 组件与 EF Core 结合使用
如果要将 与 EF Core 提供的数据一起使用，则需要安装一个额外的包，以便网格知道如何异步解析查询以提高效率。.<FluentDataGrid>
安装
通过运行以下命令安装包：
```
dotnet add package Microsoft.FluentUI.AspNetCore.Components.DataGrid.EntityFrameworkAdapter
```
用法
在您的Program.cs文件中，您需要在builder.Services.AddFluentUIComponents(...);行后添加以下内容：
builder.Services.AddDataGridEntityFrameworkAdapter();

PS D:\jtpjsapp\Components\Layout> vim .\MainLayout.razor
[root@cpzljc Layout]# cat MainLayout.razor
```
@inherits LayoutComponentBase
@inject IWebHostEnvironment Environment

<FluentLayout>
    @if (Environment.IsDevelopment()) {
    <FluentHeader>
       票据系统(开发环境)
        <FluentSpacer />
        <AuthorizeView>
                <Authorized>
                    <FluentNavLink Href="Account/Manage">@context.User.Identity?.Name</FluentNavLink>
                    <form action="Account/Logout" method="post">
                        <AntiforgeryToken />
                      @*  <input type="hidden" name="ReturnUrl" value="@currentUrl" /> *@
                        <input type="hidden" name="ReturnUrl" value="Account/Login" />
                        <FluentButton Type="ButtonType.Submit" Style="width: 100%;">注销</FluentButton>
                    </form>
                 </Authorized>
        </AuthorizeView>
    </FluentHeader>
    } else {
    <FluentHeader>
       票据系统
        <FluentSpacer />
        <AuthorizeView>
                <Authorized>
                    <FluentNavLink Href="Account/Manage">@context.User.Identity?.Name</FluentNavLink>
                    <form action="Account/Logout" method="post">
                        <AntiforgeryToken />
                      @*  <input type="hidden" name="ReturnUrl" value="@currentUrl" /> *@
                        <input type="hidden" name="ReturnUrl" value="Account/Login" />
                        <FluentButton Type="ButtonType.Submit" Style="width: 100%;">注销</FluentButton>
                    </form>
                 </Authorized>
        </AuthorizeView>
     </FluentHeader>
    }
    <FluentStack Class="main" Orientation="Orientation.Horizontal" Width="100%">
        <AuthorizeView>
            <Authorized>
                <NavMenu />
            </Authorized>
            <NotAuthorized>

            </NotAuthorized>
        </AuthorizeView>
        <FluentBodyContent Class="body-content">
            <div class="content">
                @Body
            </div>
        </FluentBodyContent>
    </FluentStack>
    <FluentFooter>
          <p> 江特电机 </p>
      @*  <a href="https://www.fluentui-blazor.net" target="_blank">Documentation and demos</a> *@
        <FluentSpacer />
      @*  <a href="https://learn.microsoft.com/en-us/aspnet/core/blazor" target="_blank">About Blazor</a>*@
    </FluentFooter>

    <FluentToastProvider />
    <FluentDialogProvider @rendermode="RenderMode.InteractiveServer" />
    <FluentTooltipProvider />
    <FluentMessageBarProvider />
    <FluentMenuProvider />
</FluentLayout>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">??</a>
</div>
```

PS D:\jtpjsapp\Components\Layout> vim .\NavMenu.razor
[root@cpzljc Layout]# cat NavMenu.razor
```
@implements IDisposable

@inject NavigationManager NavigationManager

<div class="navmenu">
    <input type="checkbox" title="Menu expand/collapse toggle" id="navmenu-toggle" class="navmenu-icon" />       
    <label for="navmenu-toggle" class="navmenu-icon"><FluentIcon Value="@(new Icons.Regular.Size20.Navigation())" Color="Color.Fill" /></label>
    <nav class="sitenav" aria-labelledby="main-menu">
        <FluentNavMenu Id="main-menu" Collapsible="true" Width="250" Title="Navigation menu" @bind-Expanded="expanded" CustomToggle="true">
           @* <FluentNavLink Href="/" Match="NavLinkMatch.All" Icon="@(new Icons.Regular.Size20.Home())" IconColor="Color.Accent">首页</FluentNavLink>
            <FluentNavLink Href="counter" Icon="@(new Icons.Regular.Size20.NumberSymbolSquare())" IconColor="Color.Accent">Counter</FluentNavLink>
            <FluentNavLink Href="weather" Icon="@(new Icons.Regular.Size20.WeatherPartlyCloudyDay())" IconColor="Color.Accent">Weather</FluentNavLink>  *@
          @*  <FluentNavLink Href="auth" Icon="@(new Icons.Regular.Size20.LockClosedKey())" IconColor="Color.Accent">授权登录</FluentNavLink> *@
            <AuthorizeView>
                <Authorized>
                    @*
                    <FluentNavLink Href="Account/Manage">@context.User.Identity?.Name</FluentNavLink>
                    <form action="Account/Logout" method="post">
                        <AntiforgeryToken />
                        <input type="hidden" name="ReturnUrl" value="@currentUrl" />
                        <input type="hidden" name="ReturnUrl" value="Account/Login" />
                        <FluentButton Type="ButtonType.Submit" Style="width: 100%;">注销</FluentButton>
                    </form>
                    *@
                    <FluentNavLink Href="recbill" Icon="@(new Icons.Regular.Size20.Money())" IconColor="Color.Accent">应收票据</FluentNavLink>
                    <FluentNavLink Href="motherRecbilllist" Icon="@(new Icons.Regular.Size20.List())"  IconColor="Color.Accent">应收票据母票列表</FluentNavLink>
                    <FluentNavLink Href="childRecbilllist" Icon="@(new Icons.Regular.Size20.TicketHorizontal())"  IconColor="Color.Accent">应收票据子票列表</FluentNavLink>
                </Authorized>
                <NotAuthorized>
                    <FluentNavLink Href="Account/Register">注册</FluentNavLink>
                    <FluentNavLink Href="Account/Login">登录</FluentNavLink>
                </NotAuthorized>
            </AuthorizeView>
        </FluentNavMenu>
    </nav>
</div>

@code {
    private bool expanded = true;
    private string? currentUrl;

    protected override void OnInitialized()
    {
        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}
```

[root@cpzljc Components]# cat App.razor 
```html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/" />
    <link rel="stylesheet" href="app.css" />
    <link rel="stylesheet" href="jtpjsapp.styles.css" />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <HeadOutlet />
</head>

<body>
    <Routes  @rendermode="RenderModeForPage" />
    <script src="_framework/blazor.web.js"></script>
    <script>
    window.downloadFileFromStream = async (fileName, contentStreamReference) => {
    const arrayBuffer = await contentStreamReference.arrayBuffer();
    const blob = new Blob([arrayBuffer]);
    const url = URL.createObjectURL(blob);
    const anchorElement = document.createElement('a');
    anchorElement.href = url;
    anchorElement.download = fileName ?? '';
    anchorElement.click();
    anchorElement.remove();
    URL.revokeObjectURL(url);
    }
    </script>
</body>

</html>

@code {
    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    private IComponentRenderMode? RenderModeForPage =>
        HttpContext.Request.Path.StartsWithSegments("/Account")
            ? null
            : InteractiveServer;
}
```

[root@cpzljc Components]# cat Routes.razor 
```html
@using jtpjsapp.Components.Account.Shared
@inject NavigationManager NavigationManager

<Router AppAssembly="typeof(Program).Assembly">

        <Found Context="routeData">
             @if (NavigationManager.Uri.Contains("/Account/Login") || NavigationManager.Uri.Contains("/Account/Register") ) {
                 <RouteView RouteData="routeData" DefaultLayout="typeof(Layout.MainLayout)" />      

                 <FocusOnNavigate RouteData="routeData" Selector="h1" />
             } else {
                  <AuthorizeRouteView RouteData="routeData" DefaultLayout="typeof(Layout.MainLayout)">
                    <NotAuthorized>
                         <RedirectToLogin />
                    </NotAuthorized>
                 </AuthorizeRouteView>

                 <FocusOnNavigate RouteData="routeData" Selector="h1" />
             }

        </Found>
</Router>
```

[root@cpzljc Data]# cat RecBillModel.cs 
```csharp
using System.ComponentModel.DataAnnotations;
using Microsoft.EntityFrameworkCore;

namespace jtpjsapp.Data ;

//[Table("RecBillModels")]
[Index(nameof(TicketNumber), nameof(SubTicketNumber), IsUnique = true)]
public class RecBillModel
{

  public RecBillModel() {}

  public RecBillModel(DateTime dt, DateTime td, DateTime dd , DateTime addtime , DateTime modifytime) {
        this.RecDate = dt;
        this.TicketIssueDate = td;
        this.DueDate = dd;
        this.AddTime = addtime;
        this.ModifyTime = modifytime;
   }

   public int Id { get; set; }

   [Required]
   [Comment("收票日期")]
   public DateTime RecDate { get; set; }

    [Required]
    [StringLength(16,
        ErrorMessage = "Identifier too long (16 character limit).")]
    public string RecVoucher { get; set; }

    [Required]
    [MaxLength(100)]
    public string EntryName { get; set; }

    [Required]
        [StringLength(50,
        ErrorMessage = "Identifier too long (50 character limit).")]
    public string RecBillCategory { get; set; }

    [Required]
        [StringLength(50,
        ErrorMessage = "Identifier too long (50 character limit).")]
    public string FrontRela { get; set; }

    [Required]
        [StringLength(10,
        ErrorMessage = "Identifier too long (10 character limit).")]
    public string NewGeneration { get; set; }

    [Required]
        [StringLength(50,
        ErrorMessage = "Identifier too long (50 character limit).")]
    public string TicketNumber { get; set; }

    [Required]
        [StringLength(50,
        ErrorMessage = "Identifier too long (50 character limit).")]
    public string SubTicketNumber { get; set; }

    [Required]
        [StringLength(50,
        ErrorMessage = "Identifier too long (50 character limit).")]
    public string IssuingUnit { get; set; }

    [Required]
        [StringLength(50,
        ErrorMessage = "Identifier too long (50 character limit).")]
    public string AcceptorName { get; set; }

    [Required]
        [StringLength(10,
        ErrorMessage = "Identifier too long (10 character limit).")]
    public string Is69 { get; set; }

    [Required]
   // [Column(TypeName = "decimal(10, 2)")]
    [Precision(14, 2)]
   // [Range(0.00001, 999999999999, ErrorMessage = "承兑金额要大于0。")]
    public decimal AcceptAmount { get; set; }

    [Required]
    public DateTime TicketIssueDate { get; set; }

    [Required]
    public DateTime DueDate { get; set; }

    public bool Selected { get; set; }

    // user ID from AspNetUser table.
    public string OwnerID { get; set; }

    [Required]
    public RecbillStatus Status { get; set; }

    [Required]
    public RecbillCompany Company { get; set; }

    public string? Endorser { get; set; }

    [Required]
    [Precision(14, 2)]
    public decimal Balance { get; set; }

    [Precision(14, 2)]
    public decimal? TransferAmount { get; set; }

    [Required]
    public DateTime AddTime { get; set; }

    public DateTime? ModifyTime { get; set; }


    [StringLength(10,
    ErrorMessage = "Identifier too long (10 character limit).")]
    public string IsMotherTicket { get; set; }

    /*
    [Range(1, 100000,
        ErrorMessage = "Accommodation invalid (1-100000).")]
    public int MaximumAccommodation { get; set; }


    [Required]
    [Range(typeof(bool), "true", "true",
        ErrorMessage = "This form disallows unapproved ships.")]
    public bool IsValidatedDesign { get; set; }

    [Required]
    public DateTime ProductionDate { get; set; }
    */
}

public enum RecbillStatus
{
    Submitted,
    Approved,
    Rejected
}

public enum RecbillCompany
{
   江特电机,
   江西江特,
   银锂新能源,
   杭州米格,
   天津华兴,
   宜丰锂业,
   泰昌矿业,
   江特电动车,
   江特客车厂,
   江特节能公司,
   江特高新装备公司,
   江特高新武汉分公司
}
```

[root@cpzljc Data]# cat RecBillDbContext.cs
```csharp
using Microsoft.EntityFrameworkCore;

namespace jtpjsapp.Data;

public class RecBillDbContext : DbContext
{
    public DbSet<RecBillModel> RecBillModels { get; set; }
    //public DbSet<Post> Posts { get; set; }

    public RecBillDbContext(DbContextOptions<RecBillDbContext> options)
        : base(options)
    {
    }

}
```

[root@cpzljc Data]# cat ApplicationDbContext.cs 
```csharp
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;

namespace jtpjsapp.Data;

public class ApplicationDbContext(DbContextOptions<ApplicationDbContext> options) : IdentityDbContext<ApplicationUser>(options)
{
    public DbSet<RecBillModel> RecBillModels { get; set; }

}
```

PS D:\jtpjsapp\Components\Pages> cp Counter.razor Recbill.razor
PS D:\jtpjsapp\Components> vim .\_Imports.razor
```html
@using System.Net.Http
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.FluentUI.AspNetCore.Components
@using Microsoft.JSInterop
@using jtpjsapp
@using jtpjsapp.Components
@using System.ComponentModel.DataAnnotations
@using System.ComponentModel.DataAnnotations.Schema
@using Microsoft.EntityFrameworkCore
@using jtpjsapp.Data
@using jtpjsapp.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authorization
@using ClosedXML.Excel
@using System.IO


PS D:\jtpjsapp\Components\Pages> vim .\Recbill.razor
@page "/recbill"
@rendermode InteractiveServer
@attribute [Authorize]

@implements IDisposable
@inject ILogger<RecBillModel> Logger
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IDialogService DialogService
@inject IAuthorizationService AuthorizationService
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>应收票据</PageTitle>
 <FluentStack>
 <FluentButton Type="ButtonType.Button"  Appearance="Appearance.Accent" Disabled="@adddisabled"  OnClick="@addRecbillAsync" >新增母票</FluentButton>
    <FluentTextField  @bind-Value="ticketNumberOption"  Required="true"   Label="票号：" Minlength="1" Maxlength="50">    </FluentTextField>
    <FluentTextField  @bind-Value="subTicketNumberOption"  Required="true"   Label="子票号：" Minlength="1" Maxlength="50">    </FluentTextField>
 <FluentButton Type="ButtonType.Button"  Appearance="Appearance.Accent" Disabled="@finddisabled"  OnClick="@FindRecBillByTicketNumberAndSubTicketNumber" >查询母票/子票</FluentButton>
 <FluentButton Type="ButtonType.Button"  Appearance="Appearance.Accent" Disabled="@modifydisabled" OnClick="@modifyRecbllByTicketNumberAndSubTicketNumberAndId">修改</FluentButton>
 <FluentButton Type="ButtonType.Button"  Appearance="Appearance.Accent" Disabled="@deletedisabled" OnClick="@deleteRecbllByTicketNumberAndSubTicketNumberAndId" >删除</FluentButton>
 </FluentStack>
<h1 style="text-align: center">应收票据</h1>
<EditForm  Model="recbill" OnValidSubmit="Submit" FormName="Recbill1">
    <DataAnnotationsValidator />
    <ValidationSummary />

  <FluentGrid Spacing="1" >
    <FluentGridItem lg="4">
         <FluentSelect TOption="RecbillCompany"
               Items=@(Enum.GetValues<RecbillCompany>() )
               Placeholder="选择单位..."
               OptionText="@(i => Enum.GetName(i))"
               OptionValue="@(i => ((int)(i)).ToString() )"
               @bind-Value="@recbillCompany"
               @bind-SelectedOption="@recbill.Company"
               Label="所属单位："
               Disabled="@formdisabled"
               Required="false" />
     </FluentGridItem>

    <FluentGridItem lg="4">
    <FluentLabel>
        收票日期:
        <br/>
       @* <FluentDatePicker  @bind-Value="recbill.RecDate" @bind-PickerMonth="recbill.RecDate" /> *@
       <InputDate  @bind-Value="recbill.RecDate"  Disabled="@formdisabled"  />
    </FluentLabel>
    </FluentGridItem>
    <FluentGridItem lg="4">
    <FluentTextField  @bind-Value="recbill.RecVoucher" Required="true"   Label="收票凭证号:" Minlength="1" Maxlength="16"   Disabled="@formdisabled" >
    </FluentTextField>
    </FluentGridItem>
    <FluentGridItem lg="4">
    <FluentTextField  @bind-Value="recbill.EntryName"  Required="true"   Label="项目名称（即前手单位）：" Minlength="1" Maxlength="50"  Disabled="@formdisabled" >
    </FluentTextField>
    </FluentGridItem>

    <FluentGridItem lg="4">
    <FluentSelect Items=@recBillCategoryOptions
               OptionText="@(i => i.Text)"
               OptionValue="@(i => i.Value)"
               OptionSelected="@(i => i.Selected)"
               @bind-Value="@recbill.RecBillCategory"
               Label="应收票据类别："
               Disabled="@formdisabled"
               Required="false" />
    </FluentGridItem>
    <FluentGridItem lg="4">
    <FluentTextField  @bind-Value="recbill.FrontRela"  Required="true"   Label="与前手的关系：" Minlength="1" Maxlength="16"  Disabled="@formdisabled" >    </FluentTextField>
    </FluentGridItem>
    <FluentGridItem lg="4">
         <FluentSelect Items=@newGenerationOptions
               OptionText="@(i => i.Text)"
               OptionValue="@(i => i.Value)"
               OptionSelected="@(i => i.Selected)"
               @bind-Value="@recbill.NewGeneration"
               Label="新一代："
               Disabled="@formdisabled"
               Required="false" />
    </FluentGridItem>

    <FluentGridItem lg="4">
    <FluentTextField  @bind-Value="recbill.TicketNumber"  Required="true"   Label="票号：" Minlength="1" Maxlength="50"  Disabled="@formdisabled" >    </FluentTextField>
    </FluentGridItem>

    <FluentGridItem lg="4">
    <FluentTextField  @bind-Value="recbill.SubTicketNumber"  Required="true"   Label="子票号：" Minlength="1" Maxlength="50"  Disabled="@formdisabled" >    </FluentTextField>
    </FluentGridItem>

    <FluentGridItem lg="4">
    <FluentTextField  @bind-Value="recbill.IssuingUnit"  Required="true"   Label="出票单位：" Minlength="1" Maxlength="50"  Disabled="@formdisabled" >    </FluentTextField>
    </FluentGridItem>

    <FluentGridItem lg="4">
    <FluentTextField  @bind-Value="recbill.AcceptorName"  Required="true"   Label="承兑人名称：" Minlength="1" Maxlength="50"  Disabled="@formdisabled" >    </FluentTextField>
    </FluentGridItem>

    <FluentGridItem lg="4">
         <FluentSelect Items=@is69Options
               OptionText="@(i => i.Text)"
               OptionValue="@(i => i.Value)"
               OptionSelected="@(i => i.Selected)"
               @bind-Value="@recbill.Is69"
               Label="是否为6+9："
               Disabled="@formdisabled"
               Required="false" />
    </FluentGridItem>

    <FluentGridItem lg="4">
    <FluentLabel>
    承兑金额：
    <br/>
    <InputNumber  @bind-Value="recbill.AcceptAmount"  Disabled="@formdisabled" />
    </FluentLabel>
    </FluentGridItem>

    <FluentGridItem lg="4">
    <FluentLabel>
    余额：
    <br/>
    <InputNumber  @bind-Value="recbill.Balance"  Disabled="@childdisabled" />
    </FluentLabel>
    </FluentGridItem>

    <FluentGridItem lg="4">
    <FluentLabel>
    转出金额：
    <br/>
    <InputNumber  @bind-Value="recbill.TransferAmount"  Disabled="@childdisabled" />
    </FluentLabel>
    </FluentGridItem>

    <FluentGridItem lg="4">
    <FluentLabel>
        出票日:
        <br/>
       @* <FluentDatePicker  @bind-Value="recbill.RecDate" @bind-PickerMonth="recbill.RecDate" /> *@
       <InputDate  @bind-Value="recbill.TicketIssueDate"  Disabled="@formdisabled" />
    </FluentLabel>
    </FluentGridItem>

    <FluentGridItem lg="4">
    <FluentLabel>
        到期日:
        <br/>
       @* <FluentDatePicker  @bind-Value="recbill.RecDate" @bind-PickerMonth="recbill.RecDate" /> *@
       <InputDate  @bind-Value="recbill.DueDate"  Disabled="@formdisabled"  />
    </FluentLabel>
   </FluentGridItem>

    <FluentGridItem lg="4">
    <FluentTextField  @bind-Value="recbill.Endorser"   Label="背书人："  Maxlength="100"  Disabled="@childdisabled" >
    </FluentTextField>
    </FluentGridItem>

   <FluentGridItem lg="4">
    <FluentLabel>
        新建时间:
        <br/>
       @* <FluentDatePicker  @bind-Value="recbill.RecDate" @bind-PickerMonth="recbill.RecDate" /> *@
       <InputDate  @bind-Value="recbill.AddTime"  Disabled="@foreverdisabled"  />
    </FluentLabel>
   </FluentGridItem>

   <FluentGridItem lg="4">
    <FluentLabel>
        修改时间:
        <br/>
       @* <FluentDatePicker  @bind-Value="recbill.RecDate" @bind-PickerMonth="recbill.RecDate" /> *@       
	   <InputDate  @bind-Value="recbill.ModifyTime"  Disabled="@foreverdisabled"  />
    </FluentLabel>
   </FluentGridItem>

    <FluentGridItem lg="4">
         <FluentSelect Items=@isMotherTicketOptions
               OptionText="@(i => i.Text)"
               OptionValue="@(i => i.Value)"
               OptionSelected="@(i => i.Selected)"
               @bind-Value="@recbill.IsMotherTicket"
               Label="母票/子票："
               Disabled="@foreverdisabled"
               Required="true" />
    </FluentGridItem>

    </FluentGrid>
    <br/>
  @* <button type="submit">提交</button> *@
   <FluentButton Type="ButtonType.Submit" Disabled="@submitdisabled"  Appearance="Appearance.Accent">保存</FluentButton>
    <FluentButton Type="ButtonType.Button"  Appearance="Appearance.Accent" Disabled="@cansledisabled" OnClick="@cansleSubmit" >取消</FluentButton>

</EditForm>


@*
<div role="status" style="padding-bottom: 1em;">
    Current count: <FluentBadge Appearance="Appearance.Neutral">@currentCount</FluentBadge>
</div>

<FluentButton Appearance="Appearance.Accent" @onclick="IncrementCount">Click me</FluentButton>
*@

@code {
        private ApplicationDbContext? Context { get; set; }
        private bool Busy;

    private int currentCount = 0;
    private bool adddisabled = false;
    private bool finddisabled = false;
    private bool modifydisabled = true;
    private bool deletedisabled = true;
    private bool submitdisabled = true;
    private bool cansledisabled = true;
    private bool formdisabled = true;
    private bool ismodifybutton = false;
    private bool foreverdisabled = true;
    private bool motherdisabled = true;
    private bool childdisabled = true;

    private string ticketNumberOption;
    private string subTicketNumberOption;

    private string recbillCompany;


   // [SupplyParameterFromForm]
    private RecBillModel recbill = new RecBillModel(DateTime.Now, DateTime.Now, DateTime.Now, DateTime.Now, DateTime.Now);

    static List<Option<string>> recBillCategoryOptions = new()
    {
        { new Option<string> { Value = "电子银行承兑汇票", Text = "电子银行承兑汇票" } },
        { new Option<string> { Value = "其他", Text = "其他" } }
    };

    static List<Option<string>> newGenerationOptions = new()
    {
        { new Option<string> { Value = "是", Text = "是" } },
        { new Option<string> { Value = "否", Text = "否" } }
    };

    static List<Option<string>> is69Options = new()
    {
        { new Option<string> { Value = "是", Text = "是" } },
        { new Option<string> { Value = "否", Text = "否" } }
    };

    /*
    static List<Option<string>> companyOptions = new()
    {
        { new Option<string> { Value = "1", Text = "江特电机" } },
        { new Option<string> { Value = "2", Text = "江西江特" } },
        { new Option<string> { Value = "3", Text = "银锂新能源" } },
        { new Option<string> { Value = "4", Text = "杭州米格" } },
        { new Option<string> { Value = "5", Text = "天津华兴" } },
        { new Option<string> { Value = "6", Text = "宜丰锂业" } },
        { new Option<string> { Value = "7", Text = "泰昌矿业" } },
        { new Option<string> { Value = "8", Text = "江特电动车" } },
         { new Option<string> { Value = "9", Text = "江特客车厂" } },
         { new Option<string> { Value = "10", Text = "江特节能公司" } },
         { new Option<string> { Value = "11", Text = "江特高新装备公司" } },
         { new Option<string> { Value = "12", Text = "江特高新武汉分公司" } }
    };
    */


    static List<Option<string>> isMotherTicketOptions = new()
    {
        { new Option<string> { Value = "母票", Text = "母票" } },
        { new Option<string> { Value = "子票", Text = "子票" } }
    };

    private void IncrementCount()
    {
        currentCount++;
    }

   protected override async Task OnInitializedAsync()
   {
           Busy = true;

           Context = DbFactory.CreateDbContext();

           Busy = false;

           await base.OnInitializedAsync();
           // ... 其他初始化代码
           recbillCompany = "1";
           recbill.Company = RecbillCompany.江西江特;
           recbill.RecBillCategory = "电子银行承兑汇票";
           recbill.NewGeneration = "是";
           recbill.Is69 = "是";
   }

    private  async Task  addRecbillAsync(){
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        recbill.OwnerID = UserManager.GetUserId(user);
        var isAuthorized = await AuthorizationService.AuthorizeAsync(
                                                        user, recbill,
                                                        RecbillOperations.Create);
        if (!isAuthorized.Succeeded)
        {
            //return Forbid();
           var dialog = await DialogService.ShowErrorAsync("当前用户没有新建权限。" );
           var result = await dialog.Result;
        } else {
        formdisabled = false;
        submitdisabled = false;
        cansledisabled = false;
        ismodifybutton = false;
        modifydisabled = true;
        deletedisabled = true;
        finddisabled = true;
        recbill = new RecBillModel(DateTime.Now, DateTime.Now, DateTime.Now , DateTime.Now, DateTime.Now );
        recbillCompany = "1";
        recbill.Company = RecbillCompany.江西江特;
        recbill.RecBillCategory = "电子银行承兑汇票";
        recbill.NewGeneration = "是";
        recbill.Is69 = "是";
     }
    }

    private  void cansleSubmit(){
        if (ismodifybutton == false ) {
        formdisabled = true;
        submitdisabled = true;
        cansledisabled = true;
        modifydisabled = true;
        deletedisabled = true;
        finddisabled = false;
        recbill = new RecBillModel(DateTime.Now, DateTime.Now, DateTime.Now, DateTime.Now, DateTime.Now);
        }

        if (ismodifybutton == true ) {
        formdisabled = true;
        submitdisabled = true;
        cansledisabled = true;
        modifydisabled = false;
        deletedisabled = false;
        finddisabled = false;
        }
    }

    private async Task  modifyRecbllByTicketNumberAndSubTicketNumberAndId(){
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var isAuthorized = await AuthorizationService.AuthorizeAsync(
                                                        user, recbill,
                                                        RecbillOperations.Update);
        if (!isAuthorized.Succeeded)
        {
           // return Forbid();
           var dialog = await DialogService.ShowErrorAsync("当前用户没有修改权限。" );
           var result = await dialog.Result;
        } else {
        formdisabled = false;
        submitdisabled = false;
        cansledisabled =false;
        ismodifybutton = true;
        modifydisabled = true;
        deletedisabled = true;
        finddisabled = true;
        Busy = false;
      }

    }

   private async Task  deleteRecbllByTicketNumberAndSubTicketNumberAndId() {
       var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
       var user = authState.User;

       var isAuthorized = await AuthorizationService.AuthorizeAsync(
                                                        user, recbill,
                                                        RecbillOperations.Delete);
       if (!isAuthorized.Succeeded)
       {
               // return Forbid();
               var dialog = await DialogService.ShowErrorAsync("当前用户没有删除该数据权限。" );
               var result = await dialog.Result;
       } else {

       if (Busy) {
            return;
        }

            Busy = true;
        var dialog1 = await DialogService.ShowConfirmationAsync("确认删除吗?", "是", "否", "再次确认");
        var result1 = await dialog1.Result;
        bool canceled = result1.Cancelled;

        if (canceled == false) {
            int count = 0 ;

            try {
                 var recb = Context.RecBillModels.Single(b => b.TicketNumber == recbill.TicketNumber && b.SubTicketNumber== recbill.SubTicketNumber && b.Id==recbill.Id);
                 Context.RecBillModels.Remove(recb);
                 count = Context.SaveChanges();
            } catch (Microsoft.EntityFrameworkCore.DbUpdateException e ) {
                var dialog = await DialogService.ShowErrorAsync("删除失败!该票据不存在。" );
                var result = await dialog.Result;
                //canceled = result.Cancelled;
                                Busy = false;
             }
             if (count>0) {
                var dialog = await DialogService.ShowSuccessAsync("删除成功！");
                var result = await dialog.Result;
                //canceled = result.Cancelled;
               submitdisabled = true;
               cansledisabled = true;
                modifydisabled = true;
                deletedisabled = true;
                recbill = new RecBillModel(DateTime.Now, DateTime.Now, DateTime.Now, DateTime.Now, DateTime.Now);

                                Busy = false;
             }
        }

        if (canceled == true) {
              submitdisabled = true;
              cansledisabled = true;
        }

                Busy = false;
     }
   }

    private async Task  Submit()
    {
        Logger.LogInformation("收票日期 = {RecDate}", recbill?.RecDate);

        if (ismodifybutton == false) {
            if (Busy) {
                return;
            }
            Busy = true;

            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            recbill.OwnerID = UserManager.GetUserId(user);

            var isAuthorized = await AuthorizationService.AuthorizeAsync(
                                                        user, recbill,
                                                        RecbillOperations.Create);
            if (!isAuthorized.Succeeded)
            {
               // return Forbid();
               var dialog = await DialogService.ShowErrorAsync("当前用户没有新建权限。" );
               var result = await dialog.Result;
            } else {

           int count = 0 ;

           try {
            if (recbill.AcceptAmount <= 0)
            {
             var dialog = await DialogService.ShowErrorAsync("承兑金额要大于0。" );
             var result = await dialog.Result;
            } else {
                 recbill.Status = RecbillStatus.Submitted;
                 recbill.Balance = recbill.AcceptAmount;
                 recbill.IsMotherTicket = "母票";
                 Context.RecBillModels.Add(recbill);
                 count = Context.SaveChanges();
            }
            } catch (Microsoft.EntityFrameworkCore.DbUpdateException e ) {
                var dialog = await DialogService.ShowErrorAsync("保存失败!该票据已存在。" );
                var result = await dialog.Result;
                //canceled = result.Cancelled;
                finddisabled = false;
                modifydisabled = true;
                deletedisabled = true;
               submitdisabled = true;
               cansledisabled = true;
                formdisabled = true;
                                Busy = false;
             }
             if (count>0) {
                var dialog = await DialogService.ShowSuccessAsync("保存成功！");
                var result = await dialog.Result;
                //canceled = result.Cancelled;
                finddisabled = false;
                modifydisabled = true;
                deletedisabled = true;
               submitdisabled = true;
               cansledisabled = true;
                formdisabled = true;
                recbill = new RecBillModel(DateTime.Now, DateTime.Now, DateTime.Now, DateTime.Now, DateTime.Now);
                                Busy = false;
             }
             }

                         Busy = false;
        }

       if (ismodifybutton == true) {
            if (Busy) {
                  return;
            }

           Busy = true;
           int count = 0 ;

           try {
            if (recbill.AcceptAmount <= 0)
            {
             var dialog = await DialogService.ShowErrorAsync("承兑金额要大于0。" );
             var result = await dialog.Result;
            } else {
                  var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                  var user = authState.User;

                  var isAuthorized = await AuthorizationService.AuthorizeAsync(
                                                        user, recbill,
                                                        RecbillOperations.Update);
                  if (!isAuthorized.Succeeded)
                  {
                   // return Forbid();
                   var dialog = await DialogService.ShowErrorAsync("当前用户没有修改权限。" );
                   var result = await dialog.Result;
                  } else {
                var recb = Context.RecBillModels.Single(b => b.TicketNumber == recbill.TicketNumber && b.SubTicketNumber== recbill.SubTicketNumber && b.Id==recbill.Id);
                recb.RecDate = recbill.RecDate;
                recb.RecVoucher = recbill.RecVoucher;
                recb.EntryName = recbill.EntryName;
                recb.RecBillCategory = recbill.RecBillCategory;
                recb.FrontRela = recbill.FrontRela;
                recb.NewGeneration = recbill.NewGeneration;
                recb.IssuingUnit = recbill.IssuingUnit;
                recb.AcceptorName = recbill.AcceptorName;
                recb.Is69 = recbill.Is69;
                recb.AcceptAmount = recbill.AcceptAmount;
                recb.TicketIssueDate = recbill.TicketIssueDate;
                recb.DueDate = recbill.DueDate;
                recb.Company = recbill.Company;
                recb.ModifyTime = DateTime.Now;
                 count = Context.SaveChanges();
               }
            }
            } catch (Microsoft.EntityFrameworkCore.DbUpdateException e ) {
                var dialog = await DialogService.ShowErrorAsync("保存失败。" );
                var result = await dialog.Result;
                //canceled = result.Cancelled;
                Busy = false;
             }
             if (count>0) {
                var dialog = await DialogService.ShowSuccessAsync("保存成功！");
                var result = await dialog.Result;
                //canceled = result.Cancelled;
                submitdisabled = true;
                cansledisabled = true;
                modifydisabled = true;
                deletedisabled = true;
                finddisabled = false;
                recbill = new RecBillModel(DateTime.Now, DateTime.Now, DateTime.Now, DateTime.Now, DateTime.Now);
                Busy = false;
             }

          Busy = false;
        }
         Busy = false;
    }


    private async Task FindRecBillByTicketNumberAndSubTicketNumber()
    {
        if (Busy) {
            return;
        }

                Busy = true;
        modifydisabled = true;
        deletedisabled = true;

           if (ticketNumberOption is null || subTicketNumberOption is null) {
                var dialog = await DialogService.ShowErrorAsync("查询前请输入票号和子票号。" );
                var result = await dialog.Result;
                modifydisabled = true;
                deletedisabled = true;
            } else {
              try {
              RecBillModel recb =  Context.RecBillModels.Single(b => b.TicketNumber == ticketNumberOption && b.SubTicketNumber==subTicketNumberOption);
              recbill.Id=recb.Id;
              recbill.RecDate=recb.RecDate;
              recbill.RecVoucher=recb.RecVoucher;
              recbill.EntryName=recb.EntryName;
              recbill.RecBillCategory=recb.RecBillCategory;
              recbill.FrontRela=recb.FrontRela;
              recbill.NewGeneration=recb.NewGeneration;
              recbill.TicketNumber=recb.TicketNumber;
              recbill.SubTicketNumber=recb.SubTicketNumber;
              recbill.IssuingUnit=recb.IssuingUnit;
              recbill.AcceptorName=recb.AcceptorName;
              recbill.Is69=recb.Is69;
              recbill.AcceptAmount=recb.AcceptAmount;
              recbill.TicketIssueDate=recb.TicketIssueDate;
              recbill.DueDate=recb.DueDate;
              recbill.OwnerID=recb.OwnerID;
              recbill.Status=recb.Status;
              recbill.Company=recb.Company;
              recbillCompany = ((int)recb.Company).ToString();
              recbill.Endorser=recb.Endorser;
              recbill.Balance=recb.Balance;
              recbill.TransferAmount=recb.TransferAmount;
              recbill.AddTime=recb.AddTime;
              recbill.ModifyTime=recb.ModifyTime;
              recbill.IsMotherTicket=recb.IsMotherTicket;

              var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
              var user = authState.User;
              var isAuthorized = await AuthorizationService.AuthorizeAsync(
                                                        user, recbill,
                                                        RecbillOperations.Read);
              if (!isAuthorized.Succeeded)
              {
                // return Forbid();
                recbill = new RecBillModel( DateTime.Now, DateTime.Now, DateTime.Now, DateTime.Now, DateTime.Now );
                var dialog = await DialogService.ShowErrorAsync("当前用户没有查询该数据的权限。" );
                var result = await dialog.Result;
                recbill = new RecBillModel(DateTime.Now, DateTime.Now, DateTime.Now, DateTime.Now, DateTime.Now);
              } else {
                  modifydisabled = false;
                  deletedisabled = false;
              }
            } catch (System.InvalidOperationException e ) {
                var dialog = await DialogService.ShowErrorAsync("该票据不存在。" );
                var result = await dialog.Result;
                //canceled = result.Cancelled;
                recbill = new RecBillModel(DateTime.Now, DateTime.Now, DateTime.Now, DateTime.Now, DateTime.Now);
              modifydisabled = true;
              deletedisabled = true;
                          Busy = false;
             }
          }

                formdisabled = true;
                submitdisabled = true;
                cansledisabled = true;

                Busy = false;
     }

    public void Dispose()
    {
       Context?.Dispose();
    }

}
```

该示例还配置了数据库日志记录来显示生成的 SQL 查询。 这是在 appsettings.Development.json 中配置的：
PS D:\jtpjsapp> vim .\appsettings.Development.json
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore.Database.Command": "Information"
    }
  },
  "Kestrel": {
    "Endpoints": {
      "MyHttpEndpoint": {
        "Url": "http://1.26:5200"
      }
    }
  }
}
```

PS D:\jtpjsapp> dotnet add package Pomelo.EntityFrameworkCore.MySql
必须将 dotnet ef 安装为全局工具或本地工具。 大多数开发人员偏向于使用以下命令将 dotnet ef 安装为全局工具：
.NET CLI
```
dotnet tool install --global dotnet-ef
[root@cpzljc jtpjsapp]# dotnet add package Microsoft.EntityFrameworkCore.Design
```

[root@cpzljc jtpjsapp]# cat Program.cs
```csharp
using Microsoft.AspNetCore.Components.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using Microsoft.FluentUI.AspNetCore.Components;
using jtpjsapp.Components;
using jtpjsapp.Components.Account;
using jtpjsapp.Data;
using Pomelo.EntityFrameworkCore.MySql.Infrastructure;
using Microsoft.AspNetCore.Authorization;
using jtpjsapp.Authorization;
using static Microsoft.AspNetCore.Http.StatusCodes;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
builder.Services.AddRazorComponents()
    .AddInteractiveServerComponents();
builder.Services.AddFluentUIComponents();
builder.Services.AddDataGridEntityFrameworkAdapter();

builder.Services.AddCascadingAuthenticationState();
builder.Services.AddScoped<IdentityUserAccessor>();
builder.Services.AddScoped<IdentityRedirectManager>();
builder.Services.AddScoped<AuthenticationStateProvider, IdentityRevalidatingAuthenticationStateProvider>();      

builder.Services.AddAuthentication(options =>
    {
        options.DefaultScheme = IdentityConstants.ApplicationScheme;
        options.DefaultSignInScheme = IdentityConstants.ExternalScheme;
    })
    .AddIdentityCookies();

//var connectionString = builder.Configuration.GetConnectionString("DefaultConnection") ?? throw new InvalidOperationException("Connection string 'DefaultConnection' not found.");
//builder.Services.AddDbContext<ApplicationDbContext>(options =>
  //  options.UseSqlite(connectionString));
builder.Services.AddDbContextFactory<ApplicationDbContext>(opt =>
    opt.UseMySql("server=1.26;port=3306;database=jt_pjs;user=root;password=jtT0795,.,;" , new MySqlServerVersion(new Version(8, 0, 31)) )
        // The following three options help with debugging, but should
        // be changed or removed for production.
        .LogTo(Console.WriteLine, LogLevel.Information)
        .EnableSensitiveDataLogging()
        .EnableDetailedErrors() );
builder.Services.AddDatabaseDeveloperPageExceptionFilter();

builder.Services.AddIdentityCore<ApplicationUser>(options => options.SignIn.RequireConfirmedAccount = true)      
    .AddRoles<IdentityRole>()
    .AddEntityFrameworkStores<ApplicationDbContext>()
    .AddSignInManager()
    .AddDefaultTokenProviders();

/*
builder.Services.AddAuthorization(options =>
    {
        options.FallbackPolicy = new AuthorizationPolicyBuilder()
            .RequireAuthenticatedUser()
            .Build();
    });
*/

builder.Services.AddAuthorization();


builder.Services.AddSingleton<IEmailSender<ApplicationUser>, IdentityNoOpEmailSender>();

// Authorization handlers.
builder.Services.AddScoped<IAuthorizationHandler,
                      RecbillIsOwnerAuthorizationHandler>();

builder.Services.AddSingleton<IAuthorizationHandler,
                      RecbillAdministratorsAuthorizationHandler>();

builder.Services.AddSingleton<IAuthorizationHandler,
                      RecbillManagerAuthorizationHandler>();

/*
builder.Services.AddHsts(options =>
{
    options.Preload = true;
    options.IncludeSubDomains = true;
    options.MaxAge = TimeSpan.FromDays(60);
    options.ExcludedHosts.Add("example.com");
    options.ExcludedHosts.Add("www.example.com");
});



builder.Services.AddHttpsRedirection(options =>
{
    options.RedirectStatusCode = Status307TemporaryRedirect;
    options.HttpsPort = 5246;
});
*/


var app = builder.Build();

using (var scope = app.Services.CreateScope())
{
    var services = scope.ServiceProvider;
    var context = services.GetRequiredService<ApplicationDbContext>();
    context.Database.Migrate();
    // requires using Microsoft.Extensions.Configuration;
    // Set password with the Secret Manager tool.
    // dotnet user-secrets set SeedUserPW <pw>

    var testUserPw = builder.Configuration.GetValue<string>("SeedUserPW");

   await SeedData.Initialize(services, testUserPw);
}

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseMigrationsEndPoint();
}
else
{
     app.UseExceptionHandler("/Error", createScopeForErrors: true);
    // The default HSTS value is 30 days. You may want to change this for production scenarios, see https://aka.ms/aspnetcore-hsts.
     app.UseHsts();
}

app.UseHttpsRedirection();

//app.UseRouting();
app.UseAuthentication();
app.UseAuthorization();

app.UseStaticFiles();
app.UseAntiforgery();

app.MapRazorComponents<App>()
    .AddInteractiveServerRenderMode();

// Add additional endpoints required by the Identity /Account Razor components.
app.MapAdditionalIdentityEndpoints();

app.Run();
```
```
[root@cpzljc jtpjsapp]# dotnet ef migrations add InitialCreate
```
Build started...
Build succeeded.
warn: Microsoft.EntityFrameworkCore.Model.Validation[10400]
      Sensitive data logging is enabled. Log entries and exception messages may include sensitive application data; this mode should only be enabled during development.
warn: 2024/9/21 11:43:15.825 CoreEventId.SensitiveDataLoggingEnabledWarning[10400] (Microsoft.EntityFrameworkCore.Infrastructure)
      Sensitive data logging is enabled. Log entries and exception messages may include sensitive application data; this mode should only be enabled during development.
Done. To undo this action, use 'ef migrations remove'

```
[root@cpzljc jtpjsapp]# dotnet ef database update
```
Build started...
Build succeeded.


建议通过生成 SQL 脚本，将迁移部署到生产数据库。 此策略的优点包括：
可以检查 SQL 脚本的准确性；这一点很重要，因为将架构更改应用于生产数据库是一项可能导致数据丢失的潜在危险操作。
在某些情况下，可以根据生产数据库的特定需求调整这些脚本。
SQL 脚本可以与部署技术结合使用，甚至可以在 CI 过程中生成。
SQL 脚本可以提供给 DBA，并且可以单独管理和存档。
```shell
[root@cpzljc jtpjsapp]# dotnet ef migrations script
```
Build started...
Build succeeded.
warn: Microsoft.EntityFrameworkCore.Model.Validation[10400]
      Sensitive data logging is enabled. Log entries and exception messages may include sensitive application data; this mode should only be enabled during development.
warn: 2024/9/21 14:26:50.263 CoreEventId.SensitiveDataLoggingEnabledWarning[10400] (Microsoft.EntityFrameworkCore.Infrastructure)
      Sensitive data logging is enabled. Log entries and exception messages may include sensitive application data; this mode should only be enabled during development.
CREATE TABLE IF NOT EXISTS `__EFMigrationsHistory` (
    `MigrationId` varchar(150) CHARACTER SET utf8mb4 NOT NULL,
    `ProductVersion` varchar(32) CHARACTER SET utf8mb4 NOT NULL,
    CONSTRAINT `PK___EFMigrationsHistory` PRIMARY KEY (`MigrationId`)
) CHARACTER SET=utf8mb4;

START TRANSACTION;

ALTER DATABASE CHARACTER SET utf8mb4;

CREATE TABLE `RecBillModels` (
    `Id` int NOT NULL AUTO_INCREMENT,
    `RecDate` datetime(6) NOT NULL COMMENT '收票日期',
    `RecVoucher` varchar(16) CHARACTER SET utf8mb4 NOT NULL,
    `EntryName` varchar(100) CHARACTER SET utf8mb4 NOT NULL,
    `RecBillCategory` longtext CHARACTER SET utf8mb4 NOT NULL,
    `FrontRela` longtext CHARACTER SET utf8mb4 NOT NULL,
    `NewGeneration` longtext CHARACTER SET utf8mb4 NOT NULL,
    `TicketNumber` varchar(255) CHARACTER SET utf8mb4 NOT NULL,
    `SubTicketNumber` varchar(255) CHARACTER SET utf8mb4 NOT NULL,
    `IssuingUnit` longtext CHARACTER SET utf8mb4 NOT NULL,
    `AcceptorName` longtext CHARACTER SET utf8mb4 NOT NULL,
    `Is69` longtext CHARACTER SET utf8mb4 NOT NULL,
    `AcceptAmount` decimal(14,2) NOT NULL,
    `TicketIssueDate` datetime(6) NOT NULL,
    `DueDate` datetime(6) NOT NULL,
    CONSTRAINT `PK_RecBillModels` PRIMARY KEY (`Id`)
) CHARACTER SET=utf8mb4;

CREATE UNIQUE INDEX `IX_RecBillModels_TicketNumber_SubTicketNumber` ON `RecBillModels` (`TicketNumber`, `SubTicketNumber`);

INSERT INTO `__EFMigrationsHistory` (`MigrationId`, `ProductVersion`)
VALUES ('20240921034316_InitialCreate', '8.0.8');

COMMIT;

START TRANSACTION;

ALTER TABLE `RecBillModels` MODIFY COLUMN `TicketNumber` varchar(50) CHARACTER SET utf8mb4 NOT NULL;

ALTER TABLE `RecBillModels` MODIFY COLUMN `SubTicketNumber` varchar(50) CHARACTER SET utf8mb4 NOT NULL;

ALTER TABLE `RecBillModels` MODIFY COLUMN `RecBillCategory` varchar(50) CHARACTER SET utf8mb4 NOT NULL;

ALTER TABLE `RecBillModels` MODIFY COLUMN `NewGeneration` varchar(10) CHARACTER SET utf8mb4 NOT NULL;

ALTER TABLE `RecBillModels` MODIFY COLUMN `IssuingUnit` varchar(50) CHARACTER SET utf8mb4 NOT NULL;

ALTER TABLE `RecBillModels` MODIFY COLUMN `Is69` varchar(10) CHARACTER SET utf8mb4 NOT NULL;

ALTER TABLE `RecBillModels` MODIFY COLUMN `FrontRela` varchar(50) CHARACTER SET utf8mb4 NOT NULL;

ALTER TABLE `RecBillModels` MODIFY COLUMN `AcceptorName` varchar(50) CHARACTER SET utf8mb4 NOT NULL;

INSERT INTO `__EFMigrationsHistory` (`MigrationId`, `ProductVersion`)
VALUES ('20240921054902_RecBillModel_stringlength_change', '8.0.8');

COMMIT;

```shell
[root@cpzljc jtpjsapp]# dotnet ef migrations list
```
```shell
[root@cpzljc jtpjsapp]# dotnet ef migrations script  InitialCreate   RecBillModel_stringlength_change
```
Build started...
Build succeeded.
warn: Microsoft.EntityFrameworkCore.Model.Validation[10400]
      Sensitive data logging is enabled. Log entries and exception messages may include sensitive application data; this mode should only be enabled during development.
warn: 2024/9/21 14:31:27.243 CoreEventId.SensitiveDataLoggingEnabledWarning[10400] (Microsoft.EntityFrameworkCore.Infrastructure)
      Sensitive data logging is enabled. Log entries and exception messages may include sensitive application data; this mode should only be enabled during development.
START TRANSACTION;

ALTER TABLE `RecBillModels` MODIFY COLUMN `TicketNumber` varchar(50) CHARACTER SET utf8mb4 NOT NULL;

ALTER TABLE `RecBillModels` MODIFY COLUMN `SubTicketNumber` varchar(50) CHARACTER SET utf8mb4 NOT NULL;

ALTER TABLE `RecBillModels` MODIFY COLUMN `RecBillCategory` varchar(50) CHARACTER SET utf8mb4 NOT NULL;

ALTER TABLE `RecBillModels` MODIFY COLUMN `NewGeneration` varchar(10) CHARACTER SET utf8mb4 NOT NULL;

ALTER TABLE `RecBillModels` MODIFY COLUMN `IssuingUnit` varchar(50) CHARACTER SET utf8mb4 NOT NULL;

ALTER TABLE `RecBillModels` MODIFY COLUMN `Is69` varchar(10) CHARACTER SET utf8mb4 NOT NULL;

ALTER TABLE `RecBillModels` MODIFY COLUMN `FrontRela` varchar(50) CHARACTER SET utf8mb4 NOT NULL;

ALTER TABLE `RecBillModels` MODIFY COLUMN `AcceptorName` varchar(50) CHARACTER SET utf8mb4 NOT NULL;

INSERT INTO `__EFMigrationsHistory` (`MigrationId`, `ProductVersion`)
VALUES ('20240921054902_RecBillModel_stringlength_change', '8.0.8');

COMMIT;


[root@cpzljc Pages]# vim MotherRecbillList.razor 
```html
@page "/motherRecbilllist"
@rendermode InteractiveServer
@attribute [Authorize]

@implements IDisposable
@inject ILogger<RecBillModel> Logger
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IDialogService DialogService
@inject IAuthorizationService AuthorizationService
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JS

<PageTitle>应收票据母票列表</PageTitle>
<h2>查询条件:</h2>
<FluentGrid Spacing="1" >
<FluentGridItem lg="2">
    <FluentLabel>
        收票日期:
        <br/>
        开始： <InputDate  @bind-Value="recbilllistRecDateStart" Size="20" />
        <br/>
        结束： <InputDate  @bind-Value="recbilllistRecDateEnd" Size="20" />
    </FluentLabel>
</FluentGridItem>
<FluentGridItem lg="2">
    <FluentTextField  @bind-Value="recbilllistIssuingUnit"    Label="出票单位：" Minlength="1" Maxlength="50"   >    </FluentTextField>
</FluentGridItem>
<FluentGridItem lg="2">
    <FluentTextField  @bind-Value="recbilllistAcceptorName"   Label="承兑人名称：" Minlength="1" Maxlength="50"  >    </FluentTextField>
</FluentGridItem>
<FluentGridItem lg="2">
    <FluentTextField  @bind-Value="recbilllistTicketNumber"     Label="票号：" Minlength="1" Maxlength="50">    </FluentTextField>
</FluentGridItem>
<FluentGridItem lg="2">
    <FluentTextField  @bind-Value="recbilllistSubTicketNumber"     Label="子票号：" Minlength="1" Maxlength="50">    </FluentTextField>
</FluentGridItem>
<FluentGridItem lg="2">
    <FluentButton Type="ButtonType.Button"  Appearance="Appearance.Accent"  OnClick="@FindRecbillList" >查询</FluentButton>
    <FluentButton Type="ButtonType.Button" Appearance="Appearance.Accent" OnClick="@SplitRecbillAsync">拆分</FluentButton>
    <FluentButton Type="ButtonType.Button" Appearance="Appearance.Accent" OnClick="@ExportExcelAsync">导出excel</FluentButton>
</FluentGridItem>
</FluentGrid>
<h1 style="text-align: center">应收票据母票列表</h1>

<div style="display: table; table-layout: fixed; width: 100%;">
<div style="overflow-x: auto;">
<FluentDataGrid Items="@recbills.AsQueryable()"  TGridItem="RecBillModel"  ResizableColumns="true"

                Pagination="@pagination" ShowHover="true"
>
    @*
    <TemplateColumn Tooltip="true" TooltipText="@(c => "拆分票据号： " + c.TicketNumber+"+" + c.SubTicketNumber)" Title="功能" Width="100px" Align="Align.Center" InitialSortDirection="SortDirection.Ascending" IsDefaultSortColumn=true>
        <FluentButton Type="ButtonType.Button" Appearance="Appearance.Accent" OnClick="@SplitRecbillAsync">拆分</FluentButton>
    </TemplateColumn>
   *@
    <SelectColumn TGridItem="RecBillModel"
                  SelectMode="DataGridSelectMode.Single"
                  SelectFromEntireRow="true"
                  @bind-SelectedItems="@SelectedItems" />
    <PropertyColumn Property="@(p => p.Id)" Sortable="true" Title="序号" Width="60px" Align="Align.Center"  Tooltip="true"  />
    <PropertyColumn Property="@(p => p.Company)"  Sortable="true"  Title="所属单位"  Width="180px" Align="Align.Center" Tooltip="true"/>
    <PropertyColumn Property="@(p => p.RecDate)" Format="yyyy-MM-dd" Sortable="true"  Title="收票 日期"  Width="120px" Align="Align.Center" Tooltip="true" />
    <PropertyColumn Property="@(p => p.RecVoucher)"  Sortable="true"  Title="收票凭证号"  Width="140px" Align="Align.Center" Tooltip="true" />
        <PropertyColumn Property="@(p => p.EntryName)"  Sortable="true"  Title="项目名称（即前手单位）"  Width="250px" Align="Align.Center" Tooltip="true" />
        <PropertyColumn Property="@(p => p.RecBillCategory)"  Sortable="true"  Title="应收票据类别"  Width="180px" Align="Align.Center" Tooltip="true"/>
        <PropertyColumn Property="@(p => p.FrontRela)"  Sortable="true"  Title="与前手的关系"  Width="180px" Align="Align.Center" Tooltip="true" />
        <PropertyColumn Property="@(p => p.NewGeneration)"  Sortable="true"  Title="新一代"  Width="80px" Align="Align.Center" Tooltip="true" />
        <PropertyColumn Property="@(p => p.TicketNumber)"  Sortable="true"  Title="票号" Width="260px"  Align="Align.Center"  Tooltip="true" />
        <PropertyColumn Property="@(p => p.SubTicketNumber)"  Sortable="true"  Title="子票号"  Width="240px" Align="Align.Center"  Tooltip="true"/>
        <PropertyColumn Property="@(p => p.IssuingUnit)"  Sortable="true"  Title="出票单位"  Width="240px" Align="Align.Center"  Tooltip="true"/>
        <PropertyColumn Property="@(p => p.AcceptorName)"  Sortable="true"  Title="承兑人名称"  Width="240px" Align="Align.Center"  Tooltip="true"/>
        <PropertyColumn Property="@(p => p.Is69)"  Sortable="true"  Title="是否6+9"  Width="100px" Align="Align.Center"  Tooltip="true"/>
        <PropertyColumn Property="@(p => p.AcceptAmount)"  Sortable="true"  Title="承兑金额"  Width="160px" Align="Align.Center" Tooltip="true"/>
        <PropertyColumn Property="@(p => p.Balance)"  Sortable="true"  Title="余额"  Width="160px" Align="Align.Center" Tooltip="true"/>
        <PropertyColumn Property="@(p => p.TicketIssueDate)"  Format="yyyy-MM-dd"  Sortable="true"  Title="出票日"  Width="120px" Align="Align.Center"  Tooltip="true"/>
        <PropertyColumn Property="@(p => p.DueDate)"  Format="yyyy-MM-dd"  Sortable="true"  Title="到期日"  Width="120px" Align="Align.Center" Tooltip="true"/>
        <PropertyColumn Property="@(p => p.AddTime)"  Format="yyyy-MM-dd"  Sortable="true"  Title="新建时间"  Width="120px" Align="Align.Center" Tooltip="true"/>
        <PropertyColumn Property="@(p => p.ModifyTime)"  Format="yyyy-MM-dd"  Sortable="true"  Title="修改时间"  Width="120px" Align="Align.Center" Tooltip="true"/>
        <PropertyColumn Property="@(p => p.IsMotherTicket)"  Sortable="true"  Title="母票/子票"  Width="100px" Align="Align.Center" Tooltip="true"/>
        <PropertyColumn Property="@(p => p.Status)"  Sortable="true"  Title="状态"  Width="180px" Align="Align.Center" Tooltip="true"/>
</FluentDataGrid>
</div>
</div>

<FluentPaginator State="@pagination" />

@code {
        private ApplicationDbContext? Context { get; set; }
        private bool Busy;

        //private IQueryable<RecBillModel> recbills;
        private List<RecBillModel> recbills;
        PaginationState pagination = new PaginationState { ItemsPerPage = 10 };
        IEnumerable<RecBillModel> SelectedItems;

        private DateTime recbilllistRecDateStart = DateTime.Now;
        private DateTime recbilllistRecDateEnd = DateTime.Now;
        private string recbilllistTicketNumber;
        private string recbilllistSubTicketNumber;
        private string recbilllistIssuingUnit;
        private string recbilllistAcceptorName;

        protected override async Task OnInitializedAsync()
       {
              Busy = true;

              Context = DbFactory.CreateDbContext();
              recbills  = Context.RecBillModels
                                                .Where(r => (recbilllistRecDateStart != DateTime.MinValue&& recbilllistRecDateEnd != DateTime.MinValue  && r.RecDate.Date >= recbilllistRecDateStart.Date  && r.RecDate.Date<= recbilllistRecDateEnd.Date) &&
                                                             (!string.IsNullOrEmpty(recbilllistTicketNumber) ? r.TicketNumber==recbilllistTicketNumber : true ) &&
                                                             (!string.IsNullOrEmpty(recbilllistSubTicketNumber) ? r.SubTicketNumber==recbilllistSubTicketNumber : true) &&
                                                             (!string.IsNullOrEmpty(recbilllistIssuingUnit) ? r.IssuingUnit==recbilllistIssuingUnit : true) &&
                                                             (!string.IsNullOrEmpty(recbilllistAcceptorName) ? r.AcceptorName==recbilllistAcceptorName : true) && r.IsMotherTicket=="母票" ).ToList();

               var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
               var user = authState.User;

               var isAuthorized = user.IsInRole(Recbills.RecbillManagersRole) ||
                                  user.IsInRole(Recbills.RecbillAdministratorsRole);

               var currentUserId = UserManager.GetUserId(user);

                if (!isAuthorized)
                {
                  recbills = recbills.Where(r => r.Status == RecbillStatus.Approved
                                            || r.OwnerID == currentUserId).ToList();
                }
             SelectedItems = recbills.AsQueryable().Where(p => p.Selected).ToList().AsQueryable();

            Busy = false;

       await base.OnInitializedAsync();
           // ... 其他初始化代码
       }

        private async Task FindRecbillList() {
              if (Busy) {
                  return;
              }

              Busy = true;
              try {
                  recbills = Context.RecBillModels
                                                 .Where(r => (recbilllistRecDateStart != DateTime.MinValue&& recbilllistRecDateEnd != DateTime.MinValue  && r.RecDate.Date >= recbilllistRecDateStart.Date  && r.RecDate.Date<= recbilllistRecDateEnd.Date) &&
                                                             (!string.IsNullOrEmpty(recbilllistTicketNumber) ? r.TicketNumber==recbilllistTicketNumber : true ) &&
                                                             (!string.IsNullOrEmpty(recbilllistSubTicketNumber) ? r.SubTicketNumber==recbilllistSubTicketNumber : true) &&
                                                             (!string.IsNullOrEmpty(recbilllistIssuingUnit) ? r.IssuingUnit==recbilllistIssuingUnit : true) &&
                                                             (!string.IsNullOrEmpty(recbilllistAcceptorName) ? r.AcceptorName==recbilllistAcceptorName : true) && r.IsMotherTicket=="母票" ).ToList();

               var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
               var user = authState.User;

               var isAuthorized = user.IsInRole(Recbills.RecbillManagersRole) ||
                                  user.IsInRole(Recbills.RecbillAdministratorsRole);

               var currentUserId = UserManager.GetUserId(user);

                if (!isAuthorized)
                {
                  recbills = recbills.Where(r => r.Status == RecbillStatus.Approved
                                            || r.OwnerID == currentUserId).ToList();
                }
            } catch (System.InvalidOperationException e ) {
                var dialog = await DialogService.ShowErrorAsync("查询票据列表异常。" );
                var result = await dialog.Result;
                //canceled = result.Cancelled;
                Busy = false;
             }

            Busy = false;
        }

     private async Task SplitRecbillAsync() {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var isAuthorized = await AuthorizationService.AuthorizeAsync(
                                                        user, SelectedItems.FirstOrDefault(),
                                                        RecbillOperations.Split);
        if (!isAuthorized.Succeeded)
        {
            //return Forbid();
           var dialog = await DialogService.ShowErrorAsync("当前用户没有拆分该票据的权限。" );
           var result = await dialog.Result;
        } else {
         DialogParameters parameters = new()
         {
            Title = "拆分票据",
            Width = "500px",
            Height = "350px",
            PreventDismissOnOverlayClick = true,
            PreventScroll = true,
         };

         if(SelectedItems.FirstOrDefault() is null) {
                var dialog = await DialogService.ShowErrorAsync("请先选择要拆分的票据。" );
                var result = await dialog.Result;
         } else {
                IDialogReference dialog = await DialogService.ShowDialogAsync<SplitRecbillDialog>(SelectedItems.FirstOrDefault(), parameters);
                DialogResult? result = await dialog.Result;

                if (!result.Cancelled && result.Data != null)
                {
                   List<RecBillModel> RecBillModelList = new ();
                   RecBillModelList.Add((RecBillModel)result.Data);
                   SelectedItems = RecBillModelList;
                }
         }
       }
     }

     private Stream GetFileStream()
     {
        var randomBinaryData = new byte[50 * 1024];
        var fileStream = new MemoryStream(randomBinaryData);

        return fileStream;
     }

     private async Task ExportExcelAsync() {
         using var workbook = new XLWorkbook();
         var worksheet = workbook.AddWorksheet("应收票据母票列表");
         worksheet.ColumnWidth = 12;
         //worksheet.Cell("A1").Value = "Hello World!";
         //worksheet.Cell("A2").FormulaA1 = "MID(A1, 7, 5)";
         worksheet.Cell("A1").InsertTable(recbills);
         worksheet.Cell("A1").Value = "序号";
         worksheet.Cell("B1").Value = "收票日期";
         worksheet.Cell("C1").Value = "收票凭证号";
         worksheet.Cell("D1").Value = "项目名称（即前手单位）";
         worksheet.Cell("E1").Value = "应收票据类别";
         worksheet.Cell("F1").Value = "与前手的关系";
         worksheet.Cell("G1").Value = "新一代";
         worksheet.Cell("H1").Value = "票号";
         worksheet.Cell("I1").Value = "子票号";
         worksheet.Cell("J1").Value = "出票单位";
         worksheet.Cell("K1").Value = "承兑人名称";
         worksheet.Cell("L1").Value = "是否6+9";
         worksheet.Cell("M1").Value = "承兑金额";
         worksheet.Cell("N1").Value = "出票日";
         worksheet.Cell("O1").Value = "到期日";
         worksheet.Cell("P1").Value = "是否选中";
         worksheet.Cell("Q1").Value = "用户ID";
         worksheet.Cell("R1").Value = "状态";
         worksheet.Cell("S1").Value = "所属单位";
         worksheet.Cell("T1").Value = "背书人";
         worksheet.Cell("U1").Value = "余额";
         worksheet.Cell("V1").Value = "转出金额";
         worksheet.Cell("W1").Value = "新建时间";
         worksheet.Cell("X1").Value = "修改时间";
         worksheet.Cell("Y1").Value = "母票/子票";
         worksheet.Columns().AdjustToContents();
         //workbook.SaveAs("/opt/aspnetcore/jtpjsapp/files/export/应收票据母票列表.xlsx");

         var fileStream = GetFileStream();
         workbook.SaveAs(fileStream);
         fileStream.Seek(0, SeekOrigin.Begin);
         var fileName = "应收票据母票列表.xlsx";

         using var streamRef = new DotNetStreamReference(stream: fileStream);

         await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
     }

    public void Dispose()
    {
         Context?.Dispose();
    }

}
```

[root@cpzljc Pages]# vim SplitRecbillDialog.razor
```html
@implements IDialogContentComponent<RecBillModel>
@using System.ComponentModel.DataAnnotations

@implements IDisposable
@inject ILogger<RecBillModel> Logger
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IDialogService DialogService
@attribute [Authorize]

@* Header *@
<FluentDialogHeader ShowDismiss="true">
    <FluentStack VerticalAlignment="VerticalAlignment.Center">
        <FluentIcon Value="@(new Icons.Regular.Size24.WindowApps())" />
        <FluentLabel Typo="Typography.PaneHeader">
            @Dialog.Instance.Parameters.Title
        </FluentLabel>
    </FluentStack>
</FluentDialogHeader>

@* Footer *@
<FluentDialogFooter>
    <FluentButton Appearance="Appearance.Accent" OnClick="@SaveAsync">保存</FluentButton>
    <FluentButton Appearance="Appearance.Neutral" OnClick="@CancelAsync">取消</FluentButton>
</FluentDialogFooter>

@* Body *@
<FluentDialogBody>
    <p>当前票据的票据号: @Content.TicketNumber，子票据号:@Content.SubTicketNumber，承兑金额：@Content.AcceptAmount，余额：@Content.Balance。</p>
    <FluentTextField @bind-Value="@newSubTicketNumber" Required="true">拆分子票号：</FluentTextField>
    <FluentTextField @bind-Value="@Endorser" Required="true">背书人：</FluentTextField>
    <FluentNumberField @bind-Value="@SplitAcceptAmount" Required="true">转出金额:</FluentNumberField>
</FluentDialogBody>

@code {
    private ApplicationDbContext? Context { get; set; }
    private bool Busy;
    private int count;

    private decimal SplitAcceptAmount;
    private string newSubTicketNumber;
    private string Endorser;
    public RecBillModel newRecbill = new RecBillModel();

    [Parameter]
    public RecBillModel Content { get; set; }

    [CascadingParameter]
    public FluentDialog? Dialog { get; set; }

    protected override async Task OnInitializedAsync()
    {
          Busy = true;

          Context = DbFactory.CreateDbContext();

          Busy = false;

        await base.OnInitializedAsync();
        // ... 其他初始化代码
    }

    private async Task SaveAsync()
    {
        if (Busy) {
            return;
        }

        Busy=true;
        try {
            if (newSubTicketNumber is null) {
                var dialog = await DialogService.ShowErrorAsync("拆分子票号必填。" );
                var result = await dialog.Result;
            } else if (Endorser is null) {
                 var dialog = await DialogService.ShowErrorAsync("背书人必填。" );
                 var result = await dialog.Result;
            } else if (SplitAcceptAmount > Content.Balance || SplitAcceptAmount<=0 || Content.Balance==0) {      
                 var dialog = await DialogService.ShowErrorAsync("转出金额要小于当前票据余额，且转出金额要大于0，且当前票据余额为0不能拆分。" );
                 var result = await dialog.Result;
            } else {
                   newRecbill.Company = Content.Company;
                   newRecbill.RecDate = Content.RecDate;
                   newRecbill.RecVoucher = Content.RecVoucher;
                   newRecbill.EntryName = Content.EntryName;
                   newRecbill.RecBillCategory = Content.RecBillCategory;
                   newRecbill.FrontRela = Content.FrontRela;
                   newRecbill.NewGeneration = Content.NewGeneration;
                   newRecbill.TicketNumber = Content.TicketNumber;
                   newRecbill.SubTicketNumber = newSubTicketNumber;
                   newRecbill.IssuingUnit = Content.IssuingUnit;
                   newRecbill.AcceptorName = Content.AcceptorName;
                   newRecbill.Is69 = Content.Is69;
                   newRecbill.AcceptAmount = Content.AcceptAmount;
                   newRecbill.TransferAmount = SplitAcceptAmount;
                   newRecbill.Balance = Content.Balance - SplitAcceptAmount;
                   newRecbill.TicketIssueDate = Content.TicketIssueDate;
                   newRecbill.DueDate = Content.DueDate;
                   newRecbill.Endorser = Endorser;
                   newRecbill.AddTime = DateTime.Now;
                   newRecbill.ModifyTime = DateTime.Now;
                   newRecbill.IsMotherTicket = "子票";
                   newRecbill.OwnerID = Content.OwnerID;
                   newRecbill.Status = RecbillStatus.Submitted;
                   Context.RecBillModels.Add(newRecbill);
                   count = Context.SaveChanges();

                   try {
                       var recb = Context.RecBillModels.Single(b => b.TicketNumber == Content.TicketNumber && b.SubTicketNumber== Content.SubTicketNumber && b.Id==Content.Id);
                       recb.Balance = recb.Balance - SplitAcceptAmount;
                       Content.Balance = recb.Balance - SplitAcceptAmount;
                       count = Context.SaveChanges();
                  } catch (Microsoft.EntityFrameworkCore.DbUpdateException e ) {
                      var dialog = await DialogService.ShowErrorAsync("修改原票据承兑金额失败。" );
                      var result = await dialog.Result;
                      //canceled = result.Cancelled;
                      Busy = false;
                  }
            }
            } catch (Microsoft.EntityFrameworkCore.DbUpdateException e ) {
                   var dialog = await DialogService.ShowErrorAsync("保存新票据失败!" );
                   var result = await dialog.Result;
                   //canceled = result.Cancelled;
                   Busy = false;
             }
             if (count>0) {
                 var dialog = await DialogService.ShowSuccessAsync("拆分成功！");
                 var result = await dialog.Result;
                 //canceled = result.Cancelled;
                 Busy = false;
              }

        await Dialog.CloseAsync(Content);
    }

    private async Task CancelAsync()
    {
        await Dialog.CancelAsync();
    }

    public void Dispose()
    {
        // Context?.Dispose();
   }
}
```

[root@cpzljc Pages]# cat ChildRecbillList.razor
```html
@page "/childRecbilllist"
@rendermode InteractiveServer
@attribute [Authorize]

@implements IDisposable
@inject ILogger<RecBillModel> Logger
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IDialogService DialogService
@inject IAuthorizationService AuthorizationService
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JS

<PageTitle>应收票据子票列表</PageTitle>
<h2>查询条件:</h2>
<FluentGrid Spacing="1" >
<FluentGridItem lg="2">
    <FluentLabel>
        收票日期:
        <br/>
        开始： <InputDate  @bind-Value="recbilllistRecDateStart" Size="20" />
        <br/>
        结束： <InputDate  @bind-Value="recbilllistRecDateEnd" Size="20" />
    </FluentLabel>
</FluentGridItem>
<FluentGridItem lg="2">
    <FluentTextField  @bind-Value="recbilllistIssuingUnit"    Label="出票单位：" Minlength="1" Maxlength="50"   >    </FluentTextField>
</FluentGridItem>
<FluentGridItem lg="2">
    <FluentTextField  @bind-Value="recbilllistAcceptorName"   Label="承兑人名称：" Minlength="1" Maxlength="50"  >    </FluentTextField>
</FluentGridItem>
<FluentGridItem lg="2">
    <FluentTextField  @bind-Value="recbilllistTicketNumber"     Label="票号：" Minlength="1" Maxlength="50">    </FluentTextField>
</FluentGridItem>
<FluentGridItem lg="2">
    <FluentTextField  @bind-Value="recbilllistSubTicketNumber"     Label="子票号：" Minlength="1" Maxlength="50">    </FluentTextField>
</FluentGridItem>
<FluentGridItem lg="2">
    <FluentButton Type="ButtonType.Button"  Appearance="Appearance.Accent"  OnClick="@FindRecbillList" >查询</FluentButton>
    <FluentButton Type="ButtonType.Button"  Appearance="Appearance.Accent"  OnClick="@ExportExcelAsync" >导出excel</FluentButton>
</FluentGridItem>
</FluentGrid>
<h1 style="text-align: center">应收票据子票列表</h1>

<div style="display: table; table-layout: fixed; width: 100%;">
<div style="overflow-x: auto;">
<FluentDataGrid Items="@recbills.AsQueryable()"  TGridItem="RecBillModel"  ResizableColumns="true"

                Pagination="@pagination" ShowHover="true"
>
    @*
    <TemplateColumn Tooltip="true" TooltipText="@(c => "拆分票据号： " + c.TicketNumber+"+" + c.SubTicketNumber)" Title="功能" Width="100px" Align="Align.Center" InitialSortDirection="SortDirection.Ascending" IsDefaultSortColumn=true>
        <FluentButton Type="ButtonType.Button" Appearance="Appearance.Accent" OnClick="@SplitRecbillAsync">拆分</FluentButton>
    </TemplateColumn>
   *@
    <SelectColumn TGridItem="RecBillModel"
                  SelectMode="DataGridSelectMode.Single"
                  SelectFromEntireRow="true"
                  @bind-SelectedItems="@SelectedItems" />
    <PropertyColumn Property="@(p => p.Id)" Sortable="true" Title="序号" Width="60px" Align="Align.Center"  Tooltip="true"  />
    <PropertyColumn Property="@(p => p.Company)"  Sortable="true"  Title="所属单位"  Width="180px" Align="Align.Center" Tooltip="true"/>
    <PropertyColumn Property="@(p => p.RecDate)" Format="yyyy-MM-dd" Sortable="true"  Title="收票 日期"  Width="120px" Align="Align.Center" Tooltip="true" />
    <PropertyColumn Property="@(p => p.RecVoucher)"  Sortable="true"  Title="收票凭证号"  Width="140px" Align="Align.Center" Tooltip="true" />
        <PropertyColumn Property="@(p => p.EntryName)"  Sortable="true"  Title="项目名称（即前手单位）"  Width="250px" Align="Align.Center" Tooltip="true" />
        <PropertyColumn Property="@(p => p.RecBillCategory)"  Sortable="true"  Title="应收票据类别"  Width="180px" Align="Align.Center" Tooltip="true"/>
        <PropertyColumn Property="@(p => p.FrontRela)"  Sortable="true"  Title="与前手的关系"  Width="180px" Align="Align.Center" Tooltip="true" />
        <PropertyColumn Property="@(p => p.NewGeneration)"  Sortable="true"  Title="新一代"  Width="80px" Align="Align.Center" Tooltip="true" />
        <PropertyColumn Property="@(p => p.TicketNumber)"  Sortable="true"  Title="票号" Width="260px"  Align="Align.Center"  Tooltip="true" />
        <PropertyColumn Property="@(p => p.SubTicketNumber)"  Sortable="true"  Title="子票号"  Width="240px" Align="Align.Center"  Tooltip="true"/>
        <PropertyColumn Property="@(p => p.IssuingUnit)"  Sortable="true"  Title="出票单位"  Width="240px" Align="Align.Center"  Tooltip="true"/>
        <PropertyColumn Property="@(p => p.AcceptorName)"  Sortable="true"  Title="承兑人名称"  Width="240px" Align="Align.Center"  Tooltip="true"/>
        <PropertyColumn Property="@(p => p.Is69)"  Sortable="true"  Title="是否6+9"  Width="100px" Align="Align.Center"  Tooltip="true"/>
        <PropertyColumn Property="@(p => p.AcceptAmount)"  Sortable="true"  Title="承兑金额"  Width="160px" Align="Align.Center" Tooltip="true"/>
        <PropertyColumn Property="@(p => p.Balance)"  Sortable="true"  Title="余额"  Width="160px" Align="Align.Center" Tooltip="true"/>
        <PropertyColumn Property="@(p => p.TransferAmount)"  Sortable="true"  Title="转出金额"  Width="160px" Align="Align.Center" Tooltip="true"/>
        <PropertyColumn Property="@(p => p.TicketIssueDate)"  Format="yyyy-MM-dd"  Sortable="true"  Title="出票日"  Width="120px" Align="Align.Center"  Tooltip="true"/>
        <PropertyColumn Property="@(p => p.DueDate)"  Format="yyyy-MM-dd"  Sortable="true"  Title="到期日"  Width="120px" Align="Align.Center" Tooltip="true"/>
        <PropertyColumn Property="@(p => p.Endorser)"   Sortable="true"  Title="背书人"  Width="160px" Align="Align.Center" Tooltip="true"/>
        <PropertyColumn Property="@(p => p.AddTime)"  Format="yyyy-MM-dd"  Sortable="true"  Title="新建时间"  Width="120px" Align="Align.Center" Tooltip="true"/>
        <PropertyColumn Property="@(p => p.ModifyTime)"  Format="yyyy-MM-dd"  Sortable="true"  Title="修改时间"  Width="120px" Align="Align.Center" Tooltip="true"/>
        <PropertyColumn Property="@(p => p.IsMotherTicket)"  Sortable="true"  Title="母票/子票"  Width="100px" Align="Align.Center" Tooltip="true"/>
</FluentDataGrid>
</div>
</div>

<FluentPaginator State="@pagination" />

@code {
        private ApplicationDbContext? Context { get; set; }
        private bool Busy;

        //private IQueryable<RecBillModel> recbills;
        private List<RecBillModel> recbills;
        PaginationState pagination = new PaginationState { ItemsPerPage = 10 };
        IEnumerable<RecBillModel> SelectedItems;

        private DateTime recbilllistRecDateStart = DateTime.Now;
        private DateTime recbilllistRecDateEnd = DateTime.Now;
        private string recbilllistTicketNumber;
        private string recbilllistSubTicketNumber;
        private string recbilllistIssuingUnit;
        private string recbilllistAcceptorName;

        protected override async Task OnInitializedAsync()
       {
              Busy = true;

              Context = DbFactory.CreateDbContext();
              recbills  = Context.RecBillModels
                                                .Where(r => (recbilllistRecDateStart != DateTime.MinValue&& recbilllistRecDateEnd != DateTime.MinValue  && r.RecDate.Date >= recbilllistRecDateStart.Date  && r.RecDate.Date<= recbilllistRecDateEnd.Date) &&
                                                             (!string.IsNullOrEmpty(recbilllistTicketNumber) ? r.TicketNumber==recbilllistTicketNumber : true ) &&
                                                             (!string.IsNullOrEmpty(recbilllistSubTicketNumber) ? r.SubTicketNumber==recbilllistSubTicketNumber : true) &&
                                                             (!string.IsNullOrEmpty(recbilllistIssuingUnit) ? r.IssuingUnit==recbilllistIssuingUnit : true) &&
                                                             (!string.IsNullOrEmpty(recbilllistAcceptorName) ? r.AcceptorName==recbilllistAcceptorName : true) && r.IsMotherTicket=="子票" ).ToList();

              var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
              var user = authState.User;

              var isAuthorized = user.IsInRole(Recbills.RecbillManagersRole) ||
                                 user.IsInRole(Recbills.RecbillAdministratorsRole);

              var currentUserId = UserManager.GetUserId(user);

              if (!isAuthorized)
              {
                  recbills = recbills.Where(r => r.Status == RecbillStatus.Approved
                                            || r.OwnerID == currentUserId).ToList();
              }

             SelectedItems = recbills.AsQueryable().Where(p => p.Selected).ToList().AsQueryable();

            Busy = false;

       await base.OnInitializedAsync();
           // ... 其他初始化代码
       }

        private async Task FindRecbillList() {
              if (Busy) {
                  return;
              }

              Busy = true;
              try {
                  recbills = Context.RecBillModels
                                                 .Where(r => (recbilllistRecDateStart != DateTime.MinValue&& recbilllistRecDateEnd != DateTime.MinValue  && r.RecDate.Date >= recbilllistRecDateStart.Date  && r.RecDate.Date<= recbilllistRecDateEnd.Date) &&
                                                             (!string.IsNullOrEmpty(recbilllistTicketNumber) ? r.TicketNumber==recbilllistTicketNumber : true ) &&
                                                             (!string.IsNullOrEmpty(recbilllistSubTicketNumber) ? r.SubTicketNumber==recbilllistSubTicketNumber : true) &&
                                                             (!string.IsNullOrEmpty(recbilllistIssuingUnit) ? r.IssuingUnit==recbilllistIssuingUnit : true) &&
                                                             (!string.IsNullOrEmpty(recbilllistAcceptorName) ? r.AcceptorName==recbilllistAcceptorName : true) && r.IsMotherTicket=="子票" ).ToList();

              var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
              var user = authState.User;

              var isAuthorized = user.IsInRole(Recbills.RecbillManagersRole) ||
                                 user.IsInRole(Recbills.RecbillAdministratorsRole);
              var currentUserId = UserManager.GetUserId(user);

              if (!isAuthorized)
              {
                  recbills = recbills.Where(r => r.Status == RecbillStatus.Approved
                                            || r.OwnerID == currentUserId).ToList();
              }
            } catch (System.InvalidOperationException e ) {
                var dialog = await DialogService.ShowErrorAsync("查询票据列表异常。" );
                var result = await dialog.Result;
                //canceled = result.Cancelled;
                Busy = false;
             }

            Busy = false;
        }

       private Stream GetFileStream()
       {
        var randomBinaryData = new byte[50 * 1024];
        var fileStream = new MemoryStream(randomBinaryData);

        return fileStream;
       }

       private async Task ExportExcelAsync() {
         using var workbook = new XLWorkbook();
         var worksheet = workbook.AddWorksheet("应收票据子票列表");
         worksheet.ColumnWidth = 12;
         //worksheet.Cell("A1").Value = "Hello World!";
         //worksheet.Cell("A2").FormulaA1 = "MID(A1, 7, 5)";
         worksheet.Cell("A1").InsertTable(recbills);
         worksheet.Cell("A1").Value = "序号";
         worksheet.Cell("B1").Value = "收票日期";
         worksheet.Cell("C1").Value = "收票凭证号";
         worksheet.Cell("D1").Value = "项目名称（即前手单位）";
         worksheet.Cell("E1").Value = "应收票据类别";
         worksheet.Cell("F1").Value = "与前手的关系";
         worksheet.Cell("G1").Value = "新一代";
         worksheet.Cell("H1").Value = "票号";
         worksheet.Cell("I1").Value = "子票号";
         worksheet.Cell("J1").Value = "出票单位";
         worksheet.Cell("K1").Value = "承兑人名称";
         worksheet.Cell("L1").Value = "是否6+9";
         worksheet.Cell("M1").Value = "承兑金额";
         worksheet.Cell("N1").Value = "出票日";
         worksheet.Cell("O1").Value = "到期日";
         worksheet.Cell("P1").Value = "是否选中";
         worksheet.Cell("Q1").Value = "用户ID";
         worksheet.Cell("R1").Value = "状态";
         worksheet.Cell("S1").Value = "所属单位";
         worksheet.Cell("T1").Value = "背书人";
         worksheet.Cell("U1").Value = "余额";
         worksheet.Cell("V1").Value = "转出金额";
         worksheet.Cell("W1").Value = "新建时间";
         worksheet.Cell("X1").Value = "修改时间";
         worksheet.Cell("Y1").Value = "母票/子票";
         worksheet.Columns().AdjustToContents();
         //workbook.SaveAs("/opt/aspnetcore/jtpjsapp/files/export/应收票据母票列表.xlsx");

         var fileStream = GetFileStream();
         workbook.SaveAs(fileStream);
         fileStream.Seek(0, SeekOrigin.Begin);
         var fileName = "应收票据子票列表.xlsx";

         using var streamRef = new DotNetStreamReference(stream: fileStream);

         await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
     }


    public void Dispose()
    {
         Context?.Dispose();
    }

}
```
```shell
[root@cpzljc Data]# cd Migrations/
[root@cpzljc Migrations]# ls
```
00000000000000_CreateIdentitySchema.cs           ApplicationDbContextModelSnapshot.cs
00000000000000_CreateIdentitySchema.Designer.cs
[root@cpzljc Migrations]# cat 00000000000000_CreateIdentitySchema.cs
```csharp
using System;
using Microsoft.EntityFrameworkCore.Metadata;
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace jtpjsapp.Migrations
{
    /// <inheritdoc />
    public partial class CreateIdentitySchema : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.CreateTable(
                name: "AspNetRoles",
                columns: table => new
                {
                    Id = table.Column<string>(type: "varchar(150)", maxLength: 150, nullable: false),    
                    Name = table.Column<string>(type: "TEXT", maxLength: 256, nullable: true),
                    NormalizedName = table.Column<string>(type: "varchar(150)", maxLength: 150, nullable: true),
                    ConcurrencyStamp = table.Column<string>(type: "TEXT", nullable: true)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_AspNetRoles", x => x.Id);
                });

            migrationBuilder.CreateTable(
                name: "AspNetUsers",
                columns: table => new
                {
                    Id = table.Column<string>(type: "varchar(150)", maxLength:150, nullable: false),     
                    UserName = table.Column<string>(type: "TEXT", maxLength: 256, nullable: true),       
                    NormalizedUserName = table.Column<string>(type: "varchar(150)", maxLength: 150, nullable: true),
                    Email = table.Column<string>(type: "TEXT", maxLength: 256, nullable: true),
                    NormalizedEmail = table.Column<string>(type: "varchar(150)", maxLength: 150, nullable: true),
                    EmailConfirmed = table.Column<bool>(type: "INTEGER", nullable: false),
                    PasswordHash = table.Column<string>(type: "TEXT", nullable: true),
                    SecurityStamp = table.Column<string>(type: "TEXT", nullable: true),
                    ConcurrencyStamp = table.Column<string>(type: "TEXT", nullable: true),
                    PhoneNumber = table.Column<string>(type: "TEXT", nullable: true),
                    PhoneNumberConfirmed = table.Column<bool>(type: "INTEGER", nullable: false),
                    TwoFactorEnabled = table.Column<bool>(type: "INTEGER", nullable: false),
                    LockoutEnd = table.Column<DateTimeOffset>(type: "TEXT", nullable: true),
                    LockoutEnabled = table.Column<bool>(type: "INTEGER", nullable: false),
                    AccessFailedCount = table.Column<int>(type: "INTEGER", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_AspNetUsers", x => x.Id);
                });

            migrationBuilder.CreateTable(
                name: "AspNetRoleClaims",
                columns: table => new
                {
                    Id = table.Column<int>(type: "INTEGER", nullable: false)
                        //.Annotation("Sqlite:Autoincrement", true)
                       .Annotation("MySql:ValueGenerationStrategy", MySqlValueGenerationStrategy.IdentityColumn),
                    RoleId = table.Column<string>(type: "varchar(150)", nullable: false),
                    ClaimType = table.Column<string>(type: "TEXT", nullable: true),
                    ClaimValue = table.Column<string>(type: "TEXT", nullable: true)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_AspNetRoleClaims", x => x.Id);
                    table.ForeignKey(
                        name: "FK_AspNetRoleClaims_AspNetRoles_RoleId",
                        column: x => x.RoleId,
                        principalTable: "AspNetRoles",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "AspNetUserClaims",
                columns: table => new
                {
                    Id = table.Column<int>(type: "INTEGER", nullable: false)
                        //.Annotation("Sqlite:Autoincrement", true),
                        .Annotation("MySql:ValueGenerationStrategy", MySqlValueGenerationStrategy.IdentityColumn),
                    UserId = table.Column<string>(type: "varchar(150)", nullable: false),
                    ClaimType = table.Column<string>(type: "TEXT", nullable: true),
                    ClaimValue = table.Column<string>(type: "TEXT", nullable: true)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_AspNetUserClaims", x => x.Id);
                    table.ForeignKey(
                        name: "FK_AspNetUserClaims_AspNetUsers_UserId",
                        column: x => x.UserId,
                        principalTable: "AspNetUsers",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "AspNetUserLogins",
                columns: table => new
                {
                    LoginProvider = table.Column<string>(type: "varchar(150)", nullable: false),
                    ProviderKey = table.Column<string>(type: "varchar(150)", nullable: false),
                    ProviderDisplayName = table.Column<string>(type: "TEXT", nullable: true),
                    UserId = table.Column<string>(type: "varchar(32)", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_AspNetUserLogins", x => new { x.LoginProvider, x.ProviderKey });
                    table.ForeignKey(
                        name: "FK_AspNetUserLogins_AspNetUsers_UserId",
                        column: x => x.UserId,
                        principalTable: "AspNetUsers",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "AspNetUserRoles",
                columns: table => new
                {
                    UserId = table.Column<string>(type: "varchar(150)", nullable: false),
                    RoleId = table.Column<string>(type: "varchar(150)", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_AspNetUserRoles", x => new { x.UserId, x.RoleId });
                    table.ForeignKey(
                        name: "FK_AspNetUserRoles_AspNetRoles_RoleId",
                        column: x => x.RoleId,
                        principalTable: "AspNetRoles",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                    table.ForeignKey(
                        name: "FK_AspNetUserRoles_AspNetUsers_UserId",
                        column: x => x.UserId,
                        principalTable: "AspNetUsers",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "AspNetUserTokens",
                columns: table => new
                {
                    UserId = table.Column<string>(type: "varchar(150)", nullable: false),
                    LoginProvider = table.Column<string>(type: "varchar(150)", nullable: false),
                    Name = table.Column<string>(type: "varchar(150)", nullable: false),
                    Value = table.Column<string>(type: "TEXT", nullable: true)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_AspNetUserTokens", x => new { x.UserId, x.LoginProvider, x.Name });
                    table.ForeignKey(
                        name: "FK_AspNetUserTokens_AspNetUsers_UserId",
                        column: x => x.UserId,
                        principalTable: "AspNetUsers",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateIndex(
                name: "IX_AspNetRoleClaims_RoleId",
                table: "AspNetRoleClaims",
                column: "RoleId");

            migrationBuilder.CreateIndex(
                name: "RoleNameIndex",
                table: "AspNetRoles",
                column: "NormalizedName",
                unique: true);

            migrationBuilder.CreateIndex(
                name: "IX_AspNetUserClaims_UserId",
                table: "AspNetUserClaims",
                column: "UserId");

            migrationBuilder.CreateIndex(
                name: "IX_AspNetUserLogins_UserId",
                table: "AspNetUserLogins",
                column: "UserId");

            migrationBuilder.CreateIndex(
                name: "IX_AspNetUserRoles_RoleId",
                table: "AspNetUserRoles",
                column: "RoleId");

            migrationBuilder.CreateIndex(
                name: "EmailIndex",
                table: "AspNetUsers",
                column: "NormalizedEmail");

            migrationBuilder.CreateIndex(
                name: "UserNameIndex",
                table: "AspNetUsers",
                column: "NormalizedUserName",
                unique: true);
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropTable(
                name: "AspNetRoleClaims");

            migrationBuilder.DropTable(
                name: "AspNetUserClaims");

            migrationBuilder.DropTable(
                name: "AspNetUserLogins");

            migrationBuilder.DropTable(
                name: "AspNetUserRoles");

            migrationBuilder.DropTable(
                name: "AspNetUserTokens");

            migrationBuilder.DropTable(
                name: "AspNetRoles");

            migrationBuilder.DropTable(
                name: "AspNetUsers");
        }
    }
}
```

[root@cpzljc Migrations]# cat 00000000000000_CreateIdentitySchema.Designer.cs 
```csharp
// <auto-generated />
using System;
using jtpjsapp.Data;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Metadata;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;

#nullable disable

namespace jtpjsapp.Migrations
{
    [DbContext(typeof(ApplicationDbContext))]
    [Migration("00000000000000_CreateIdentitySchema")]
    partial class CreateIdentitySchema
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder.HasAnnotation("ProductVersion", "8.0.0");

            modelBuilder.Entity("jtpjsapp.Data.ApplicationUser", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("varchar(150)")
                        .HasMaxLength(150);

                    b.Property<int>("AccessFailedCount")
                        .HasColumnType("INTEGER");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("TEXT");

                    b.Property<string>("Email")
                        .HasMaxLength(256)
                        .HasColumnType("TEXT");

                    b.Property<bool>("EmailConfirmed")
                        .HasColumnType("INTEGER");

                    b.Property<bool>("LockoutEnabled")
                        .HasColumnType("INTEGER");

                    b.Property<DateTimeOffset?>("LockoutEnd")
                        .HasColumnType("TEXT");

                    b.Property<string>("NormalizedEmail")
                        .HasMaxLength(150)
                        .HasColumnType("varchar(150)");

                    b.Property<string>("NormalizedUserName")
                        .HasMaxLength(150)
                        .HasColumnType("varchar(150)");

                    b.Property<string>("PasswordHash")
                        .HasColumnType("TEXT");

                    b.Property<string>("PhoneNumber")
                        .HasColumnType("TEXT");

                    b.Property<bool>("PhoneNumberConfirmed")
                        .HasColumnType("INTEGER");

                    b.Property<string>("SecurityStamp")
                        .HasColumnType("TEXT");

                    b.Property<bool>("TwoFactorEnabled")
                        .HasColumnType("INTEGER");

                    b.Property<string>("UserName")
                        .HasMaxLength(256)
                        .HasColumnType("TEXT");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedEmail")
                        .HasDatabaseName("EmailIndex");

                    b.HasIndex("NormalizedUserName")
                        .IsUnique()
                        .HasDatabaseName("UserNameIndex");

                    b.ToTable("AspNetUsers", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRole", b =>
                {
                    b.Property<string>("Id")
                        //.HasColumnType("TEXT")
                        .HasColumnType("varchar(150)")
                        .HasMaxLength(150);

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("TEXT");

                    b.Property<string>("Name")
                        .HasMaxLength(256)
                        .HasColumnType("TEXT");

                    b.Property<string>("NormalizedName")
                        .HasMaxLength(150)
                        .HasColumnType("varchar(150)");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedName")
                        .IsUnique()
                        .HasDatabaseName("RoleNameIndex");

                    b.ToTable("AspNetRoles", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("INTEGER");

                    b.Property<string>("ClaimType")
                        .HasColumnType("TEXT");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("TEXT");

                    b.Property<string>("RoleId")
                        .IsRequired()
                        .HasColumnType("varchar(150)");

                    b.HasKey("Id");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetRoleClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("INTEGER");

                    b.Property<string>("ClaimType")
                        .HasColumnType("TEXT");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("TEXT");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("varchar(150)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.Property<string>("LoginProvider")
                        .HasColumnType("varchar(150)");

                    b.Property<string>("ProviderKey")
                        .HasColumnType("varchar(150)");

                    b.Property<string>("ProviderDisplayName")
                        .HasColumnType("TEXT");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("varchar(150)");

                    b.HasKey("LoginProvider", "ProviderKey");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserLogins", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("varchar(150)");

                    b.Property<string>("RoleId")
                        .HasColumnType("varchar(150)");

                    b.HasKey("UserId", "RoleId");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetUserRoles", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("varchar(150)");

                    b.Property<string>("LoginProvider")
                        .HasColumnType("varchar(150)");

                    b.Property<string>("Name")
                        .HasColumnType("varchar(150)");

                    b.Property<string>("Value")
                        .HasColumnType("TEXT");

                    b.HasKey("UserId", "LoginProvider", "Name");

                    b.ToTable("AspNetUserTokens", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.HasOne("Microsoft.AspNetCore.Identity.IdentityRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.HasOne("jtpjsapp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.HasOne("jtpjsapp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.HasOne("Microsoft.AspNetCore.Identity.IdentityRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("jtpjsapp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.HasOne("jtpjsapp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });
#pragma warning restore 612, 618
        }
    }
}
```

[root@cpzljc Migrations]# cat ApplicationDbContextModelSnapshot.cs 
```csharp
// <auto-generated />
using System;
using jtpjsapp.Data;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;

#nullable disable

namespace jtpjsapp.Migrations
{
    [DbContext(typeof(ApplicationDbContext))]
    partial class ApplicationDbContextModelSnapshot : ModelSnapshot
    {
        protected override void BuildModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder.HasAnnotation("ProductVersion", "8.0.0");

            modelBuilder.Entity("jtpjsapp.Data.ApplicationUser", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("TEXT");

                    b.Property<int>("AccessFailedCount")
                        .HasColumnType("INTEGER");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("TEXT");

                    b.Property<string>("Email")
                        .HasMaxLength(256)
                        .HasColumnType("TEXT");

                    b.Property<bool>("EmailConfirmed")
                        .HasColumnType("INTEGER");

                    b.Property<bool>("LockoutEnabled")
                        .HasColumnType("INTEGER");

                    b.Property<DateTimeOffset?>("LockoutEnd")
                        .HasColumnType("TEXT");

                    b.Property<string>("NormalizedEmail")
                        .HasMaxLength(256)
                        .HasColumnType("TEXT");

                    b.Property<string>("NormalizedUserName")
                        .HasMaxLength(256)
                        .HasColumnType("TEXT");

                    b.Property<string>("PasswordHash")
                        .HasColumnType("TEXT");

                    b.Property<string>("PhoneNumber")
                        .HasColumnType("TEXT");

                    b.Property<bool>("PhoneNumberConfirmed")
                        .HasColumnType("INTEGER");

                    b.Property<string>("SecurityStamp")
                        .HasColumnType("TEXT");

                    b.Property<bool>("TwoFactorEnabled")
                        .HasColumnType("INTEGER");

                    b.Property<string>("UserName")
                        .HasMaxLength(256)
                        .HasColumnType("TEXT");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedEmail")
                        .HasDatabaseName("EmailIndex");

                    b.HasIndex("NormalizedUserName")
                        .IsUnique()
                        .HasDatabaseName("UserNameIndex");

                    b.ToTable("AspNetUsers", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRole", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("TEXT");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("TEXT");

                    b.Property<string>("Name")
                        .HasMaxLength(256)
                        .HasColumnType("TEXT");

                    b.Property<string>("NormalizedName")
                        .HasMaxLength(256)
                        .HasColumnType("TEXT");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedName")
                        .IsUnique()
                        .HasDatabaseName("RoleNameIndex");

                    b.ToTable("AspNetRoles", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("INTEGER");

                    b.Property<string>("ClaimType")
                        .HasColumnType("TEXT");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("TEXT");

                    b.Property<string>("RoleId")
                        .IsRequired()
                        .HasColumnType("TEXT");

                    b.HasKey("Id");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetRoleClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("INTEGER");

                    b.Property<string>("ClaimType")
                        .HasColumnType("TEXT");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("TEXT");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("TEXT");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.Property<string>("LoginProvider")
                        .HasColumnType("TEXT");

                    b.Property<string>("ProviderKey")
                        .HasColumnType("TEXT");

                    b.Property<string>("ProviderDisplayName")
                        .HasColumnType("TEXT");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("TEXT");

                    b.HasKey("LoginProvider", "ProviderKey");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserLogins", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("TEXT");

                    b.Property<string>("RoleId")
                        .HasColumnType("TEXT");

                    b.HasKey("UserId", "RoleId");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetUserRoles", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("TEXT");

                    b.Property<string>("LoginProvider")
                        .HasColumnType("TEXT");

                    b.Property<string>("Name")
                        .HasColumnType("TEXT");

                    b.Property<string>("Value")
                        .HasColumnType("TEXT");

                    b.HasKey("UserId", "LoginProvider", "Name");

                    b.ToTable("AspNetUserTokens", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.HasOne("Microsoft.AspNetCore.Identity.IdentityRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.HasOne("jtpjsapp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.HasOne("jtpjsapp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.HasOne("Microsoft.AspNetCore.Identity.IdentityRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("jtpjsapp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.HasOne("jtpjsapp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });
#pragma warning restore 612, 618
        }
    }
}
```
```cli
[root@cpzljc jtpjsapp]# dotnet user-secrets set SeedUserPW jtT0795,.,
```
Successfully saved SeedUserPW = jtT0795,., to the secret store.

[root@cpzljc Data]# vim SeedData.cs
[root@cpzljc Data]# cat SeedData.cs 
```csharp
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using jtpjsapp.Authorization;

namespace jtpjsapp.Data;

public class SeedData {

public static async Task Initialize(IServiceProvider serviceProvider, string testUserPw)
{
    using (var context = new ApplicationDbContext(
        serviceProvider.GetRequiredService<DbContextOptions<ApplicationDbContext>>()))
    {
        // For sample purposes seed both with the same password.
        // Password is set with the following:
        // dotnet user-secrets set SeedUserPW <pw>
        // The admin user can do anything

        var adminID = await EnsureUser(serviceProvider, testUserPw, "admin@263.com");
        await EnsureRole(serviceProvider, adminID, Recbills.RecbillAdministratorsRole);

        // allowed user can create and edit contacts that they create
        var managerID = await EnsureUser(serviceProvider, testUserPw, "manager@263.com");
        await EnsureRole(serviceProvider, managerID, Recbills.RecbillManagersRole);

        SeedDB(context, adminID);
    }
}

private static async Task<string> EnsureUser(IServiceProvider serviceProvider,
                                            string testUserPw, string UserName)
{
   // var userManager = serviceProvider.GetService<UserManager<IdentityUser>>();
    var userManager = serviceProvider.GetService<UserManager<ApplicationUser>>();

    var user = await userManager.FindByNameAsync(UserName);
    if (user == null)
    {
        user = new ApplicationUser
        {
            UserName = UserName,
            EmailConfirmed = true
        };
        await userManager.CreateAsync(user, testUserPw);
    }

    if (user == null)
    {
        throw new Exception("密码强度太弱!");
    }

    return user.Id;
}

private static async Task<IdentityResult> EnsureRole(IServiceProvider serviceProvider,
                                                              string uid, string role)
{
    var roleManager = serviceProvider.GetService<RoleManager<IdentityRole>>();

    if (roleManager == null)
    {
        throw new Exception("roleManager null");
    }

    IdentityResult IR;
    if (!await roleManager.RoleExistsAsync(role))
    {
        IR = await roleManager.CreateAsync(new IdentityRole(role));
    }

    var userManager = serviceProvider.GetService<UserManager<ApplicationUser>>();

    //if (userManager == null)
    //{
    //    throw new Exception("userManager is null");
    //}

    var user = await userManager.FindByIdAsync(uid);

    if (user == null)
    {
        throw new Exception("The testUserPw password was probably not strong enough!");
    }

    IR = await userManager.AddToRoleAsync(user, role);

    return IR;
}

public static void SeedDB(ApplicationDbContext context, string adminID)
{
    if (context.RecBillModels.Any())
    {
        return;   // DB has been seeded
    }

    context.RecBillModels.AddRange(
        new RecBillModel
        {
            RecDate = DateTime.Now,
            RecVoucher = "2024-06-08#",
            EntryName = "江西江特电机有限公司",
            RecBillCategory = "电子银行承兑汇票",
            FrontRela = "合并范围内关联方",
            NewGeneration = "是",
            TicketNumber = "531665300002620240607001228939",
            SubTicketNumber = "000002576478000023235060",
                        IssuingUnit = "中冶赛迪工程技术股份有限公司",
                        AcceptorName = "浙商银行股份有限公司重庆分行",
                        Is69 = "是",
                        AcceptAmount = Convert.ToDecimal(206585.83),
                        TicketIssueDate = DateTime.Now,
                        DueDate = DateTime.Now,
                        Selected = false,
                        OwnerID = adminID,
                        Status = RecbillStatus.Approved,
                        Company = "江西江特电机有限公司",
                        Endorser = "",
                        Balance = Convert.ToDecimal(206585.83),
                        TransferAmount = 0,
                        AddTime = DateTime.Now,
                        ModifyTime = null,
                        IsMotherTicket = "是"
        }
        );

}

}
```

[root@cpzljc jtpjsapp]# mkdir Authorization
[root@cpzljc jtpjsapp]# ls
 appsettings.Development.json   Authorization   Components  'Data\app.db'      obj          Properties
 appsettings.json               bin             Data         jtpjsapp.csproj   Program.cs   wwwroot

 
[root@cpzljc Authorization]# vim RecbillIsOwnerAuthorizationHandler.cs
[root@cpzljc Authorization]# cat RecbillIsOwnerAuthorizationHandler.cs 
```csharp
using jtpjsapp.Data;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Authorization.Infrastructure;
using Microsoft.AspNetCore.Identity;
using System.Threading.Tasks;

namespace jtpjsapp.Authorization
{
    public class RecbillIsOwnerAuthorizationHandler
                : AuthorizationHandler<OperationAuthorizationRequirement, RecBillModel>
    {
       // UserManager<IdentityUser> _userManager;
       UserManager<ApplicationUser> _userManager;

        public RecbillIsOwnerAuthorizationHandler(UserManager<ApplicationUser>
            userManager)
        {
            _userManager = userManager;
        }

        protected override Task
            HandleRequirementAsync(AuthorizationHandlerContext context,
                                   OperationAuthorizationRequirement requirement,
                                   RecBillModel resource)
        {
            if (context.User == null || resource == null)
            {
                return Task.CompletedTask;
            }

            // If not asking for CRUD permission, return.

            if (requirement.Name != Recbills.CreateOperationName &&
                requirement.Name != Recbills.ReadOperationName   &&
                requirement.Name != Recbills.UpdateOperationName &&
                requirement.Name != Recbills.DeleteOperationName &&
                requirement.Name != Recbills.SplitOperationName
                )
            {
                return Task.CompletedTask;
            }

            if (resource.OwnerID == _userManager.GetUserId(context.User) || (resource.Status==RecbillStatus.Approved && requirement.Name==Recbills.ReadOperationName ) )
            {
                context.Succeed(requirement);
            }

            return Task.CompletedTask;
        }
    }
}
```

[root@cpzljc Authorization]# vim RecbillManagerAuthorizationHandler.cs
[root@cpzljc Authorization]# cat RecbillManagerAuthorizationHandler.cs 
```csharp
using System.Threading.Tasks;
using jtpjsapp.Data;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Authorization.Infrastructure;
using Microsoft.AspNetCore.Identity;

namespace jtpjsapp.Authorization
{
    public class RecbillManagerAuthorizationHandler :
        AuthorizationHandler<OperationAuthorizationRequirement, RecBillModel>
    {
        protected override Task
            HandleRequirementAsync(AuthorizationHandlerContext context,
                                   OperationAuthorizationRequirement requirement,
                                   RecBillModel resource)
        {
            if (context.User == null || resource == null)
            {
                return Task.CompletedTask;
            }

            // If not asking for approval/reject, return.
            if (requirement.Name != Recbills.ApproveOperationName &&
                requirement.Name != Recbills.RejectOperationName)
            {
                return Task.CompletedTask;
            }

            // Managers can approve or reject.
            if (context.User.IsInRole(Recbills.RecbillManagersRole))
            {
                context.Succeed(requirement);
            }

            return Task.CompletedTask;
        }
    }
}
```

[root@cpzljc Authorization]# vim RecbillAdministratorsAuthorizationHandler.cs
[root@cpzljc Authorization]# cat RecbillAdministratorsAuthorizationHandler.cs 
```csharp
using System.Threading.Tasks;
using jtpjsapp.Data;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Authorization.Infrastructure;

namespace jtpjsapp.Authorization
{
    public class RecbillAdministratorsAuthorizationHandler
                    : AuthorizationHandler<OperationAuthorizationRequirement, RecBillModel>
    {
        protected override Task HandleRequirementAsync(
                                              AuthorizationHandlerContext context,
                                    OperationAuthorizationRequirement requirement,
                                     RecBillModel resource)
        {
            if (context.User == null)
            {
                return Task.CompletedTask;
            }

            // Administrators can do anything.
            if (context.User.IsInRole(Recbills.RecbillAdministratorsRole))
            {
                context.Succeed(requirement);
            }

            return Task.CompletedTask;
        }
    }
}
```

[root@cpzljc Authorization]# vim RecbillOperations.cs
[root@cpzljc Authorization]# cat RecbillOperations.cs 
```csharp
using Microsoft.AspNetCore.Authorization.Infrastructure;

namespace jtpjsapp.Authorization
{
    public static class RecbillOperations
    {
        public static OperationAuthorizationRequirement Create =
          new OperationAuthorizationRequirement {Name=Recbills.CreateOperationName};
        public static OperationAuthorizationRequirement Read =
          new OperationAuthorizationRequirement {Name=Recbills.ReadOperationName};
        public static OperationAuthorizationRequirement Update =
          new OperationAuthorizationRequirement {Name=Recbills.UpdateOperationName};
        public static OperationAuthorizationRequirement Delete =
          new OperationAuthorizationRequirement {Name=Recbills.DeleteOperationName};
        public static OperationAuthorizationRequirement Approve =
          new OperationAuthorizationRequirement {Name=Recbills.ApproveOperationName};
        public static OperationAuthorizationRequirement Reject =
          new OperationAuthorizationRequirement {Name=Recbills.RejectOperationName};
        public static OperationAuthorizationRequirement Split =
          new OperationAuthorizationRequirement {Name=Recbills.SplitOperationName};
    }

    public class Recbills
    {
        public static readonly string CreateOperationName = "Create";
        public static readonly string ReadOperationName = "Read";
        public static readonly string UpdateOperationName = "Update";
        public static readonly string DeleteOperationName = "Delete";
        public static readonly string ApproveOperationName = "Approve";
        public static readonly string RejectOperationName = "Reject";
        public static readonly string SplitOperationName = "Split";

        public static readonly string RecbillAdministratorsRole =
                                                              "RecbillAdministrators";
        public static readonly string RecbillManagersRole = "RecbillManagers";
    }
}
```

[root@cpzljc Pages]# cat Login.razor 
```html
@page "/Account/Login"
@attribute [AllowAnonymous]

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Identity
@using jtpjsapp.Data

@inject SignInManager<ApplicationUser> SignInManager
@inject ILogger<Login> Logger
@inject NavigationManager NavigationManager
@inject IdentityRedirectManager RedirectManager

<head>
<style>
.centered-flex {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh; /* 使div的高度等于视口高度 */
}

.content {
  /* 内容样式 */
  text-align: center;
  width: 500px;
  margin: auto;
}

.background-image {
    background-image: url('票据系统背景图.jpg'); /* 修改为你的图片路径 */
    background-size: cover; /* 背景图片覆盖整个元素 */
    background-position: center; /* 背景图片居中 */
    height: 100vh; /* 根据需要设置高度 */
    width: 100%; /* 根据需要设置宽度 */
}
</style>
</head>

<PageTitle>登录</PageTitle>

<div class="centered-flex">
<div class="content">
<h1>登录</h1>
@*<FluentGrid>*@
    @* <FluentGridItem  xs="8" sm="4"> *@
        <StatusMessage Message="@errorMessage" />
        <EditForm Model="Input" method="post" OnValidSubmit="LoginUser" FormName="login">
            <DataAnnotationsValidator />
            <h2>使用注册后的邮箱登录。</h2>
            <hr />
            <FluentValidationSummary class="text-danger" role="alert" />
            <FluentStack Orientation="Orientation.Vertical">
                <FluentTextField Name="Input.Email" @bind-Value="Input.Email" AutoComplete="username" Required="true" Placeholder="name@example.com" Label="邮箱" Style="width: 100%" AllowAnonymous="true"/>
                <FluentValidationMessage For="() => Input.Email" class="text-danger" />
                <FluentTextField type="password" Name="Input.Password" @bind-Value="Input.Password" AutoComplete="current-password" Required="true" Placeholder="password" Label="密码" Style="width: 100%" />
                <FluentValidationMessage For="() => Input.Password" class="text-danger" />
                <FluentCheckbox Name="Input.RememberMe" @bind-Value="Input.RememberMe" Label="记住我" />
                <FluentButton Type="ButtonType.Submit" Appearance="Appearance.Accent" Style="width: 100%">登录</FluentButton>
                    <p>
                        <FluentAnchor Appearance="Appearance.Hypertext" Href="Account/ForgotPassword">忘记了你的 密码?</FluentAnchor>
                    </p>
                    <p>
                        <FluentAnchor Appearance="Appearance.Hypertext" Href="@(NavigationManager.GetUriWithQueryParameters("Account/Register", new Dictionary<string, object?> { ["ReturnUrl"] = ReturnUrl }))">注册新用户</FluentAnchor>
                    </p>
                    <p>
                        <FluentAnchor Appearance="Appearance.Hypertext" Href="Account/ResendEmailConfirmation">再次发送邮箱确认</FluentAnchor>
                    </p>
            </FluentStack>
        </EditForm>
@* </FluentGridItem> *@
    @*
    <FluentGridItem xs="12" sm="8">
        <h3>Use another service to log in.</h3>
        <hr />
        <ExternalLoginPicker />
    </FluentGridItem>
    *@
@* </FluentGrid>  *@
</div>
</div>

@code {
    private string? errorMessage;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (HttpMethods.IsGet(HttpContext.Request.Method))
        {
            // Clear the existing external cookie to ensure a clean login process
            await HttpContext.SignOutAsync(IdentityConstants.ExternalScheme);
        }
    }

    public async Task LoginUser()
    {
        // This doesn't count login failures towards account lockout
        // To enable password failures to trigger account lockout, set lockoutOnFailure: true
        var result = await SignInManager.PasswordSignInAsync(Input.Email, Input.Password, Input.RememberMe, lockoutOnFailure: false);
        if (result.Succeeded)
        {
            Logger.LogInformation("User logged in.");
            //RedirectManager.RedirectTo(ReturnUrl);
            RedirectManager.RedirectTo("home");
        }
        else if (result.RequiresTwoFactor)
        {
            RedirectManager.RedirectTo(
                "Account/LoginWith2fa",
                new() { ["returnUrl"] = ReturnUrl, ["rememberMe"] = Input.RememberMe });
        }
        else if (result.IsLockedOut)
        {
            Logger.LogWarning("User account locked out.");
            RedirectManager.RedirectTo("Account/Lockout");
        }
        else
        {
            errorMessage = "错误：无效的登录尝试。";
        }
    }

    public async Task RegisteAsync()
    {
            Logger.LogInformation("User registe.");
            //RedirectManager.RedirectTo(ReturnUrl);
            RedirectManager.RedirectTo("Account/Register");
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = "";

        [Required]
        [DataType(DataType.Password)]
        public string Password { get; set; } = "";

        [Display(Name = "Remember me?")]
        public bool RememberMe { get; set; }
    }
}
```

[root@cpzljc Pages]# cat Register.razor 
```html
@page "/Account/Register"
@attribute [AllowAnonymous]

@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using jtpjsapp.Data

@inject UserManager<ApplicationUser> UserManager
@inject IUserStore<ApplicationUser> UserStore
@inject SignInManager<ApplicationUser> SignInManager
@inject IEmailSender<ApplicationUser> EmailSender
@inject ILogger<Register> Logger
@inject NavigationManager NavigationManager
@inject IdentityRedirectManager RedirectManager


<head>
<style>
.centered-flex {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh; /* 使div的高度等于视口高度 */
}

.content {
  /* 内容样式 */
  text-align: center;
  width: 500px;
  margin: auto;
}

.background-image {
    background-image: url('票据系统背景图.jpg'); /* 修改为你的图片路径 */
    background-size: cover; /* 背景图片覆盖整个元素 */
    background-position: center; /* 背景图片居中 */
    height: 100vh; /* 根据需要设置高度 */
    width: 100%; /* 根据需要设置宽度 */
}
</style>
</head>

<PageTitle>注册</PageTitle>

<div class="centered-flex">
<div class="content">
<h1>注册</h1>
@* <FluentGrid> *@
    @* <FluentGridItem xs="8" sm="4"> *@
        <StatusMessage Message="@Message" />
        <EditForm Model="Input" asp-route-returnUrl="@ReturnUrl" method="post" OnValidSubmit="RegisterUser" FormName="register">
            <DataAnnotationsValidator />
            <h2>创建一个新账号。</h2>
            <hr />
            <FluentValidationSummary class="text-danger" role="alert" />
            <FluentStack Orientation="Orientation.Vertical">
                <FluentTextField Name="Input.Email" @bind-Value="Input.Email" AutoComplete="email" Required="true" Placeholder="name@example.com" Label="邮箱" Style="width: 100%" />
                <FluentValidationMessage For="() => Input.Email" class="text-danger" />
                <FluentTextField type="password" Name="Input.Password" @bind-Value="Input.Password" AutoComplete="new-password" Required="true" Placeholder="password" Label="密码" Style="width: 100%" />
                <FluentValidationMessage For="() => Input.Password" class="text-danger" />
                <FluentTextField type="password" Name="Input.ConfirmPassword" @bind-Value="Input.ConfirmPassword" AutoComplete="new-password" Required="true" Placeholder="password" Label="确认密码" Style="width: 100%" />      
                <FluentValidationMessage For="() => Input.ConfirmPassword" class="text-danger" />
                <FluentButton Type="ButtonType.Submit" Appearance="Appearance.Accent" Style="width: 100%">注册</FluentButton>
            </FluentStack>
        </EditForm>
@*    </FluentGridItem>   *@
    @*
    <FluentGridItem xs="12" sm="8">
        <h3>Use another service to log in.</h3>
        <hr />
        <ExternalLoginPicker />
    </FluentGridItem>
    *@
@* </FluentGrid> *@
</div>
</div>

@code {
    private IEnumerable<IdentityError>? identityErrors;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    private string? Message => identityErrors is null ? null : $"Error: {string.Join(", ", identityErrors.Select(error => error.Description))}";

    public async Task RegisterUser(EditContext editContext)
    {
        var user = CreateUser();

        await UserStore.SetUserNameAsync(user, Input.Email, CancellationToken.None);
        var emailStore = GetEmailStore();
        await emailStore.SetEmailAsync(user, Input.Email, CancellationToken.None);
        var result = await UserManager.CreateAsync(user, Input.Password);

        if (!result.Succeeded)
        {
            identityErrors = result.Errors;
            return;
        }

        Logger.LogInformation("User created a new account with password.");

        var userId = await UserManager.GetUserIdAsync(user);
        var code = await UserManager.GenerateEmailConfirmationTokenAsync(user);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ConfirmEmail").AbsoluteUri,
            new Dictionary<string, object?> { ["userId"] = userId, ["code"] = code, ["returnUrl"] = ReturnUrl });

        await EmailSender.SendConfirmationLinkAsync(user, Input.Email, HtmlEncoder.Default.Encode(callbackUrl)); 

        if (UserManager.Options.SignIn.RequireConfirmedAccount)
        {
            RedirectManager.RedirectTo(
                "Account/RegisterConfirmation",
                new() { ["email"] = Input.Email, ["returnUrl"] = ReturnUrl });
        }

        await SignInManager.SignInAsync(user, isPersistent: false);
        RedirectManager.RedirectTo(ReturnUrl);
    }

    private ApplicationUser CreateUser()
    {
        try
        {
            return Activator.CreateInstance<ApplicationUser>();
        }
        catch
        {
            throw new InvalidOperationException($"Can't create an instance of '{nameof(ApplicationUser)}'. " +   
                $"Ensure that '{nameof(ApplicationUser)}' is not an abstract class and has a parameterless constructor.");
        }
    }

    private IUserEmailStore<ApplicationUser> GetEmailStore()
    {
        if (!UserManager.SupportsUserEmail)
        {
            throw new NotSupportedException("The default UI requires a user store with email support.");
        }
        return (IUserEmailStore<ApplicationUser>)UserStore;
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        [Display(Name = "Email")]
        public string Email { get; set; } = "";

        [Required]
        [StringLength(100, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        [Display(Name = "Password")]
        public string Password { get; set; } = "";

        [DataType(DataType.Password)]
        [Display(Name = "Confirm password")]
        [Compare("Password", ErrorMessage = "The password and confirmation password do not match.")]
        public string ConfirmPassword { get; set; } = "";
    }
}
```

[root@cpzljc Manage]# cat Index.razor 
```html
@page "/Account/Manage"
@attribute [Authorize]

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using jtpjsapp.Data

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor
@inject IdentityRedirectManager RedirectManager

<PageTitle>简介</PageTitle>

<h3>简介</h3>
<StatusMessage />

<FluentGrid>
    <FluentGridItem xs="12" sm="6">
        <EditForm Model="Input" FormName="profile" OnValidSubmit="OnValidSubmitAsync" method="post">
            <DataAnnotationsValidator />
            <FluentValidationSummary class="text-danger" role="alert" />
            <FluentTextField Value="@username" Placeholder="Please choose your username." Disabled Label="用户名" Appearance=FluentInputAppearance.Filled Style="width: 100%" />
            <FluentTextField Name="Input.PhoneNumber" @bind-Value="Input.PhoneNumber" Paceholder="Please enter your phone number." Label="手机号码" Style="width: 100%" />
            <FluentValidationMessage For="() => Input.PhoneNumber" class="text-danger" />
            <FluentButton Type="ButtonType.Submit" Appearance="Appearance.Accent" Style="width: 100%;">保存</FluentButton>
        </EditForm>
    </FluentGridItem>
</FluentGrid>

@code {
    private ApplicationUser user = default!;
    private string? username;
    private string? phoneNumber;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        username = await UserManager.GetUserNameAsync(user);
        phoneNumber = await UserManager.GetPhoneNumberAsync(user);

        Input.PhoneNumber ??= phoneNumber;
    }

    private async Task OnValidSubmitAsync()
    {
        if (Input.PhoneNumber != phoneNumber)
        {
            var setPhoneResult = await UserManager.SetPhoneNumberAsync(user, Input.PhoneNumber);
            if (!setPhoneResult.Succeeded)
            {
                RedirectManager.RedirectToCurrentPageWithStatus("错误: 修改电话号码失败。", HttpContext);        
            }
        }

        await SignInManager.RefreshSignInAsync(user);
        RedirectManager.RedirectToCurrentPageWithStatus("你的资料已经更新了。", HttpContext);
    }

    private sealed class InputModel
    {
        [Phone]
        [Display(Name = "Phone number")]
        public string? PhoneNumber { get; set; }
    }
}
```

[root@cpzljc Manage]# cat PersonalData.razor 
```html
@page "/Account/Manage/PersonalData"

@inject IdentityUserAccessor UserAccessor

<PageTitle>个人数据</PageTitle>

<StatusMessage />
<h3>个人数据</h3>

<FluentGrid>
    <FluentGridItem xs="12" sm="6">
        <p>你的账号包含已给的个人数据，此页允许你下载或删除。</p>
        <p>
            <strong>删除你的账号后，无法恢复。</strong>
        </p>
        <form action="Account/Manage/DownloadPersonalData" method="post">
            <AntiforgeryToken />
            <FluentButton Type="ButtonType.Submit" Appearance="Appearance.Accent" Style="width:20%;">下载</FluentButton>
        </form>

        <hr />

        <p>
            <FluentAnchor Href="Account/Manage/DeletePersonalData" Style="width:20%;">删除</FluentAnchor>        
        </p>
    </FluentGridItem>
</FluentGrid>

@code {
    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        _ = await UserAccessor.GetRequiredUserAsync(HttpContext);
    }
}
```

[root@cpzljc Manage]# cat Email.razor 
```html
@page "/Account/Manage/Email"

@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using jtpjsapp.Data

@inject UserManager<ApplicationUser> UserManager
@inject IEmailSender<ApplicationUser> EmailSender
@inject IdentityUserAccessor UserAccessor
@inject NavigationManager NavigationManager

<PageTitle>管理邮箱</PageTitle>

<h3>管理邮箱</h3>

<StatusMessage Message="@message"/>
<FluentGrid>
    <FluentGridItem xs="12" sm="6">
        <form @onsubmit="OnSendEmailVerificationAsync" @formname="send-verification" id="send-verification-form" method="post">
            <AntiforgeryToken />
        </form>
        <EditForm Model="Input" FormName="change-email" OnValidSubmit="OnValidSubmitAsync" method="post">        
            <DataAnnotationsValidator />
            <FluentValidationSummary class="text-danger" role="alert" />
            @if (isEmailConfirmed)
            {
                <FluentTextField Value="@email" Placeholder="Please enter your email." Disabled Label="邮箱" Appearance=FluentInputAppearance.Filled Style="width: 100%">
                    <span slot="end">?</span>
                </FluentTextField>
            }
            else
            {
                <FluentTextField value="@email" Placeholder="Please enter your email." Disabled Label="邮箱" Appearance=FluentInputAppearance.Filled Style="width: 100%" />
                <FluentButton Type="ButtonType.Submit" Appearance="Appearance.Accent" Form="send-verification-form" Style="width: 100%">发送验证邮箱</FluentButton>
            }
            <FluentTextField Name="Input.NewEmail" @bind-Value="Input.NewEmail" AutoComplete="email" Required="true" Placeholder="Please enter new email." Label="新邮箱" Style="width: 100%" />
            <FluentValidationMessage For="() => Input.NewEmail" class="text-danger" />
            <FluentButton Type="ButtonType.Submit" Appearance="Appearance.Accent" Style="width: 100%;">变更邮箱</FluentButton>
        </EditForm>
    </FluentGridItem>
</FluentGrid>

@code {
    private string? message;
    private ApplicationUser user = default!;
    private string? email;
    private bool isEmailConfirmed;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm(FormName = "change-email")]
    private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        email = await UserManager.GetEmailAsync(user);
        isEmailConfirmed = await UserManager.IsEmailConfirmedAsync(user);

        Input.NewEmail ??= email;
    }

    private async Task OnValidSubmitAsync()
    {
        if (Input.NewEmail is null || Input.NewEmail == email)
        {
            message = "Your email is unchanged.";
            return;
        }

        var userId = await UserManager.GetUserIdAsync(user);
        var code = await UserManager.GenerateChangeEmailTokenAsync(user, Input.NewEmail);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ConfirmEmailChange").AbsoluteUri,
            new Dictionary<string, object?> { ["userId"] = userId, ["email"] = Input.NewEmail, ["code"] = code });

        await EmailSender.SendConfirmationLinkAsync(user, Input.NewEmail, HtmlEncoder.Default.Encode(callbackUrl));

        message = "Confirmation link to change email sent. Please check your email.";
    }

    private async Task OnSendEmailVerificationAsync()
    {
        if (email is null)
        {
            return;
        }

        var userId = await UserManager.GetUserIdAsync(user);
        var code = await UserManager.GenerateEmailConfirmationTokenAsync(user);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ConfirmEmail").AbsoluteUri,
            new Dictionary<string, object?> { ["userId"] = userId, ["code"] = code });

        await EmailSender.SendConfirmationLinkAsync(user, email, HtmlEncoder.Default.Encode(callbackUrl));       

        message = "Verification email sent. Please check your email.";
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        [Display(Name = "New email")]
        public string? NewEmail { get; set; }
    }
}
```

[root@cpzljc Manage]# cat ChangePassword.razor 
```html
@page "/Account/Manage/ChangePassword"

@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Identity
@using jtpjsapp.Data

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor
@inject IdentityRedirectManager RedirectManager
@inject ILogger<ChangePassword> Logger

<PageTitle>修改密码</PageTitle>

<h3>修改密码</h3>
<StatusMessage Message="@message" />
<FluentGrid>
    <FluentGridItem xs="12" sm="6">
        <EditForm Model="Input" FormName="change-password" OnValidSubmit="OnValidSubmitAsync" method="post">     
            <DataAnnotationsValidator />
            <FluentValidationSummary class="text-danger" role="alert" />
            <FluentTextField type="password" Name="Input.OldPassword" @bind-Value="Input.OldPassword" class="form-control" AutoComplete="current-password" Required="true" Placeholder="Please enter your old password." Label="旧密码" Style="width: 100%" />
            <FluentValidationMessage For="() => Input.OldPassword" class="text-danger" />
            <FluentTextField type="password" Name="Input.NewPassword" @bind-Value="Input.NewPassword" class="form-control" AutoComplete="new-password" Required="true" Placeholder="Please enter your new password." Label="新密码" Style="width: 100%" />
            <FluentValidationMessage For="() => Input.NewPassword" class="text-danger" />
            <FluentTextField type="password" Name="Input.ConfirmPassword" @bind-Value="Input.ConfirmPassword" class="form-control" AutoComplete="new-password" Required="true" Placeholder="Please confirm your new password." Label="确认密码" Style="width: 100%" />
            <FluentValidationMessage For="() => Input.ConfirmPassword" class="text-danger" />
            <FluentButton Type="ButtonType.Submit" Appearance="Appearance.Accent" Style="width: 100%;">修改密码</FluentButton>
        </EditForm>
    </FluentGridItem>
</FluentGrid>

@code {
    private string? message;
    private ApplicationUser user = default!;
    private bool hasPassword;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        hasPassword = await UserManager.HasPasswordAsync(user);
        if (!hasPassword)
        {
            RedirectManager.RedirectTo("Account/Manage/SetPassword");
        }
    }

    private async Task OnValidSubmitAsync()
    {
        var changePasswordResult = await UserManager.ChangePasswordAsync(user, Input.OldPassword, Input.NewPassword);
        if (!changePasswordResult.Succeeded)
        {
            message = $"Error: {string.Join(",", changePasswordResult.Errors.Select(error => error.Description))}";
            return;
        }

        await SignInManager.RefreshSignInAsync(user);
        Logger.LogInformation("User changed their password successfully.");

        RedirectManager.RedirectToCurrentPageWithStatus("密码更改成功！", HttpContext);
    }

    private sealed class InputModel
    {
        [Required]
        [DataType(DataType.Password)]
        [Display(Name = "Current password")]
        public string OldPassword { get; set; } = "";

        [Required]
        [StringLength(100, ErrorMessage = "The {0} must be at least {2} and at max {1} characters long.", MinimumLength = 6)]
        [DataType(DataType.Password)]
        [Display(Name = "New password")]
        public string NewPassword { get; set; } = "";

        [DataType(DataType.Password)]
        [Display(Name = "Confirm new password")]
        [Compare("NewPassword", ErrorMessage = "The new password and confirmation password do not match.")]      
        public string ConfirmPassword { get; set; } = "";
    }
}
```

[root@cpzljc Shared]# cat ManageLayout.razor 
```html
@inherits LayoutComponentBase
@layout AccountLayout

<h1>账户管理</h1>

<div class="manage">
    <h2>变更账户设置</h2>
    <hr />
    <FluentGrid>
        <FluentGridItem sm="3">
            <ManageNavMenu />
        </FluentGridItem>

        <FluentGridItem sm="9">
            @Body
        </FluentGridItem>
    </FluentGrid>
</div>
```

[root@cpzljc Shared]# cat ManageNavMenu.razor 
```html
@using Microsoft.AspNetCore.Identity
@using jtpjsapp.Data

@inject SignInManager<ApplicationUser> SignInManager

<FluentNavMenu Collapse="false">
    <FluentNavLink Href="Account/Manage" Match="NavLinkMatch.All">简介</FluentNavLink>
    <FluentNavLink Href="Account/Manage/Email">邮箱</FluentNavLink>
    <FluentNavLink Href="Account/Manage/ChangePassword">密码</FluentNavLink>
    @if (hasExternalLogins)
    {
        <FluentNavLink Href="Account/Manage/ExternalLogins">External logins</FluentNavLink>
    }
    <FluentNavLink Href="Account/Manage/TwoFactorAuthentication">双重身份验证</FluentNavLink>
    <FluentNavLink Href="Account/Manage/PersonalData">个人数据</FluentNavLink>

</FluentNavMenu>


@code {
    private bool hasExternalLogins;

    protected override async Task OnInitializedAsync()
    {
        hasExternalLogins = (await SignInManager.GetExternalAuthenticationSchemesAsync()).Any();
    }
}
```

[root@cpzljc Pages]# cat ForgotPassword.razor 
```html
@page "/Account/ForgotPassword"

@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using jtpjsapp.Data

@inject UserManager<ApplicationUser> UserManager
@inject IEmailSender<ApplicationUser> EmailSender
@inject NavigationManager NavigationManager
@inject IdentityRedirectManager RedirectManager

<PageTitle>忘记了你的密码?</PageTitle>

<h1>忘记了你的密码?</h1>
<h2>输入你的邮箱。</h2>
<hr />
<FluentGrid>
    <FluentGridItem xs="8" sm="4">
        <EditForm Model="Input" FormName="forgot-password" OnValidSubmit="OnValidSubmitAsync" method="post">        
            <DataAnnotationsValidator />
            <FluentValidationSummary class="text-danger" role="alert" />
            <FluentTextField Name="Input.Email" @bind-Value="Input.Email" AutoComplete="username" Required="true" Placeholder="name@example.com" Label="邮箱" Style="width: 100%;" />
            <FluentValidationMessage For="() => Input.Email" class="text-danger" />
            <FluentButton Type="ButtonType.Submit" Appearance="Appearance.Accent" Style="width: 100%;">重置密码</FluentButton>
        </EditForm>
    </FluentGridItem>
</FluentGrid>

@code {
    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    private async Task OnValidSubmitAsync()
    {
        var user = await UserManager.FindByEmailAsync(Input.Email);
        if (user is null || !(await UserManager.IsEmailConfirmedAsync(user)))
        {
            // Don't reveal that the user does not exist or is not confirmed
            RedirectManager.RedirectTo("Account/ForgotPasswordConfirmation");
        }

        // For more information on how to enable account confirmation and password reset please
        // visit https://go.microsoft.com/fwlink/?LinkID=532713
        var code = await UserManager.GeneratePasswordResetTokenAsync(user);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ResetPassword").AbsoluteUri,
            new Dictionary<string, object?> { ["code"] = code });

        await EmailSender.SendPasswordResetLinkAsync(user, Input.Email, HtmlEncoder.Default.Encode(callbackUrl));   

        RedirectManager.RedirectTo("Account/ForgotPasswordConfirmation");
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = "";
    }
}
```

[root@cpzljc jtpjsapp]# dotnet publish -c Release
jtpjsapp -> /opt/aspnetcore/jtpjsapp/bin/Release/net8.0/jtpjsapp.dll
jtpjsapp -> /opt/aspnetcore/jtpjsapp/bin/Release/net8.0/publish/

[root@cpzljc publish]# ./jtpjsapp --urls  http://1.26:5246
[root@cpzljc jtpjsapp]# cat appsettings.json
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "DataSource=Data\\app.db;Cache=Shared"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "Kestrel": {
    "Endpoints": {
      "MyHttpEndpoint": {
        "Url": "http://1.26:5246"
      }
    }
  }

}
```

[root@cpzljc Properties]# cat launchSettings.json 
```json
{
  "$schema": "http://json.schemastore.org/launchsettings.json",
    "iisSettings": {
      "windowsAuthentication": false,
      "anonymousAuthentication": true,
      "iisExpress": {
        "applicationUrl": "http://localhost:51578",
        "sslPort": 44319
      }
    },
    "profiles": {
      "http": {
        "commandName": "Project",
        "dotnetRunMessages": true,
        "launchBrowser": true,
        "applicationUrl": "http://1.26:5200",
        "environmentVariables": {
          "ASPNETCORE_ENVIRONMENT": "Development"
        }
      },
      "https": {
        "commandName": "Project",
        "dotnetRunMessages": true,
        "launchBrowser": true,
        "applicationUrl": "https://localhost:7190;http://localhost:5017",
        "environmentVariables": {
          "ASPNETCORE_ENVIRONMENT": "Development"
        }
      },
      "IIS Express": {
        "commandName": "IISExpress",
        "launchBrowser": true,
        "environmentVariables": {
          "ASPNETCORE_ENVIRONMENT": "Development"
        }
      }
    }
  }
```

安装 Nginx
RHEL and derivatives
This section applies to Red Hat Enterprise Linux and its derivatives such as CentOS, Oracle Linux, Rocky Linux, AlmaLinux.
[root@cpzljc jtpjsapp]# sudo yum install yum-utils
警告：加载 '/etc/yum.repos.d/CentOS-Base.repo' 失败，跳过。
上次元数据过期检查：1:49:44 前，执行于 2024年10月31日 星期四 14时34分41秒。
软件包 yum-utils-4.0.21-3.el8.noarch 已安装。
依赖关系解决。
无需任何处理。
完毕！

To set up the yum repository, create the file named /etc/yum.repos.d/nginx.repo with the following contents:
[nginx-stable]
name=nginx stable repo
baseurl=http://nginx.org/packages/centos/$releasever/$basearch/
gpgcheck=1
enabled=1
gpgkey=https://nginx.org/keys/nginx_signing.key
module_hotfixes=true

[nginx-mainline]
name=nginx mainline repo
baseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/
gpgcheck=1
enabled=0
gpgkey=https://nginx.org/keys/nginx_signing.key
module_hotfixes=true

[root@cpzljc jtpjsapp]# sudo yum install nginx
When prompted to accept the GPG key, verify that the fingerprint matches 573B FD6B 3D8F BC64 1079 A6AB ABF5 BD82 7BD9 BF62, and if so, accept it.


--查看centos8 CPU、内存使用情况
```shell
[root@cpzljc aspnetcore]# top
```
Tasks: 438 total,   1 running, 437 sleeping,   0 stopped,   0 zombie
%Cpu(s):  0.1 us,  0.1 sy,  0.0 ni, 99.8 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
MiB Mem :  31956.8 total,  29309.2 free,   1450.6 used,   1197.1 buff/cache
MiB Swap:   4056.0 total,   4056.0 free,      0.0 used.  30057.9 avail Mem

    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND                                                    
   3059 root      20   0 8908800 318632 134548 S   1.7   1.0   0:13.17 gnome-shell
   2452 mysql     20   0 2459452 434896  37252 S   0.3   1.3   0:01.91 mysqld
   3988 root      20   0   65916   5400   4248 R   0.3   0.0   0:00.16 top                                                        
      1 root      20   0  238452  10928   8024 S   0.0   0.0   0:01.58 systemd
      2 root      20   0       0      0      0 S   0.0   0.0   0:00.01 kthreadd
      3 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 rcu_gp
      4 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 rcu_par_gp
      6 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 kworker/0:0H-events_highpri
	  	  

[root@cpzljc jtpjsapp]# dotnet add package ClosedXML
[root@cpzljc jtpjsapp]# cat jtpjsapp.csproj 
```csharp
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <UserSecretsId>aspnet-jtpjsapp-e8877394-d670-415f-b132-afb8176841ec</UserSecretsId>
  </PropertyGroup>

  <ItemGroup>
    <None Update="Data\app.db" CopyToOutputDirectory="PreserveNewest" ExcludeFromSingleFile="true" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="ClosedXML" Version="0.104.1" />
    <PackageReference Include="Microsoft.AspNetCore.Diagnostics.EntityFrameworkCore" Version="8.0.7" />
    <PackageReference Include="Microsoft.AspNetCore.Identity.EntityFrameworkCore" Version="8.0.7" />

    <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="8.0.10">
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.EntityFrameworkCore.Sqlite" Version="8.0.7" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.7" />
    <PackageReference Include="Microsoft.FluentUI.AspNetCore.Components.DataGrid.EntityFrameworkAdapter" Version="4.10.2" />
    <PackageReference Include="Microsoft.FluentUI.AspNetCore.Components.Emoji" Version="4.6.0" />
    <PackageReference Include="Pomelo.EntityFrameworkCore.MySql" Version="8.0.2" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.FluentUI.AspNetCore.Components" Version="4.*-*" />
    <PackageReference Include="Microsoft.FluentUI.AspNetCore.Components.Icons" Version="4.10.2" />
  </ItemGroup>
</Project>
```

mysql 备份：
[root@cpzljc backup]# mkdir jtpjsapp_backup

[root@cpzljc jtpjsapp_backup]# vim jtpjsapp_backup.sh
```shell
#!/bin/bash  
# 设置备份存储路径
backup_dir="/opt/backup/jtpjsapp_backup"
# 设置备份文件名
backup_file="$backup_dir/jtpjsapp$(date +%Y%m%d%H%M%S).sql"
# 设置MySQL登录凭据
mysql_user="root"
mysql_password="jtT0795,.,"
# 备份MySQL数据库到指定文件
##mysqldump -u$mysql_user -p$mysql_password --all-databases > $backup_file
mysqldump  -u$mysql_user -p$mysql_password --databases jt_pjs > $backup_file
# 打印备份完成信息
echo "MySQL jtpjsapp backup successfully completed: $backup_file"
```

[root@cpzljc jtpjsapp_backup]# chmod +x jtpjsapp_backup.sh

[root@cpzljc jtpjsapp_backup]# vim cleanup_jtpjsapp_backup.sh
```shell
#!/bin/bash  
# 设置备份存储路径
backup_dir="/opt/backup/jtpjsapp_backup"
# 设置最大备份文件数量
max_files=7
# 清理旧的备份文件
ls -t $backup_dir/*.sql | tail -n +$max_files | xargs -d '\n' rm -f
# 打印清理完成信息
echo "Old jtpjsapp backup files cleaned up successfully"
```

[root@cpzljc jtpjsapp_backup]# chmod +x cleanup_jtpjsapp_backup.sh

[root@cpzljc jtpjsapp_backup]# crontab -e
```shell
# 每天凌晨3点执行备份脚本
0 3 * * * /opt/backup/mysql_backup.sh
0 3 * * * /opt/backup/jtpjsapp_backup/jtpjsapp_backup.sh
# 每天凌晨5点执行备份脚本
0 5 * * * /opt/backup/cleanup_backup.sh
0 5 * * * /opt/backup/jtpjsapp_backup/cleanup_jtpjsapp_backup.sh
```

cron日志在/var/log/cron

还原：
mysql -u root -p -e "CREATE DATABASE if not exists jt_pjs;"
mysql -u root -p jt_pjs < /tmp/backup/jtpjsapp20241112081110.sql

[root@cpzljc jtpjsapp_backup]# cp -rf /opt/aspnetcore/jtpjsapp/  jtpjsapp

[root@cpzljc Pages]# dotnet --version
8.0.301

[root@cpzljc jtpjsapp]# dotnet list package
Project 'jtpjsapp' has the following package references
   [net8.0]: 
   Top-level Package                                                               Requested   Resolved
   > ClosedXML                                                                     0.104.1     0.104.1
   > Microsoft.AspNetCore.Diagnostics.EntityFrameworkCore                          8.0.7       8.0.7
   > Microsoft.AspNetCore.Identity.EntityFrameworkCore                             8.0.7       8.0.7
   > Microsoft.EntityFrameworkCore.Design                                          8.0.10      8.0.10
   > Microsoft.EntityFrameworkCore.Sqlite                                          8.0.7       8.0.7
   > Microsoft.EntityFrameworkCore.Tools                                           8.0.7       8.0.7
   > Microsoft.FluentUI.AspNetCore.Components                                      4.*-*       4.10.3
   > Microsoft.FluentUI.AspNetCore.Components.DataGrid.EntityFrameworkAdapter      4.10.2      4.10.2
   > Microsoft.FluentUI.AspNetCore.Components.Emoji                                4.6.0       4.6.0
   > Microsoft.FluentUI.AspNetCore.Components.Icons                                4.10.2      4.10.2
   > Pomelo.EntityFrameworkCore.MySql                                              8.0.2       8.0.2


dotnet new blazor -au Individual -o BlazorApp2 

1589918482@qq.com/Yuan1877008@

微软Open XML SDK: 导出excel库，https://learn.microsoft.com/zh-cn/office/open-xml/open-xml-sdk   
ClosedXML ：导出excel库，基于OpenXML  https://github.com/ClosedXML/ClosedXML     https://docs.closedxml.io/en/latest/     

aspnetcore mudblazor 使用closedxml读取上传的excel文件
在ASP.NET Core Blazor 应用中使用 ClosedXML 来读取上传的 Excel 文件可以分为几个步骤。ClosedXML 是一个开源库，用于处理 Excel 文件（如 XLSX 格式）。
下面是如何在你的 Blazor 应用中实现这一功能的详细步骤：
步骤 1: 安装 ClosedXML
首先，你需要在你的 ASP.NET Core Blazor 项目中安装 ClosedXML 包。你可以通过 NuGet 包管理器来安装它。在 Visual Studio 中，你可以通过“管理 NuGet 包”来搜索并安装 ClosedXML。
Install-Package ClosedXML
或者，如果你使用的是 .NET CLI，可以在项目目录下运行：
dotnet add package ClosedXML
步骤 2: 创建 Blazor 组件以处理文件上传
在 Blazor 应用中，你可以创建一个简单的文件上传组件，允许用户选择并上传一个 Excel 文件。
```html
@page "/upload"
@using Microsoft.AspNetCore.Components.Forms
@using ClosedXML.Excel
@inject IJSRuntime JSRuntime
 
<h3>Upload Excel File</h3>
<InputFile OnChange="HandleFilesSelected" />
 
@if (worksheetData != null)
{
    <table class="table">
        <thead>
            <tr>
                @foreach (var header in worksheetData.First().Select((value, index) => new { value, index }))
                {
                    <th>@header.index</th>
                }
            </tr>
        </thead>
        <tbody>
            @foreach (var row in worksheetData.Skip(1)) // Skip header row
            {
                <tr>
                    @foreach (var cell in row)
                    {
                        <td>@cell</td>
                    }
                </tr>
            }
        </tbody>
    </table>
}
 
@code {
    private List<List<object>> worksheetData;
 
    private async Task HandleFilesSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        var buffer = new byte[file.Size];
        await file.OpenReadStream(file.Size).ReadAsync(buffer);
        using (var workbook = new XLWorkbook(new MemoryStream(buffer)))
        {
            var worksheet = workbook.Worksheets.First();
            worksheetData = worksheet.RangeUsed().Rows().Select(r => r.Cells().Select(c => c.Value).ToList()).ToList();
        }
    }
}
```
步骤 3: 处理文件并读取数据
在上述代码中，当用户选择文件后，HandleFilesSelected 方法会被触发。这个方法读取文件内容，使用 ClosedXML 解析 Excel 文件，并将数据存储在一个列表中，每个单元格的值被存储在一个列表的列表中。然后，你可以在界面上显示这些数据。

步骤 4: 显示数据（可选）
在上面的代码示例中，一旦文件被解析，数据会显示在一个 HTML 表格中。你可以根据需要调整 UI 以更好地展示数据。

注意：
确保你的 Blazor 应用有处理文件上传的权限和正确的 MIME 类型配置。在 Startup.cs 中可能需要添加 app.UseStaticFiles(); 和 app.UseSpaStaticFiles();。

对于较大的文件或更复杂的数据处理，考虑在服务器端处理文件上传和解析以避免前端性能问题。你可以使用 IBrowserFile 在 Blazor 中上传文件到服务器，然后在服务器端使用 ClosedXML 处理文件。这可以通过创建一个 ASP.NET Core 的 Controller 来实现。

通过以上步骤，你可以在 ASP.NET Core Blazor 应用中使用 ClosedXML 读取并显示上传的 Excel 文件内容。

https://learn.microsoft.com/zh-cn/


aspnetcore blazor PdfSharp 生成导出pdf
当然，我会根据你的需求来回答关于使用 ASP.NET Core Blazor 结合 PdfSharp 生成并导出 PDF 文件的问题。
1. 如何在 ASP.NET Core Blazor 中使用 PdfSharp 生成 PDF？
步骤 1: 安装 PdfSharp  https://www.nuget.org/packages/PDFsharp/6.2.0-preview-3
首先，你需要在你的 ASP.NET Core Blazor 项目中安装 PdfSharp。你可以通过 NuGet 包管理器来安装它。在你的项目目录下打开命令行，运行以下命令：
dotnet add package PdfSharp
步骤 2: 创建 PDF   https://docs.pdfsharp.net/PDFsharp/Topics/Start/First-PDF.html
在 Blazor 组件中，你可以使用以下代码来创建一个简单的 PDF 文件：
```csharp
using PdfSharp.Pdf;
using PdfSharp.Drawing;
using System.IO;
 
public byte[] CreatePdf()
{
    // 创建一个PDF文档
    PdfDocument document = new PdfDocument();
    document.Info.Title = "示例文档";
    document.Info.Subject = "使用PdfSharp创建";
 
    // 添加一个页面
    PdfPage page = document.AddPage();
    XGraphics gfx = XGraphics.FromPdfPage(page);
    XFont font = new XFont("Times New Roman", 20, XFontStyleEx.BoldItalic);
    gfx.DrawString("Hello, World!", font, XBrushes.Black, new XRect(0, 0, page.Width, page.Height), XStringFormats.Center);    
    
   //添加图片
   //Drawing images on PDF pages
   //This code snippet shows how to draw an image at position (10, 10) with a size of (100, 100). gfx is an object of class XGraphics obtained for a PagePage object.
   var fullName = "Logo.png";
   var image = XImage.FromFile(fullName);
   gfx.DrawImage(image, 10, 10, 100, 100);   
	
    // 将PDF文档保存到内存流中
    MemoryStream stream = new MemoryStream();
    document.Save(stream, false);
    document.Close();
    
    // 将内存流转换为字节数组，以便可以将其作为文件下载或发送到客户端
    byte[] pdfBytes = stream.ToArray();
    stream.Close();
    return pdfBytes;
}
```
步骤 3: 在 Blazor 组件中调用此方法并下载 PDF
在 Blazor 页面中，你可以添加一个按钮，当点击时调用上述方法来生成 PDF 并触发下载：
```html
@code {
    private byte[] pdfBytes;
 
    private void GenerateAndDownloadPdf()
    {
        pdfBytes = CreatePdf(); // 调用创建PDF的方法
        DownloadPdf(); // 调用下载PDF的方法
    }
 
    private void DownloadPdf()
    {
        if (pdfBytes != null && pdfBytes.Length > 0)
        {
            var browserDownloadName = "example.pdf"; // 文件名
            var contentType = "application/pdf"; // MIME类型
            var ms = new MemoryStream(pdfBytes);
            var buffer = ms.GetBuffer(); // 获取字节数组的副本（如果需要）
            ms.Close(); // 关闭流，释放资源
            var contentLength = buffer.Length; // 文件大小（字节）
            var uriHelper = new Microsoft.AspNetCore.Components.WebAssembly.Authentication.RedirectUriHelper(NavigationManager); // 使用NavigationManager获取UriHelper（如果需要）
            uriHelper.DownloadFileFromStream(browserDownloadName, contentType, buffer, contentLength); // 使用UriHelper下载文件（如果需要）
        }
    }
}
```
注意：在实际应用中，你可能需要使用 JavaScript Interop 来触发浏览器的下载操作，因为 Blazor Server 或 Blazor WebAssembly 应用通常不能直接从服务器端代码控制客户端的文件下载。例如：
@code {
    [Inject] private IJSRuntime JSRuntime { get; set; } // 注入 IJSRuntime 服务以调用 JavaScript 代码。
}
然后在 JavaScript 中添加一个函数来处理下载：
```js
function downloadPdf(bytesBase64) {
    var linkSource = `data:application/pdf;base64,${bytesBase64}`;
    var downloadLink = document.createElement("a");
    document.body.appendChild(downloadLink);
    downloadLink.href = linkSource;
    downloadLink.download = "批量打印电机参数二维码.pdf"; // 文件名称为 example.pdf，可根据需要更改。
    downloadLink.click();
    document.body.removeChild(downloadLink); // 清理DOM。
}
```
然后在 C# 中调用此 JavaScript 方法：
private async Task DownloadPdf() {
    if (pdfBytes != null && pdfBytes.Length > 0) {
        string base64 = Convert.ToBase64String(pdfBytes); // 将字节数组转换为 Base64 字符串。
        await JSRuntime.InvokeVoidAsync("downloadPdf", base64);
    }
}


https://docs.pdfsharp.net/PDFsharp/Topics/Start/First-PDF.html
我的第一个 PDF 文件
版本 6.1.0
本文内容
字体解析
创建 PDF 文档
添加页面
绘图图形
绘图文本
完成并保存文档
完整源代码
试用 MigraDoc
本文逐步介绍如何创建简单的 PDF 文档。

字体解析
如果您使用 Core 版本，PDFsharp 需要知道如何映射字体。 您应该设置一个 FontResolver，它支持应用程序需要的所有字体。 
这里，我们设置了仅支持 Segoe WP 的 FailsafeFontResolver。 这对于我们的 “Hello， World！” 演示来说已经足够了，
但是如果您的代码请求 “Times New Roman” 或 “Courier New”，则 PDF 将始终使用 Segoe WP。
if (Capabilities.Build.IsCoreBuild)
    GlobalFontSettings.FontResolver = new FailsafeFontResolver();
（字体解析程序只能设置一次。有关字体解析器的更多详细信息，请参阅字体解析)
创建 PDF 文档
在下一步中，您在内存中创建一个新的空 PDF 文档。
var document = new PdfDocument();
您可以添加一些元信息。
document.Info.Title = "My first document created with PDFsharp";
document.Info.Author = "myself";
document.Info.Subject = "Just an example to demonstrate PDFsharp";
添加页面
您的文档当前不包含任何页面。 接下来，向文档添加一个页面。
var page = document.AddPage();
函数 AddPage 将向文档添加新的空白页。您可以使用 Pages 属性访问页面。

页面的默认大小取决于您的国家/地区设置。 如果使用公制进行测量，则大小设置为 A4 （21 x 29.7 cm²）。 否则，页面大小将设置为 Letter US（8.5 x 11 英寸²）。 页面的默认方向是纵向。

您可以使用以下属性更改页面大小和方向。
page.Size = PageSize.A3;
page.Orientation = PageOrientation.Landscape;
或者，您可以使用 Width 和 Height 属性单独设置页面大小。

绘图图形
要在此页上绘制文本或图形，请创建一个对象。XGraphics
var gfx = XGraphics.FromPdfPage(page);
您可以将 graphics 对象视为页面的画布。

下面的代码使用红笔从页面的角绘制两条对角线。
var width = page.Width;
var height = page.Height;
gfx.DrawLine(XPens.Red, 0, 0, width, height);
gfx.DrawLine(XPens.Red, width, 0, 0, height);
现在我们在页面中心画一个用白色画笔填充的圆圈。
var r = width / 5;
gfx.DrawEllipse(new XPen(XColors.Red, 1.5), XBrushes.White, new XRect(width / 2 - r, height / 2 - r, 2 * r, 2 * r));
绘图文本
要绘制文本，我们首先必须创建字体。
var font = new XFont("Times New Roman", 20, XFontStyleEx.BoldItalic);
现在，您可以使用此字体绘制一些文本。
gfx.DrawString("Hello, PDFsharp!", font, XBrushes.Black,
    new XRect(0, 0, page.Width, page.Height), XStringFormats.Center);
完成并保存文档
文档完成后，您可以将其保存到文件中。
var filename = IOUtility.GetTempPdfFullFileName("HelloWorldSample");
document.Save(filename);
保存文档后，不得再对其进行修改。


aspnetcore blazor PdfSharp 生成导出的pdf显示中文，字体要设置为什么?
在 ASP.NET Core Blazor 中使用 PdfSharp 生成包含中文的 PDF 时，你需要确保正确设置支持中文的字体。以下是详细步骤和代码示例：
步骤 1：准备中文字体文件
确保系统中存在支持中文的字体文件（如 .ttf 或 .ttc），例如：
微软雅黑 (msyh.ttc，路径通常为 C:\Windows\Fonts\msyh.ttc)
宋体 (SimSun.ttf)
黑体 (SimHei.ttf)
如果部署到 Linux 服务器，需将字体文件嵌入项目并复制到发布目录。

步骤 2：注册全局字体解析器（跨平台必需）
PdfSharp 默认可能无法直接访问系统字体，需通过 FontResolver 自定义字体加载：
using PdfSharp.Fonts;
using PdfSharp.Snippets.Font;

// 在程序启动时注册自定义 FontResolver
GlobalFontSettings.FontResolver = new FontResolver();

创建 FontResolver 类：
public class FontResolver : IFontResolver
{
    public FontResolverInfo ResolveTypeface(string familyName, bool isBold, bool isItalic)
    {
        // 根据字体名称返回对应的字体信息（示例使用微软雅黑）
        if (familyName.Equals("Microsoft YaHei", StringComparison.OrdinalIgnoreCase))
            return new FontResolverInfo("MicrosoftYaHei#");
        return null;
    }

    public byte[] GetFont(string faceName)
    {
        // 从文件或资源加载字体文件字节
        switch (faceName)
        {
            case "MicrosoftYaHei#":
                return File.ReadAllBytes("Fonts/msyh.ttc"); // 路径需根据项目调整
            default:
                return null;
        }
    }
}
步骤 3：在代码中使用中文字体
在生成 PDF 时，明确指定中文字体：
csharp
复制
using PdfSharp.Pdf;
using PdfSharp.Drawing;

public void GeneratePdfWithChinese()
{
    var document = new PdfDocument();
    var page = document.AddPage();
    var gfx = XGraphics.FromPdfPage(page);

    // 加载中文字体（确保名称与 FontResolver 中一致）
    var font = new XFont("Microsoft YaHei", 12, XFontStyle.Regular);

    // 绘制中文文本
    gfx.DrawString("你好，世界！", font, XBrushes.Black, new XRect(10, 10, page.Width, page.Height), XStringFormats.TopLeft);

    // 保存 PDF
    document.Save("output.pdf");
}
关键注意事项
字体嵌入：确保字体文件随应用发布（如放在 wwwroot/fonts 或项目根目录）。
跨平台路径：在 Linux 中，使用相对路径或确保字体文件权限正确。
字体版权：确认所选字体允许嵌入 PDF，避免法律问题。

常见问题排查
中文显示为方块：字体未正确加载，检查 FontResolver 路径和注册逻辑。
文件未找到：确认字体文件已包含在生成输出目录（设置文件属性为“始终复制”）。
通过上述步骤，即可在 Blazor 应用中用 PdfSharp 正确生成含中文的 PDF 文件。


aspnetcore blazor server PdfSharp6.1 自定义字体解析器
问题1: 如何在使用 ASP.NET Core Blazor Server 应用中集成 PdfSharp 6.1 并自定义字体解析器？
解决方案和实例代码：
添加 PdfSharp 库
首先，确保你的项目中已经安装了 PdfSharp 6.1。如果未安装，可以通过 NuGet 包管理器安装：
Install-Package PdfSharp

创建自定义字体解析器
在 ASP.NET Core Blazor Server 中，你可以通过创建一个自定义的 FontResolver 来指定字体文件的位置。PdfSharp 允许你通过继承 FontResolver 类并重写 ResolveFont 方法来自定义字体解析。
```csharp
using PdfSharp.Pdf;
using PdfSharp.Pdf.Internal;
using System;
using System.IO;
 
public class CustomFontResolver : FontResolver
{
    private readonly string _fontsDirectory;
 
    public CustomFontResolver(string fontsDirectory)
    {
        _fontsDirectory = fontsDirectory;
    }
 
    public override byte[] ResolveFont(string name, string basePath, bool throwOnError)
    {
        var fontPath = Path.Combine(_fontsDirectory, name + ".ttc"); // 假定字体文件以 .ttf 结尾
        if (File.Exists(fontPath))
        {
            return File.ReadAllBytes(fontPath);
        }
        else if (throwOnError)
        {
            throw new FileNotFoundException($"Font file not found: {name}");
        }
        return null; // 或者返回一个默认字体数据，如果找不到指定字体
    }
}
```
在 Blazor 应用中使用自定义字体解析器
在你的 Blazor 应用中，你可以在创建 PdfDocument 时使用这个自定义的 FontResolver。例如：
```csharp
using PdfSharp.Drawing;
using PdfSharp.Pdf;
using System;
using System.IO;
 
public class PdfGeneratorService
{
    public void CreatePdfWithCustomFonts(string outputPath)
    {
        var fontsDirectory = "path_to_your_fonts_directory"; // 指定字体目录路径
        var fontResolver = new CustomFontResolver(fontsDirectory);
        
        PdfDocument document = new PdfDocument();
        document.FontResolver = fontResolver; // 设置自定义字体解析器
        
        PdfPage page = document.AddPage(); // 添加页面
        XGraphics gfx = XGraphics.FromPdfPage(page); // 创建图形对象用于绘制PDF内容
        
        XFont font = new XFont("YourCustomFontName", 12); // 使用自定义字体名称创建字体对象，确保字体文件名称与此匹配或通过 ResolveFont 方法适配名称映射。
        gfx.DrawString("Hello, World!", font, XBrushes.Black, new XRect(0, 0, page.Width, page.Height), XStringFormats.Center); // 绘制文本到PDF页面上。
        
        document.Save(outputPath); // 保存PDF文件到指定路径。
    }
}
```
确保替换 "path_to_your_fonts_directory" 和 "YourCustomFontName" 为实际的路径和字体名称。字体名称应与你在自定义字体解析器中处理的文件名相匹配（不包括扩展名）。

	
8、 scp 将文件夹从windows传输给linux
SCP (Secure Copy) 是一个基于SSH（Secure Shell）的命令行工具，可以用来在Linux和Windows之间安全地传输文件。要使用SCP将文件夹从Windows传输到Linux，您需要在Windows机器上使用SCP客户端，并且确保您的Linux机器上已安装了SSH服务器。

以下是使用SCP将文件夹从Windows传输到Linux的步骤：
在Windows机器上，确保已安装SCP客户端，如Windows 10和更高版本通常已预装OpenSSH客户端。如果没有，可以从Microsoft Store安装OpenSSH客户端。
打开命令提示符或PowerShell。
使用以下SCP命令格式将文件夹及其内容传输到Linux服务器：
scp -r C:\path\to\local\folder username@linux_host:/path/to/remote/directory
其中：
-r 表示递归，用于传输文件夹。
C:\path\to\local\folder 是您要传输的Windows本地文件夹路径。
username 是您的Linux服务器上的用户名。
linux_host 是您的Linux服务器的IP地址或主机名。
/path/to/remote/directory 是Linux服务器上的目标文件夹路径。
确保您有适当的权限访问目标文件夹，并且Linux服务器上的SSH服务正在运行。
示例代码：
scp -r C:\Users\exampleuser\Documents\ myuser@192.168.1.10:/home/myuser/
scp -P 1225 -r G:\yuanxiaowen\G公司制度\技术管理部\jtpjsapp\ root@1.26:/opt/aspnetcore/
这个命令会将Windows上的C:\Users\exampleuser\Documents\文件夹递归地传输到IP地址为192.168.1.10的Linux服务器上的/home/myuser/目录。	
```shell 
	--从linux环境复制文件到windows环境
    scp -P 1225 -r root@1.26:/opt/aspnetcore/jtpjsapp/  /D:

    scp -P 1225 -r root@1.26:/opt/aspnetcore/ccjyapp/  /D:	
	
	scp -P 1225 -r root@1.26:/opt/rust/xtkq/  /D:
	
	scp -P 1225 -r root@1.26:/opt/aspnetcore/jtpjsapp/files/export/应收票据母票列表.xlsx  /D:
	
	scp -P 1225 -r root@1.26:/opt/backup/jtpjsapp_backup/jtpjsapp20241114030001.sql  /D:
	
	--从windows上传文件到linux
	scp -P 1225 G:/yuanxiaowen/G公司制度/技术管理部/02项目/应收票据/票据系统背景图.jpg root@1.26:/opt/aspnetcore/jtpjsapp/wwwroot
	scp -P 1225 D:/jtpjsapp20241112081110.sql root@1.25:/tmp/backup
	scp -P 1225 G:/yuanxiaowen/G公司制度/技术管理部/02项目/电机参数应用程序/simsun.ttc root@1.26:/opt/aspnetcore/ccjyapp/wwwroot
	scp -P 1225 G:/yuanxiaowen/G公司制度/技术管理部/02项目/电机参数应用程序/simhei.ttf root@1.26:/opt/aspnetcore/ccjyapp/wwwroot/fonts
    scp -P 1225 D:/EnterpriseApplicationPlatform/backend/build/libs/enterprise-platform-backend-0.0.1-SNAPSHOT.jar root@188.188.1.25:/app/
	
	/opt/aspnetcore/ccjyapp/wwwroot/
```	

9、 如何上传一个文件夹到github
要将一个文件夹上传到GitHub，需要进行以下步骤：
第一步：创建一个新的GitHub仓库
1. 在GitHub上创建一个新的仓库，命名为你想要上传的文件夹的名称。
2. 在仓库创建页面上，可以选择是否添加README文件、.gitignore文件等。

第二步：打开终端或命令行工具
1. 打开终端或命令行工具，并进入你要上传的文件夹的路径。

第三步：初始化本地仓库
1. 在终端或命令行工具中输入以下命令来初始化本地仓库：
   git init

第四步：添加文件夹中的所有文件到本地仓库
1. 在终端或命令行工具中输入以下命令来将文件夹中的所有文件添加到本地仓库：
   git add .

第五步：提交文件到本地仓库
1. 在终端或命令行工具中输入以下命令来提交文件到本地仓库，并添加提交信息：
   git commit -m “Initial commit”

   git config --global user.email "1589918482@qq.com"
   git config --global user.name "yanshu"
   --局部配置gitee用户名
   git config user.name "颜舒"
   
第六步：将本地仓库连接到GitHub仓库
1. 在GitHub仓库页面中，复制远程仓库的URL。
2. 在终端或命令行工具中输入以下命令来将本地仓库与远程仓库连接：   
   git remote add origin https://github.com/zuijiaoghb/jtpjsapp.git
   git remote add origin https://github.com/zuijiaoghb/ccjyapp.git
   git remote add origin https://github.com/zuijiaoghb/xtkq.git

第七步：将本地仓库的提交推送到GitHub仓库
1. 在终端或命令行工具中输入以下命令来将本地仓库的提交推送到GitHub仓库：
   git push -u origin master

完成以上步骤后，文件夹中的所有文件将被上传到GitHub仓库中。你可以在GitHub上查看和管理这些文件。	

10、 删除文件夹及其下的文件夹及文件
[root@cpzljc aspnetcore]# rm -rf BlazorApp

11、 mudblazor app
[root@cpzljc aspnetcore]# dotnet new install MudBlazor.Templates
[root@cpzljc aspnetcore]# dotnet new mudblazor -o ccjyapp --interactivity Server --auth Individual --all-interactive

[root@cpzljc Properties]# cat launchSettings.json 
```json
{
  "$schema": "http://json.schemastore.org/launchsettings.json",
    "iisSettings": {
      "windowsAuthentication": false,
      "anonymousAuthentication": true,
      "iisExpress": {
        "applicationUrl": "http://localhost:63410",
        "sslPort": 44371
      }
    },
    "profiles": {
      "http": {
        "commandName": "Project",
        "dotnetRunMessages": true,
        "launchBrowser": true,
        "applicationUrl": "http://1.26:5026",
        "environmentVariables": {
          "ASPNETCORE_ENVIRONMENT": "Development"
        }
      },
      "https": {
        "commandName": "Project",
        "dotnetRunMessages": true,
        "launchBrowser": true,
        "applicationUrl": "https://localhost:7246;http://localhost:5026",
        "environmentVariables": {
          "ASPNETCORE_ENVIRONMENT": "Development"
        }
      },
      "IIS Express": {
        "commandName": "IISExpress",
        "launchBrowser": true,
        "environmentVariables": {
          "ASPNETCORE_ENVIRONMENT": "Development"
        }
      }
    }
  }
```
  
[root@cpzljc Layout]# cat MainLayout.razor 
```html
@inherits LayoutComponentBase

<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />
<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
        <MudText Typo="Typo.h5" Class="ml-3">出厂检验</MudText>
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.Filled.MoreVert" Color="Color.Inherit" Edge="Edge.End" />
    </MudAppBar>
    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
        <NavMenu />
    </MudDrawer>
    <MudMainContent Class="mt-16 pa-4">
        @Body
    </MudMainContent>
</MudLayout>


<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">??</a>
</div>

@code {
    private bool _drawerOpen = true;

    private void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

}  
```

[root@cpzljc Layout]# cat NavMenu.razor 
```html
    @implements IDisposable
      
    @inject NavigationManager NavigationManager

    <MudNavMenu>
    @* <MudNavLink Href="" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">Home</MudNavLink>
        <MudNavLink Href="counter" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Add">Counter</MudNavLink>
        <MudNavLink Href="weather" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.List">Weather</MudNavLink>
        <MudNavLink Href="auth" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Lock">Auth Required</MudNavLink> *@
        <MudNavLink Href="motorParameter" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.SportsMotorsports">电机参数二维码生成</MudNavLink>
        <MudNavLink Href="tcpzljc" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.DataExploration">50亩出厂检验设备数据</MudNavLink>
    @*  
        <AuthorizeView>
            <Authorized>
                <MudNavLink Href="Account/Manage" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Person">@context.User.Identity?.Name</MudNavLink>
                <form action="Account/Logout" method="post">
                    <AntiforgeryToken />
                    <input type="hidden" name="ReturnUrl" value="@currentUrl" />
                    <button type="submit" class="mud-nav-link mud-ripple">
                        <MudIcon Icon="@Icons.Material.Filled.Logout" Color="Color.Info" Class="mr-3"></MudIcon> Logout
                    </button>
                </form>
            </Authorized>
            <NotAuthorized>
                <MudNavLink Href="Account/Register" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Person">Register</MudNavLink>
                <MudNavLink Href="Account/Login" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Password">Login</MudNavLink>
            </NotAuthorized>
        </AuthorizeView>
    *@
    </MudNavMenu>


    @code {
        private string? currentUrl;

        protected override void OnInitialized()
        {
            currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
            NavigationManager.LocationChanged += OnLocationChanged;
        }

        private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
        {
            currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
            StateHasChanged();
        }

        public void Dispose()
        {
            NavigationManager.LocationChanged -= OnLocationChanged;
        }
    }
```

[root@cpzljc ccjyapp]# cat Program.cs
```csharp 
using Microsoft.AspNetCore.Components.Authorization;
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
using MudBlazor.Services;
using ccjyapp.Components;
using ccjyapp.Components.Account;
using ccjyapp.Data;
using Pomelo.EntityFrameworkCore.MySql.Infrastructure;
using Microsoft.AspNetCore.Authorization;
using static Microsoft.AspNetCore.Http.StatusCodes;

var builder = WebApplication.CreateBuilder(args);

// Add MudBlazor services
builder.Services.AddMudServices();

// Add services to the container.
builder.Services.AddRazorComponents()
    .AddInteractiveServerComponents();

builder.Services.AddCascadingAuthenticationState();
builder.Services.AddScoped<IdentityUserAccessor>();
builder.Services.AddScoped<IdentityRedirectManager>();
builder.Services.AddScoped<AuthenticationStateProvider, IdentityRevalidatingAuthenticationStateProvider>();

builder.Services.AddAuthentication(options =>
    {
        options.DefaultScheme = IdentityConstants.ApplicationScheme;
        options.DefaultSignInScheme = IdentityConstants.ExternalScheme;
    })
    .AddIdentityCookies();

//var connectionString = builder.Configuration.GetConnectionString("DefaultConnection") ?? throw new InvalidOperationException("Connection string 'DefaultConnection' not found.");
//builder.Services.AddDbContext<ApplicationDbContext>(options =>
  //  options.UseSqlite(connectionString));
builder.Services.AddDbContextFactory<ApplicationDbContext>(opt =>
    opt.UseMySql("server=1.26;port=3306;database=ccjydb;user=root;password=jtT0795,.,;" , new MySqlServerVersion(new Version(8, 0, 31)) )
        // The following three options help with debugging, but should
        // be changed or removed for production.
        .LogTo(Console.WriteLine, LogLevel.Information)
        .EnableSensitiveDataLogging()
        .EnableDetailedErrors() );    
builder.Services.AddDbContextFactory<CpzljcDbContext>(opt =>
    opt.UseMySql("server=1.26;port=3306;database=cpzljc;user=root;password=jtT0795,.,;" , new MySqlServerVersion(new Version(8, 0, 31)) )
        // The following three options help with debugging, but should
        // be changed or removed for production.
        .LogTo(Console.WriteLine, LogLevel.Information)
        .EnableSensitiveDataLogging()
        .EnableDetailedErrors() );        
builder.Services.AddDatabaseDeveloperPageExceptionFilter();

builder.Services.AddIdentityCore<ApplicationUser>(options => options.SignIn.RequireConfirmedAccount = true)
    .AddEntityFrameworkStores<ApplicationDbContext>()
    .AddSignInManager()
    .AddDefaultTokenProviders();

builder.Services.AddSingleton<IEmailSender<ApplicationUser>, IdentityNoOpEmailSender>();

builder.Services.AddScoped<IBrowser, Browser>();

var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseMigrationsEndPoint();
}
else
{
    app.UseExceptionHandler("/Error", createScopeForErrors: true);
    // The default HSTS value is 30 days. You may want to change this for production scenarios, see https://aka.ms/aspnetcore-hsts.
    app.UseHsts();
}

app.UseHttpsRedirection();

app.UseStaticFiles();
app.UseAntiforgery();

app.MapRazorComponents<App>()
    .AddInteractiveServerRenderMode();

// Add additional endpoints required by the Identity /Account Razor components.
app.MapAdditionalIdentityEndpoints();

app.Run();
```

[root@cpzljc Data]# cat CpzljcDbContext.cs 
```csharp
using System;
using System.Collections.Generic;
using Microsoft.EntityFrameworkCore;
using Pomelo.EntityFrameworkCore.MySql.Scaffolding.Internal;

namespace ccjyapp.Data;

public partial class CpzljcDbContext : DbContext
{
    public CpzljcDbContext()
    {
    }

    public CpzljcDbContext(DbContextOptions<CpzljcDbContext> options)
        : base(options)
    {
    }

    public virtual DbSet<TCpzljc> TCpzljcs { get; set; }

    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
#warning To protect potentially sensitive information in your connection string, you should move it out of source code. You can avoid scaffolding the connection string by using the Name= syntax to read it from configuration - see https://go.microsoft.com/fwlink/?linkid=2131148. For more guidance on storing connection strings, see https://go.microsoft.com/fwlink/?LinkId=723263.
        => optionsBuilder.UseMySql("server=1.26;port=3306;database=cpzljc;user=root;password=jtT0795,.,", Microsoft.EntityFrameworkCore.ServerVersion.Parse("8.0.31-mysql"));

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        modelBuilder
            .UseCollation("utf8mb4_unicode_ci")
            .HasCharSet("utf8mb4");

        modelBuilder.Entity<TCpzljc>(entity =>
        {
            entity
                .HasNoKey()
                .ToTable("t_cpzljc");

            entity.Property(e => e.互感抗).HasMaxLength(7);
            entity.Property(e => e.出厂编号).HasMaxLength(15);
            entity.Property(e => e.匝间测试结果).HasMaxLength(8);
            entity.Property(e => e.匝间电压).HasMaxLength(7);
            entity.Property(e => e.变频空载电流)
                .HasMaxLength(7)
                .HasColumnName("变频_空载电流");
            entity.Property(e => e.噪声).HasMaxLength(7);
            entity.Property(e => e.堵转功率).HasMaxLength(7);
            entity.Property(e => e.堵转平衡度).HasMaxLength(7);
            entity.Property(e => e.堵转电压).HasMaxLength(7);
            entity.Property(e => e.堵转电压1).HasMaxLength(7);
            entity.Property(e => e.堵转电压2).HasMaxLength(7);
            entity.Property(e => e.堵转电压3).HasMaxLength(7);
            entity.Property(e => e.堵转电流).HasMaxLength(7);
            entity.Property(e => e.堵转电流1).HasMaxLength(7);
            entity.Property(e => e.堵转电流2).HasMaxLength(7);
            entity.Property(e => e.堵转电流3).HasMaxLength(7);
            entity.Property(e => e.定子电阻).HasMaxLength(7);
            entity.Property(e => e.微动开关).HasMaxLength(7);
            entity.Property(e => e.振动x轴)
                .HasMaxLength(7)
                .HasColumnName("振动X轴");
            entity.Property(e => e.振动y轴)
                .HasMaxLength(7)
                .HasColumnName("振动Y轴");
            entity.Property(e => e.振动z轴)
                .HasMaxLength(7)
                .HasColumnName("振动Z轴");
            entity.Property(e => e.标准温度).HasMaxLength(7);
            entity.Property(e => e.测试员).HasMaxLength(10);
            entity.Property(e => e.测试日期).HasColumnType("datetime");
            entity.Property(e => e.测试时间).HasMaxLength(30);
            entity.Property(e => e.测试结果).HasMaxLength(20);
            entity.Property(e => e.测试结论).HasMaxLength(20);
            entity.Property(e => e.漏感抗).HasMaxLength(7);
            entity.Property(e => e.电机型号).HasMaxLength(40);
            entity.Property(e => e.电机相数).HasMaxLength(8);
            entity.Property(e => e.电阻1).HasMaxLength(7);
            entity.Property(e => e.电阻2).HasMaxLength(7);
            entity.Property(e => e.电阻3).HasMaxLength(7);
            entity.Property(e => e.电阻平衡度).HasMaxLength(7);
            entity.Property(e => e.空载功率).HasMaxLength(7);
            entity.Property(e => e.空载平衡度).HasMaxLength(7);
            entity.Property(e => e.空载电压).HasMaxLength(7);
            entity.Property(e => e.空载电压1).HasMaxLength(7);
            entity.Property(e => e.空载电压2).HasMaxLength(7);
            entity.Property(e => e.空载电压3).HasMaxLength(7);
            entity.Property(e => e.空载电流).HasMaxLength(7);
            entity.Property(e => e.空载电流1).HasMaxLength(7);
            entity.Property(e => e.空载电流2).HasMaxLength(7);
            entity.Property(e => e.空载电流3).HasMaxLength(7);
            entity.Property(e => e.绝缘电阻).HasMaxLength(7);
            entity.Property(e => e.耐压泄漏).HasMaxLength(7);
            entity.Property(e => e.耐压电压).HasMaxLength(7);
            entity.Property(e => e.转向).HasMaxLength(7);
            entity.Property(e => e.转子电阻).HasMaxLength(7);
            entity.Property(e => e.频率).HasMaxLength(7);
        });

        OnModelCreatingPartial(modelBuilder);
    }

    partial void OnModelCreatingPartial(ModelBuilder modelBuilder);
}
```

[root@cpzljc Data]# cat TCpzljc.cs 
```csharp
using System;
using System.Collections.Generic;

namespace ccjyapp.Data;

public partial class TCpzljc
{
    public string? 测试时间 { get; set; }

    public string? 电机型号 { get; set; }

    public string? 出厂编号 { get; set; }

    public string? 电机相数 { get; set; }

    public DateTime? 测试日期 { get; set; }

    public string? 电阻2 { get; set; }

    public string? 电阻3 { get; set; }

    public string? 电阻1 { get; set; }

    public string? 标准温度 { get; set; }

    public string? 电阻平衡度 { get; set; }

    public string? 绝缘电阻 { get; set; }

    public string? 匝间电压 { get; set; }

    public string? 匝间测试结果 { get; set; }

    public string? 堵转电压 { get; set; }

    public string? 堵转电流1 { get; set; }

    public string? 堵转电流2 { get; set; }

    public string? 堵转电流3 { get; set; }

    public string? 堵转电压1 { get; set; }

    public string? 堵转电压2 { get; set; }

    public string? 堵转电压3 { get; set; }

    public string? 堵转电流 { get; set; }

    public string? 堵转平衡度 { get; set; }

    public string? 堵转功率 { get; set; }

    public string? 空载电压 { get; set; }

    public string? 空载电压1 { get; set; }

    public string? 空载电压2 { get; set; }

    public string? 空载电压3 { get; set; }

    public string? 空载电流1 { get; set; }

    public string? 空载电流2 { get; set; }

    public string? 空载电流3 { get; set; }

    public string? 空载电流 { get; set; }

    public string? 空载平衡度 { get; set; }

    public string? 空载功率 { get; set; }

    public string? 频率 { get; set; }

    public string? 转向 { get; set; }

    public string? 噪声 { get; set; }

    public string? 振动z轴 { get; set; }

    public string? 振动x轴 { get; set; }

    public string? 振动y轴 { get; set; }

    public string? 定子电阻 { get; set; }

    public string? 转子电阻 { get; set; }

    public string? 漏感抗 { get; set; }

    public string? 互感抗 { get; set; }

    public string? 变频空载电流 { get; set; }

    public string? 微动开关 { get; set; }

    public string? 耐压电压 { get; set; }

    public string? 耐压泄漏 { get; set; }

    public string? 测试结果 { get; set; }

    public string? 测试结论 { get; set; }

    public string? 测试员 { get; set; }
}
```

[root@cpzljc Pages]# cp Counter.razor MotorParameter.razor
[root@cpzljc Pages]# vim MotorParameter.razor
[root@cpzljc Pages]# cat MotorParameter.razor 
```html
@page "/motorParameter"

@implements IDisposable
@inject ILogger<MotorParameterModel> Logger
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IDialogService DialogService
@inject IAuthorizationService AuthorizationService
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime
@using ClosedXML.Excel
@inject NavigationManager NavigationManager

@using System.ComponentModel.DataAnnotations
@using ccjyapp.Data
@using System
@using System.IO
@using iText.Kernel.Pdf
@using iText.Layout
@using iText.Layout.Element
@using iText.Kernel.Font
@using iText.IO.Font
@using iText.IO.Font.Constants
@using iText.Layout.Properties
@using Microsoft.AspNetCore.Components
@using System.Threading.Tasks
@using iText.Kernel.Geom
@using iText.IO.Image
@using iText.Barcodes

<PageTitle>电机参数</PageTitle>

<MudGrid Spacing=0>
<MudItem>
<MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined">
    <MudButton StartIcon="@Icons.Material.Filled.AddCircleOutline" IconColor="Color.Primary" @onclick="addMotorParameterAsync" Disabled=adddisabled >新增</MudButton>
    <MudButton StartIcon="@Icons.Material.Filled.Edit" IconColor="Color.Primary"  Disabled=modifydisabled @onclick="modifyMotorParameterByFactoryNumberAndId">修改</MudButton>
    <MudButton StartIcon="@Icons.Material.Filled.Delete" IconColor="Color.Primary"  Disabled=deletedisabled @onclick="deleteMotorParameterByFactoryNumberAndId">删除</MudButton>
    <MudButton StartIcon="@Icons.Material.Filled.FindInPage" IconColor="Color.Primary" Disabled=finddisabled @onclick="OpenFindMotorParamterByFactoryNumberDialog" > 查询</MudButton>
    <MudButton StartIcon="@Icons.Material.Filled.Print" IconColor="Color.Primary" @onclick="OpenPrintMotorParameterQRCoderDialog">单个打印二维码</MudButton>
</MudButtonGroup>
</MudItem>
<MudItem>
<MudFileUpload T="IBrowserFile" FilesChanged="UploadFiles" Accept=".xlsx" MaximumFileCount="1" >
    <ActivatorContent>
        <MudButton Variant="Variant.Outlined"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.CloudUpload">
            上传.xlsx文件
        </MudButton>
    </ActivatorContent>
</MudFileUpload>
</MudItem>
@*
<MudItem>
<MudButton Variant="Variant.Outlined"  StartIcon="@Icons.Material.Filled.Print" IconColor="Color.Primary" Color="Color.Primary" @onclick="OpenBatchPrintMotorParameterQRCoderDialog">批量打印二维码(先上传.xlsx文件)</MudButton>
</MudItem>
*@
<MudItem>
    <MudButton Variant="Variant.Outlined"  StartIcon="@Icons.Material.Filled.Print" IconColor="Color.Primary" Color="Color.Primary" @onclick="DownloadPdf">下载批量打印电机参数二维码PDF(先上传.xlsx文件)</MudButton>
</MudItem>
</MudGrid>

@*
<div @ref="printMotorParameterQRCoderElement">
    <!-- 需要打印的内容 -->
    "要打印的内容"
</div>

<button @onclick="() => PrintContent(printMotorParameterQRCoderElement)">打印</button>
*@

<MudDialog @bind-Visible="_visible" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.FindInPage" Class="mr-3" /> 查询方案
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudGrid>
            <MudItem xs="12" lg="3">
                <MudTextField Label="出厂编号" HelperText="" Class="mt-3" Required="true"  Variant="Variant.Outlined"
                              @bind-Value="factoryNumber" For="@(() => factoryNumber)" />
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">取消</MudButton>
        <MudButton Color="Color.Primary" OnClick="FindMotorParameterByFactoryNumberAsync">确认</MudButton>
    </DialogActions>
</MudDialog>

<MudDialog @bind-Visible="_printMotorParameterQRCodervisible" Options="_printMotorParameterQRCoderdialogOptions" Style="height:80;Width=40" >
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.QrCode" Class="mr-3" /> 电机参数二维码
        </MudText>
    </TitleContent>
    <DialogContent>
               <div @ref="printMotorParameterQRCoderElement">
                     @* <MudGrid>
                        <MudItem xs="6" lg="6" md="6" Style="height:100px;Width=100px">
                        <MudText Typo="Typo.body1"> <b>电机型号：</b></MudText>
                        <MudText Typo="Typo.body2">@motorParameterModel.MotorModel</MudText>
                        <MudText Typo="Typo.body1"><b>出厂编号：</b></MudText>
                        <MudText Typo="Typo.body2"> @motorParameterModel.FactoryNumber</MudText>
                        </MudItem> *@
                        <div style="display:flex;">
                          <div style="margin: 0;">
                          <p style="font-size:4;"><strong>电机型号：</strong></p>
                          <p style="font-size:4;">@motorParameterModel.MotorModel</p>
                          <p style="font-size:4;"><strong>出厂编号：</strong></p>
                          <p style="font-size:4;">@motorParameterModel.FactoryNumber</p>
                          </div>
                       @* <MudImage Src="@qrCodeImageAsBase64_src" Alt="" Elevation="25" Class="rounded-lg" Width="80" Height="80"/> *@
                          <div>
                             <img src= "@qrCodeImageAsBase64_src" width="35" height="35">
                          </div>
                        </div>
                    @*  </MudItem>  *@
                    @*  </MudGrid>  *@
                </div>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="printMotorParameterQRCoderCancel">取消</MudButton>
        <MudButton Color="Color.Primary" OnClick="() => printMotorParameterQRCoderAsync(printMotorParameterQRCoderElement)">确认打印</MudButton>
    </DialogActions>
</MudDialog>

<MudDialog @bind-Visible="_batchPrintMotorParameterQRCodervisible" Options="_batchPrintMotorParameterQRCoderdialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.QrCode" Class="mr-3" /> 批量打印电机参数二维码
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudGrid>
            <MudItem xs="12" lg="3">
                <div @ref="batchPrintMotorParameterQRCoderElement">
                    @* foreach (var qr  in qrCodeImageAsBase64_src_list) *@
                    @for (int i=0; i<qrCodeImageAsBase64_src_list.Count; i++){
                          <p><strong>电机型号：</strong>@motorParameterModel_list[i].MotorModel</p>
                          <p><strong>出厂编号：</strong>@motorParameterModel_list[i].FactoryNumber</p>
                          @* <MudImage Src="@qrCodeImageAsBase64_src" Alt="" Elevation="25" Class="rounded-lg" Width="80" Height="80"/> *@
                          <img src= "@qrCodeImageAsBase64_src_list[i]" width="80" height="80">
                    }
                </div>
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="batchPrintMotorParameterQRCoderCancel">取消</MudButton>
        <MudButton Color="Color.Primary" OnClick="() => printMotorParameterQRCoderAsync(batchPrintMotorParameterQRCoderElement)">确认打印</MudButton>
    </DialogActions>
</MudDialog>

<MudGrid Justify="Justify.Center">
    <MudItem xs="12" lg="3" >
        <MudText Typo="Typo.h5" Align="Align.Center" >电机参数</MudText>
    </MudItem>
</MudGrid>

<EditForm Model="motorParameterModel" OnValidSubmit="OnValidSubmitAsync">
<DataAnnotationsValidator/>
<MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined">
    <MudButton ButtonType="ButtonType.Submit" StartIcon="@Icons.Material.Filled.Save" IconColor="Color.Primary" Disabled=submitdisabled>保存</MudButton>
    <MudButton StartIcon="@Icons.Material.Filled.Cancel" IconColor="Color.Primary" Disabled=cansledisabled @onclick="cansleSubmit">取消</MudButton>
</MudButtonGroup>
<MudGrid>
    <MudItem xs="12" lg="3">
        <MudSelect @bind-Value="motorParameterModel.Company" Label="所属单位" Variant="Variant.Outlined"  Required="true"  HelperText="选择所属单位" OpenIcon="@Icons.Material.Filled.House" AdornmentColor="Color.Secondary" ReadOnly=formdisabled >
                     @foreach (MotorParameterCompany item in Enum.GetValues(typeof(MotorParameterCompany))) {
                     <MudSelectItem Value="@item">@item</MudSelectItem>
                }
         </MudSelect>
    </MudItem>
    <MudItem xs="12" lg="3">
        <MudTextField ShrinkLabel Label="电机型号" Class="mt-3" Variant="Variant.Outlined"  Required="true"
                              @bind-Value="motorParameterModel.MotorModel" For="@(() => motorParameterModel.MotorModel)" ReadOnly=formdisabled />
    </MudItem>
    <MudItem xs="12" lg="3">
        <MudTextField ShrinkLabel Label="出厂编号" Class="mt-3" Variant="Variant.Outlined"  Required="true"
                              @bind-Value="motorParameterModel.FactoryNumber" For="@(() => motorParameterModel.FactoryNumber)" ReadOnly=formdisabled />
    </MudItem>
    <MudItem xs="12" lg="3">
        <MudTextField ShrinkLabel Label="电机相数" Class="mt-3" Variant="Variant.Outlined"  Required="true"
                              @bind-Value="motorParameterModel.MotorPhases" For="@(() => motorParameterModel.MotorPhases)" ReadOnly=formdisabled />
    </MudItem>
    <MudItem xs="12" lg="3">
        <MudNumericField @bind-Value="motorParameterModel.POLENUMBER" Label="电机极数" Variant="Variant.Outlined" Min="0" Required="true" ReadOnly=formdisabled />   
    </MudItem>
    <MudItem xs="12" lg="3">
        <MudTextField ShrinkLabel Label="中联编码" Class="mt-3" Variant="Variant.Outlined"  Required="true"
                              @bind-Value="motorParameterModel.ZLCode" For="@(() => motorParameterModel.ZLCode)" ReadOnly=formdisabled />
    </MudItem>
    <MudItem xs="12" lg="3">
        <MudTextField ShrinkLabel Label="生产编码" Class="mt-3" Required="true"  Variant="Variant.Outlined"
                              @bind-Value="motorParameterModel.SerialNumber" For="@(() => motorParameterModel.SerialNumber)" ReadOnly=formdisabled />
    </MudItem>
    <MudItem xs="12" lg="3">
        <MudNumericField @bind-Value="motorParameterModel.RatedPower" Label="额定功率" Variant="Variant.Outlined" Min="0.0" Required="true" ReadOnly=formdisabled /> 
    </MudItem>
    <MudItem xs="12" lg="3">
        <MudNumericField @bind-Value="motorParameterModel.RatedFrequency" Label="额定频率" Variant="Variant.Outlined" Min="0.0" Required="true" ReadOnly=formdisabled />
    </MudItem>
        <MudItem xs="12" lg="3">
        <MudNumericField @bind-Value="motorParameterModel.RatedSpeed" Label="额定转速" Variant="Variant.Outlined" Min="0.0" Required="true" ReadOnly=formdisabled /> 

    </MudItem>
        <MudItem xs="12" lg="3">
        <MudNumericField @bind-Value="motorParameterModel.RatedVoltage" Label="额定电压" Variant="Variant.Outlined" Min="0.0" Required="true" ReadOnly=formdisabled />
    </MudItem>
        <MudItem xs="12" lg="3">
        <MudNumericField @bind-Value="motorParameterModel.RatedCurrent" Label="额定电流" Variant="Variant.Outlined" Min="0.0" Required="true" ReadOnly=formdisabled />
    </MudItem>
        <MudItem xs="12" lg="3">
        <MudNumericField @bind-Value="motorParameterModel.StatorResistance" Label="定子电阻" Variant="Variant.Outlined" Min="0.0" Required="true" ReadOnly=formdisabled />
    </MudItem>
        <MudItem xs="12" lg="3">
        <MudNumericField @bind-Value="motorParameterModel.RotorResistance" Label="转子电阻" Variant="Variant.Outlined" Min="0.0" Required="true" ReadOnly=formdisabled />
    </MudItem>
        <MudItem xs="12" lg="3">
        <MudNumericField @bind-Value="motorParameterModel.LeakageReactance" Label="漏感抗" Variant="Variant.Outlined" Min="0.0" Required="true" ReadOnly=formdisabled />
    </MudItem>
        <MudItem xs="12" lg="3">
        <MudNumericField @bind-Value="motorParameterModel.MutualInductance" Label="互感抗" Variant="Variant.Outlined" Min="0.0" Required="true" ReadOnly=formdisabled />
    </MudItem>
        <MudItem xs="12" lg="3">
        <MudNumericField @bind-Value="motorParameterModel.NoLoadCurrent" Label="空载电流" Variant="Variant.Outlined" Min="0.0" Required="true" ReadOnly=formdisabled />
    </MudItem>
    <MudItem xs="12" lg="3">
       <MudDatePicker ShrinkLabel Label="新建日期" Editable="true" @bind-Date="addtimedate" Placeholder="" Variant="Variant.Outlined" ReadOnly=foreverdisabled />    

    </MudItem>
    <MudItem xs="12" lg="3">
       <MudTimePicker ShrinkLabel Label="新建时间" AmPm="true" @bind-Time="addtimespan" Variant="Variant.Outlined" ReadOnly=foreverdisabled  />
    </MudItem>
    <MudItem xs="12" lg="3">
       <MudDatePicker ShrinkLabel Label="修改日期" Editable="true" @bind-Date="modifytimedate" Placeholder="" Variant="Variant.Outlined" ReadOnly=foreverdisabled /> 

    </MudItem>
    <MudItem xs="12" lg="3">
       <MudTimePicker ShrinkLabel Label="修改时间" AmPm="true" @bind-Time="modifytimespan" Variant="Variant.Outlined" ReadOnly=foreverdisabled />
    </MudItem>
</MudGrid>
</EditForm>

@code {
    private MotorParameterModel motorParameterModel = new MotorParameterModel(DateTime.Now, DateTime.Now);
    private DateTime? addtimedate = DateTime.Today;
    private DateTime? modifytimedate;
    //private TimeSpan? addtimespan = new TimeSpan(motorParameterModel.AddTime.Hour, motorParameterModel.AddTime.Minute, motorParameterModel.AddTime.Second);        
    //private TimeSpan? modifytimespan = new TimeSpan(motorParameterModel.ModifyTime.Hour, motorParameterModel.ModifyTime.Minute, motorParameterModel.ModifyTime.Second);
    private TimeSpan? addtimespan = new TimeSpan(DateTime.Now.Hour, DateTime.Now.Minute, DateTime.Now.Second);
    private TimeSpan? modifytimespan;

    private ApplicationDbContext? Context { get; set; }
    private bool Busy;

    private int currentCount = 0;
    private bool adddisabled = false;
    private bool finddisabled = false;
    private bool modifydisabled = true;
    private bool deletedisabled = true;
    private bool submitdisabled = true;
    private bool cansledisabled = true;
    private bool formdisabled = true;
    private bool ismodifybutton = false;
    private bool foreverdisabled = true;

    private string motorParameterCompany;
    string state = "Message box hasn't been opened yet";

    private bool _visible;
    private readonly DialogOptions _dialogOptions = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true, BackdropClick = false };
    private string serialNumber;
    private string factoryNumber;

    private string qrCodeImageAsBase64_src;
    private List<string> qrCodeImageAsBase64_src_list = new List<string>();
    private List<string> qrCodeImageAsBase64_list = new List<string>();
    private bool _printMotorParameterQRCodervisible;
    private readonly DialogOptions _printMotorParameterQRCoderdialogOptions = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = false, BackdropClick = false };

    private bool _batchPrintMotorParameterQRCodervisible;
    private readonly DialogOptions _batchPrintMotorParameterQRCoderdialogOptions = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = false, BackdropClick = false };

    private ElementReference printMotorParameterQRCoderElement;
    private ElementReference batchPrintMotorParameterQRCoderElement;

    IList<IBrowserFile> _files = new List<IBrowserFile>();
    private List<List<ClosedXML.Excel.XLCellValue>> worksheetData;
    private List<MotorParameterModel> motorParameterModel_list = new List<MotorParameterModel>();

    private byte[] pdfBytes;

    private async Task DownloadPdf() {
        var memoryStream = new MemoryStream();
        var pdfWriter = new PdfWriter(memoryStream);
        var pdf = new PdfDocument(pdfWriter);
        //var document = new Document(pdf);
        var document = new Document(pdf, new PageSize(80, 40)); // 自定义大小（mm单位）
        document.SetMargins(0, 0, 0, 0);

        // 设置中文字体（这里使用黑体）
        var fontProgram = FontProgramFactory.CreateFont("/opt/aspnetcore/ccjyapp/wwwroot/fonts/simhei.ttf", true);
        PdfFont font = PdfFontFactory.CreateFont(fontProgram);

        for (int i=0; i<qrCodeImageAsBase64_list.Count; i++){
           // 添加一个带有中文的段落
           Paragraph djxh = new Paragraph("电机型号：\n" + motorParameterModel_list[i].MotorModel + "\n" + "出厂编号：\n" + motorParameterModel_list[i].FactoryNumber)
                        //.SetTextAlignment(TextAlignment.JUSTIFIED)
                        .SetFont(font)
                        .SetFontSize(4)
                        .SetMarginBottom(0)
                        .SetTextAlignment(TextAlignment.LEFT) // 设置文本对齐方式为左对齐
                        .SetVerticalAlignment(VerticalAlignment.TOP) // 设置垂直对齐方式为顶部对齐
                        .SetMarginLeft(2); // 设置左边距
                        //.SetMarginTop(0); // 设置上边距ConvertUtil.MillimeterToPoint(10)
           document.Add(djxh);

            // 将 Base64 字符串转换为字节数组
            Logger.LogInformation("generateQRcodeBase64:" + qrCodeImageAsBase64_list[i]);
            byte[] imageBytes = Convert.FromBase64String(qrCodeImageAsBase64_list[i]);
            // 使用 ImageDataFactory 创建 ImageData 实例
            ImageData imageData = ImageDataFactory.Create(imageBytes);
            // 创建 Image 实例并添加到文档中
            Image img = new Image(imageData);
            img.SetFixedPosition(45, 5);
            img.ScaleToFit(35, 35);
            document.Add(img);
            //Logger.LogInformation("下载pdf");


           if (i < qrCodeImageAsBase64_list.Count-1)
           {
              document.Add(new AreaBreak(AreaBreakType.NEXT_PAGE));
           }
       }
           Console.WriteLine("qrCodeImageAsBase64_list.Count:" + qrCodeImageAsBase64_list.Count);
           document.Close();
           pdfWriter.Close();

        // 将内存流转换为字节数组，以便可以将其作为文件下载或发送到客户端
        pdfBytes = memoryStream.ToArray();
        //Logger.LogInformation("pdfBytes:{pdfBytes}", System.Text.Encoding.UTF8.GetString(pdfBytes));

        if (pdfBytes != null && pdfBytes.Length > 0) {
           string base64 = Convert.ToBase64String(pdfBytes); // 将字节数组转换为 Base64 字符串。
           Logger.LogInformation("pdf base64:{base64}", base64);
           await JSRuntime.InvokeVoidAsync("downloadPdf", base64);
        }

        memoryStream.Dispose();
        qrCodeImageAsBase64_list.Clear();
        RefreshPage();
   }

   private string generateQRcodeBase64() {
       string qrCodeContent = "0001" +  FloatToHexConverter.FloatToHexString((float)motorParameterModel.RatedPower) + FloatToHexConverter.FloatToHexString((float)motorParameterModel.RatedFrequency) + FloatToHexConverter.FloatToHexString((float)motorParameterModel.RatedSpeed) + FloatToHexConverter.FloatToHexString((float)motorParameterModel.RatedVoltage) + FloatToHexConverter.FloatToHexString((float)motorParameterModel.RatedCurrent) + FloatToHexConverter.FloatToHexString((float)motorParameterModel.StatorResistance) + FloatToHexConverter.FloatToHexString((float)motorParameterModel.RotorResistance) + FloatToHexConverter.FloatToHexString((float)motorParameterModel.LeakageReactance) + FloatToHexConverter.FloatToHexString((float)motorParameterModel.MutualInductance) + FloatToHexConverter.FloatToHexString((float)motorParameterModel.NoLoadCurrent);
        Logger.LogInformation("qrCodeContent = {qrCodeContent}", qrCodeContent);
        string qrCodeContentBASE64 = motorParameterModel.ZLCode + "&" +motorParameterModel.SerialNumber + "&" +  Base64EncodingUtil.EncodeHexStringToBase64(qrCodeContent).Replace("+", "-").Replace("/", "_");
        Logger.LogInformation("qrCodeContentBASE64 = {qrCodeContentBASE64}", qrCodeContentBASE64);

        //Console.Write(b.ToString("X2") + " ");
        //Console.WriteLine("四字节十六进制表示:" + qrCodeContent);

        QRCodeGenerator qrGenerator = new QRCodeGenerator();
        QRCodeData qrCodeData = qrGenerator.CreateQrCode(qrCodeContentBASE64, QRCodeGenerator.ECCLevel.M);

        var imgType = Base64QRCode.ImageType.Png;
        Base64QRCode qrCode = new Base64QRCode(qrCodeData);
        string qrCodeImageAsBase64 = qrCode.GetGraphic(20, "#000000", "#ffffff", true, imgType);
        //Logger.LogInformation("qrCodeImageAsBase64 = {qrCodeImageAsBase64}", qrCodeImageAsBase64);
        //qrCodeImageAsBase64_src = "data:image/" + imgType.ToString().ToLower() + ";base64," + qrCodeImageAsBase64;
        //Logger.LogInformation("qrCodeImageAsBase64_src = {qrCodeImageAsBase64_src}" , qrCodeImageAsBase64_src);
        return qrCodeImageAsBase64;
   }

    private async Task UploadFiles(IBrowserFile file)
    {
        int import_count = 0;
        _files.Add(file);
        //TODO upload the files to the server
        //var file = e.File;
        var buffer = new byte[file.Size];
        var stream = file.OpenReadStream(file.Size);
        await stream.ReadAsync(buffer);
        try {
        using (var workbook = new XLWorkbook(new MemoryStream(buffer)))
        {
            var worksheet = workbook.Worksheets.First();
            worksheetData = worksheet.RangeUsed().Rows().Select(r => r.Cells().Select(c => c.Value).ToList()).ToList();
        }
        foreach (var row in worksheetData.Skip(1)) {
            //foreach (var cell in row)
               // {
                 // motorParameterModel.MotorModel = cell.ToString();
                 // Logger.LogInformation("电机型号 = {motorModel}", motorParameterModel.MotorModel);
                 // motorParameterModel.FactoryNumber = cell.ToString();
                //}
                        motorParameterModel = new MotorParameterModel(DateTime.Now, DateTime.Now);
                        motorParameterModel.MotorModel = row[0].ToString();
                       // Logger.LogInformation("电机型号 = {motorModel}", motorParameterModel.MotorModel);
                        motorParameterModel.FactoryNumber = row[1].ToString();
                       // Logger.LogInformation("出厂编号 = {FactoryNumber}", motorParameterModel.FactoryNumber);
                        motorParameterModel.MotorPhases = row[2].ToString();
                        motorParameterModel.POLENUMBER = int.Parse(row[3].ToString());
                        motorParameterModel.ZLCode = row[4].ToString();
                        motorParameterModel.SerialNumber = row[5].ToString();
                        motorParameterModel.RatedPower = double.Parse(row[7].ToString());
                        motorParameterModel.RatedFrequency =double.Parse(row[8].ToString());
                        motorParameterModel.RatedSpeed =double.Parse(row[9].ToString());
                        motorParameterModel.RatedVoltage = double.Parse(row[10].ToString());
                        motorParameterModel.RatedCurrent =double.Parse(row[11].ToString());
                        motorParameterModel.StatorResistance =double.Parse(row[12].ToString());
                        motorParameterModel.RotorResistance =double.Parse(row[13].ToString());
                        motorParameterModel.LeakageReactance =double.Parse(row[14].ToString());
                        motorParameterModel.MutualInductance =double.Parse(row[15].ToString());
                        motorParameterModel.NoLoadCurrent =double.Parse(row[16].ToString());
                        try{
                           //AddMotorParameter();

                           if (Busy) {
                               return;
                            }
                           Busy = true;

                            motorParameterModel.Status = MotorParameterStatus.Submitted;
                            Context.MotorParameters.Add(motorParameterModel);
                            Context.SaveChanges();
                        } catch (Microsoft.EntityFrameworkCore.DbUpdateException e ) {
                            bool? result = await DialogService.ShowMessageBox(
                               "错误",
                               "导入失败!该出厂编号"+motorParameterModel.FactoryNumber+"已存在，请先删除excel中的该出厂编号记录后，重新导入。",
                               yesText:"确认", cancelText:"取消");
                               state = result == null ? "Canceled" : "确认";
                               StateHasChanged();
                               Busy = false;
                               motorParameterModel = new MotorParameterModel(DateTime.Now, DateTime.Now);
                               motorParameterModel_list.Clear();
                               RefreshPage();
                               break;
                        }
                        import_count++;
                        motorParameterModel_list.Add(motorParameterModel);
                        qrCodeImageAsBase64_src_list.Add(generateQRcode());
                        qrCodeImageAsBase64_list.Add(generateQRcodeBase64());
                        //foreach (var qst in qrCodeImageAsBase64_src_list) {
                           // Logger.LogInformation("qrCodeImageAsBase64_src_list = {qst}", qst);
                        //}
                       Busy = false;
        }
      }
     finally
     {
        if ((import_count+1) == worksheetData.Count) {
                bool? result = await DialogService.ShowMessageBox(
                   "成功",
                   "导入成功！",
                   yesText:"确认", cancelText:"取消");
               state = result == null ? "Canceled" : "确认";
               StateHasChanged();
                motorParameterModel = new MotorParameterModel(DateTime.Now, DateTime.Now);
                Busy = false;
                //RefreshPage();
        } else if ( ((import_count+1) !=  worksheetData.Count) && (import_count > 0) ) {
             bool? result = await DialogService.ShowMessageBox(
                   "部分成功",
                   "导入成功"+import_count+ "条！"+ "失败" + (worksheetData.Count-1-import_count) + "条！",
                   yesText:"确认", cancelText:"取消");
               state = result == null ? "Canceled" : "确认";
               StateHasChanged();
                motorParameterModel = new MotorParameterModel(DateTime.Now, DateTime.Now);
                Busy = false;
                //RefreshPage();
        } else if (import_count == 0 ) {
             bool? result = await DialogService.ShowMessageBox(
                   "失败",
                   "全部导入失败",
                   yesText:"确认", cancelText:"取消");
               state = result == null ? "Canceled" : "确认";
               StateHasChanged();
                motorParameterModel = new MotorParameterModel(DateTime.Now, DateTime.Now);
                Busy = false;
                //RefreshPage();
        }

        stream.Dispose();
        _files.Clear();
        import_count = 0;
        motorParameterModel = new MotorParameterModel(DateTime.Now, DateTime.Now);
        Busy = false;
     }
    }

    private void OpenFindMotorParamterByFactoryNumberDialog()
    {
        _visible = true;
    }

   private void OpenPrintMotorParameterQRCoderDialog(){
        qrCodeImageAsBase64_src = generateQRcode();
        //Logger.LogInformation("qrCodeImageAsBase64_src = {qrCodeImageAsBase64_src}" , qrCodeImageAsBase64_src);

        _printMotorParameterQRCodervisible = true;
   }

   private void OpenBatchPrintMotorParameterQRCoderDialog(){
        _batchPrintMotorParameterQRCodervisible = true;
   }

  private string generateQRcode() {
      string qrCodeContent = "0001" +  FloatToHexConverter.FloatToHexString((float)motorParameterModel.RatedPower) + FloatToHexConverter.FloatToHexString((float)motorParameterModel.RatedFrequency) + FloatToHexConverter.FloatToHexString((float)motorParameterModel.RatedSpeed) + FloatToHexConverter.FloatToHexString((float)motorParameterModel.RatedVoltage) + FloatToHexConverter.FloatToHexString((float)motorParameterModel.RatedCurrent) + FloatToHexConverter.FloatToHexString((float)motorParameterModel.StatorResistance) + FloatToHexConverter.FloatToHexString((float)motorParameterModel.RotorResistance) + FloatToHexConverter.FloatToHexString((float)motorParameterModel.LeakageReactance) + FloatToHexConverter.FloatToHexString((float)motorParameterModel.MutualInductance) + FloatToHexConverter.FloatToHexString((float)motorParameterModel.NoLoadCurrent);
        Logger.LogInformation("qrCodeContent = {qrCodeContent}", qrCodeContent);
        string qrCodeContentBASE64 = motorParameterModel.ZLCode + "&" +motorParameterModel.SerialNumber + "&" +  Base64EncodingUtil.EncodeHexStringToBase64(qrCodeContent).Replace("+", "-").Replace("/", "_");
        Logger.LogInformation("qrCodeContentBASE64 = {qrCodeContentBASE64}", qrCodeContentBASE64);

        //Console.Write(b.ToString("X2") + " ");
        //Console.WriteLine("四字节十六进制表示:" + qrCodeContent);

        QRCodeGenerator qrGenerator = new QRCodeGenerator();
        QRCodeData qrCodeData = qrGenerator.CreateQrCode(qrCodeContentBASE64, QRCodeGenerator.ECCLevel.M);

        var imgType = Base64QRCode.ImageType.Png;
        Base64QRCode qrCode = new Base64QRCode(qrCodeData);
        string qrCodeImageAsBase64 = qrCode.GetGraphic(20, "#000000", "#ffffff", true, imgType);
        //Logger.LogInformation("qrCodeImageAsBase64 = {qrCodeImageAsBase64}", qrCodeImageAsBase64);
        qrCodeImageAsBase64_src = "data:image/" + imgType.ToString().ToLower() + ";base64," + qrCodeImageAsBase64;
        //Logger.LogInformation("qrCodeImageAsBase64_src = {qrCodeImageAsBase64_src}" , qrCodeImageAsBase64_src);
        return qrCodeImageAsBase64_src;
  }

    private async Task FindMotorParameterByFactoryNumberAsync() {
        if (Busy) {
            return;
        }

        Busy = true;
        modifydisabled = true;
        deletedisabled = true;

           if (factoryNumber is null) {
                bool? result = await DialogService.ShowMessageBox(
                   "警告",
                   "查询前请输入出厂编号。",
                   yesText:"确认", cancelText:"取消");
                state = result == null ? "取消" : "确认";
                StateHasChanged();

                modifydisabled = true;
                deletedisabled = true;
            } else {
              try {
              MotorParameterModel motorp =  Context.MotorParameters.Single(b => b.FactoryNumber == factoryNumber);
              motorParameterModel.Id=motorp.Id;
              motorParameterModel.Company=motorp.Company;
              motorParameterModel.MotorModel=motorp.MotorModel;
              motorParameterModel.FactoryNumber=motorp.FactoryNumber;
              motorParameterModel.MotorPhases=motorp.MotorPhases;
              motorParameterModel.POLENUMBER=motorp.POLENUMBER;
              motorParameterModel.ZLCode=motorp.ZLCode;
              motorParameterModel.SerialNumber=motorp.SerialNumber;
              motorParameterModel.RatedPower=motorp.RatedPower;
              motorParameterModel.RatedFrequency=motorp.RatedFrequency;
              motorParameterModel.RatedSpeed=motorp.RatedSpeed;
              motorParameterModel.RatedVoltage=motorp.RatedVoltage;
              motorParameterModel.RatedCurrent=motorp.RatedCurrent;
              motorParameterModel.StatorResistance=motorp.StatorResistance;
              motorParameterModel.RotorResistance=motorp.RotorResistance;
              motorParameterModel.LeakageReactance=motorp.LeakageReactance;
              motorParameterModel.MutualInductance=motorp.MutualInductance;
              motorParameterModel.NoLoadCurrent=motorp.NoLoadCurrent;
              motorParameterModel.Selected=motorp.Selected;
              motorParameterModel.OwnerID=motorp.OwnerID;
              motorParameterModel.Status=motorp.Status;
              motorParameterModel.AddTime=motorp.AddTime;
              motorParameterModel.ModifyTime=motorp.ModifyTime;
              addtimedate = motorp.AddTime.Date;
              addtimespan = new TimeSpan(motorp.AddTime.Hour, motorp.AddTime.Minute, motorp.AddTime.Second);
              modifytimedate = motorp.ModifyTime?.Date;
              modifytimespan = new TimeSpan(motorp.ModifyTime?.Hour?? default(int), motorp.ModifyTime?.Minute?? default(int), motorp.ModifyTime?.Second?? default(int) );

              //var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
              //var user = authState.User;
              //var isAuthorized = await AuthorizationService.AuthorizeAsync(
                                                        //user, recbill,
                                                        //RecbillOperations.Read);
              //if (!isAuthorized.Succeeded)
              //{
                //recbill = new RecBillModel( DateTime.Now, DateTime.Now, DateTime.Now, DateTime.Now, DateTime.Now );
                //var dialog = await DialogService.ShowErrorAsync("当前用户没有查询该数据的权限。" );
                //var result = await dialog.Result;
                //recbill = new RecBillModel(DateTime.Now, DateTime.Now, DateTime.Now, DateTime.Now, DateTime.Now);
              //} else {
                  modifydisabled = false;
                  deletedisabled = false;
              //}
            } catch (System.InvalidOperationException e ) {
                bool? result = await DialogService.ShowMessageBox(
                   "错误",
                   "该电机参数不存在。",
                   yesText:"确认", cancelText:"取消");
                state = result == null ? "取消" : "确认";
                StateHasChanged();

              motorParameterModel = new MotorParameterModel(DateTime.Now, DateTime.Now);
              modifydisabled = true;
              deletedisabled = true;
              Busy = false;
             }
          }

                formdisabled = true;
                submitdisabled = true;
                cansledisabled = true;

                Busy = false;

        _visible = false;
    }

    private void Cancel() {
         _visible = false;
    }

    private void printMotorParameterQRCoderCancel() {
         _printMotorParameterQRCodervisible = false;
    }

    private void batchPrintMotorParameterQRCoderCancel() {
         _batchPrintMotorParameterQRCodervisible = false;
    }

    protected override async Task OnInitializedAsync()
    {
           Busy = true;

           Context = DbFactory.CreateDbContext();

           Busy = false;

           await base.OnInitializedAsync();
           // ... 其他初始化代码
           motorParameterCompany = "1";
           motorParameterModel.Company = MotorParameterCompany.江西江特;

     }

     private  async Task  addMotorParameterAsync(){
        //var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        //var user = authState.User;

        //recbill.OwnerID = UserManager.GetUserId(user);
        //var isAuthorized = await AuthorizationService.AuthorizeAsync(
        //                                                                                              user, recbill,
        //                                                                                              RecbillOperations.Create);
        //if (!isAuthorized.Succeeded)
        //{
           //var dialog = await DialogService.ShowErrorAsync("当前用户没有新建权限。" );
           //var result = await dialog.Result;
        //} else {
        formdisabled = false;
        submitdisabled = false;
        cansledisabled = false;
        ismodifybutton = false;
        modifydisabled = true;
        deletedisabled = true;
        finddisabled = true;
        motorParameterModel = new MotorParameterModel(DateTime.Now, DateTime.Now);
        motorParameterCompany = "1";
        motorParameterModel.Company = MotorParameterCompany.江西江特;
     //}
    }

    private  void cansleSubmit(){
        if (ismodifybutton == false ) {
        formdisabled = true;
        submitdisabled = true;
        cansledisabled = true;
        modifydisabled = true;
        deletedisabled = true;
        finddisabled = false;
        motorParameterModel = new MotorParameterModel(DateTime.Now, DateTime.Now);
        }

        if (ismodifybutton == true ) {
        formdisabled = true;
        submitdisabled = true;
        cansledisabled = true;
        modifydisabled = false;
        deletedisabled = false;
        finddisabled = false;
        }
    }

    private async Task  modifyMotorParameterByFactoryNumberAndId(){
        //var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        //var user = authState.User;

        //var isAuthorized = await AuthorizationService.AuthorizeAsync(
                                                        //user, recbill,
                                                        //RecbillOperations.Update);
        //if (!isAuthorized.Succeeded)
        //{
           //var dialog = await DialogService.ShowErrorAsync("当前用户没有修改权限。" );
           //var result = await dialog.Result;
        //} else {
        formdisabled = false;
        submitdisabled = false;
        cansledisabled =false;
        ismodifybutton = true;
        modifydisabled = true;
        deletedisabled = true;
        finddisabled = true;
        Busy = false;
      //}
    }

   private async Task  deleteMotorParameterByFactoryNumberAndId() {
       //var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
       //var user = authState.User;

       //var isAuthorized = await AuthorizationService.AuthorizeAsync(
                                                        //user, recbill,
                                                        //RecbillOperations.Delete);
       //if (!isAuthorized.Succeeded)
       //{
               //var dialog = await DialogService.ShowErrorAsync("当前用户没有删除该数据权限。" );
               //var result = await dialog.Result;
       //} else {

       if (Busy) {
            return;
       }

        Busy = true;

                bool? result = await DialogService.ShowMessageBox(
                   "警告",
                   "确认删除吗?",
                   yesText:"确认", cancelText:"取消");
           state = result == null ? "取消" : "确认";
           StateHasChanged();

        if (result == true) {
            int count = 0 ;

            try {
                 var motorp = Context.MotorParameters.Single(b => b.FactoryNumber == motorParameterModel.FactoryNumber && b.Id==motorParameterModel.Id);
                 Context.MotorParameters.Remove(motorp);
                 count = Context.SaveChanges();
            } catch (Microsoft.EntityFrameworkCore.DbUpdateException e ) {
                bool? result2 = await DialogService.ShowMessageBox(
                        "错误",
                        "删除失败!该票据不存在。",
                        yesText:"确认", cancelText:"取消");
                    state = result == null ? "取消" : "确认";
                    StateHasChanged();

                Busy = false;
             }
             if (count>0) {
                bool? result2 = await DialogService.ShowMessageBox(
                        "成功",
                        "删除成功！",
                        yesText:"确认", cancelText:"取消");
                    state = result == null ? "取消" : "确认";
                    StateHasChanged();

               submitdisabled = true;
               cansledisabled = true;
               modifydisabled = true;
               deletedisabled = true;
                           motorParameterModel = new MotorParameterModel(DateTime.Now, DateTime.Now);

               Busy = false;
             }
        }

        if (result == false) {
              submitdisabled = true;
              cansledisabled = true;
        }

        Busy = false;
     //}
   }

    private async Task OnValidSubmitAsync(EditContext context)
    {
        Logger.LogInformation("中联编码 = {ZLCode}", motorParameterModel?.ZLCode);

        if (ismodifybutton == false) {
            if (Busy) {
                return;
            }
            Busy = true;

            //var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            //var user = authState.User;

            //recbill.OwnerID = UserManager.GetUserId(user);

            //var isAuthorized = await AuthorizationService.AuthorizeAsync(
                                                        //user, recbill,
                                                        //RecbillOperations.Create);
            //if (!isAuthorized.Succeeded)
            //{
              //var dialog = await DialogService.ShowErrorAsync("当前用户没有新建权限。" );
              //var result = await dialog.Result;
            //} else {

           int count = 0 ;

           try {
                 motorParameterModel.Status = MotorParameterStatus.Submitted;
                 Context.MotorParameters.Add(motorParameterModel);
                 count = Context.SaveChanges();
            } catch (Microsoft.EntityFrameworkCore.DbUpdateException e ) {
                bool? result = await DialogService.ShowMessageBox(
                   "错误",
                   "保存失败!该电机参数已存在。",
                   yesText:"确认", cancelText:"取消");
               state = result == null ? "Canceled" : "确认";
               StateHasChanged();

                finddisabled = false;
                modifydisabled = true;
                deletedisabled = true;
                submitdisabled = true;
                cansledisabled = true;
                formdisabled = true;
                Busy = false;
             }
             if (count>0) {
                bool? result = await DialogService.ShowMessageBox(
                   "成功",
                   "保存成功！",
                   yesText:"确认", cancelText:"取消");
               state = result == null ? "Canceled" : "确认";
               StateHasChanged();

                finddisabled = false;
                modifydisabled = true;
                deletedisabled = true;
                submitdisabled = true;
                cansledisabled = true;
                formdisabled = true;
                motorParameterModel = new MotorParameterModel(DateTime.Now, DateTime.Now);
                Busy = false;
             }
             //}

             Busy = false;
        }

       if (ismodifybutton == true) {
            if (Busy) {
                  return;
            }

           Busy = true;
           int count = 0 ;

           try {
                  //var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                  //var user = authState.User;

                  //var isAuthorized = await AuthorizationService.AuthorizeAsync(
                                                        //user, recbill,
                                                        //RecbillOperations.Update);
                  //if (!isAuthorized.Succeeded)
                  //{
                   //var dialog = await DialogService.ShowErrorAsync("当前用户没有修改权限。" );
                   //var result = await dialog.Result;
                  //} else {
                var motorp = Context.MotorParameters.Single(b => b.FactoryNumber == motorParameterModel.FactoryNumber && b.Id==motorParameterModel.Id);
                motorp.Company = motorParameterModel.Company;
                motorp.MotorModel = motorParameterModel.MotorModel;
                motorp.MotorPhases = motorParameterModel.MotorPhases;
                motorp.POLENUMBER = motorParameterModel.POLENUMBER;
                motorp.ZLCode = motorParameterModel.ZLCode;
                motorp.SerialNumber = motorParameterModel.SerialNumber;
                motorp.RatedPower = motorParameterModel.RatedPower;
                motorp.RatedFrequency = motorParameterModel.RatedFrequency;
                motorp.RatedSpeed = motorParameterModel.RatedSpeed;
                motorp.RatedVoltage = motorParameterModel.RatedVoltage;
                motorp.RatedCurrent = motorParameterModel.RatedCurrent;
                motorp.StatorResistance = motorParameterModel.StatorResistance;
                motorp.RotorResistance = motorParameterModel.RotorResistance;
                motorp.LeakageReactance = motorParameterModel.LeakageReactance;
                motorp.MutualInductance = motorParameterModel.MutualInductance;
                motorp.NoLoadCurrent = motorParameterModel.NoLoadCurrent;
                motorp.ModifyTime = DateTime.Now;
                                modifytimedate = DateTime.Now;
                                modifytimespan = new TimeSpan(DateTime.Now.Hour, DateTime.Now.Minute, DateTime.Now.Second);
                count = Context.SaveChanges();
               //}
            } catch (Microsoft.EntityFrameworkCore.DbUpdateException e ) {
                 bool? result = await DialogService.ShowMessageBox(
                   "错误",
                   "保存失败。",
                   yesText:"确认", cancelText:"取消");
                state = result == null ? "Canceled" : "确认";
                StateHasChanged();

                Busy = false;
             }
             if (count>0) {
                bool? result = await DialogService.ShowMessageBox(
                   "成功",
                   "保存成功！",
                   yesText:"确认", cancelText:"取消");
               state = result == null ? "Canceled" : "确认";
               StateHasChanged();

                submitdisabled = true;
                cansledisabled = true;
                modifydisabled = true;
                deletedisabled = true;
                finddisabled = false;
                motorParameterModel = new MotorParameterModel(DateTime.Now, DateTime.Now);
                Busy = false;
             }

          Busy = false;
        }
         Busy = false;
     }

  private async Task printMotorParameterQRCoderAsync(ElementReference elementReference) {
        var jsObjectRef = DotNetObjectReference.Create(this);
        await JSRuntime.InvokeVoidAsync("printContent", elementReference, jsObjectRef);
        motorParameterModel_list.Clear();
        RefreshPage();
   }

  private void RefreshPage()
    {
        NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
    }

   public void Dispose()
    {
       Context?.Dispose();
    }

}
```

[root@cpzljc wwwroot]# cat downloadPdf.js
```js
//function downloadPdf(bytesBase64) {
    //var linkSource = `data:application/pdf;base64,${bytesBase64}`;
    //var downloadLink = document.createElement("a");
    //document.body.appendChild(downloadLink);
    //downloadLink.href = linkSource;
    //downloadLink.download = "批量打印电机参数二维码.pdf"; // 文件名称为 example.pdf，可根据需要更改。
    //downloadLink.click();
    //document.body.removeChild(downloadLink); // 清理DOM。
//}

function downloadPdf(bytesBase64) {
    try {
        // 将 Base64 转换为字节数组
        const byteCharacters = atob(bytesBase64);
        const byteArray = new Uint8Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteArray[i] = byteCharacters.charCodeAt(i);
        }

        // 创建 Blob 并生成下载链接
        const blob = new Blob([byteArray], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);

        const downloadLink = document.createElement('a');
        downloadLink.href = url;
        downloadLink.download = "批量打印电机参数二维码.pdf"; // 文件名

        // 触发下载
        document.body.appendChild(downloadLink);
        downloadLink.click();

        // 清理资源
        document.body.removeChild(downloadLink);
        URL.revokeObjectURL(url); // 释放 Object URL
    } catch (error) {
        console.error('下载失败:', error);
        alert('下载失败，请查看控制台日志。');
    }
}
```

[root@cpzljc Data]# cat MotorParameterModel.cs 
```csharp
using System.ComponentModel.DataAnnotations;
using Microsoft.EntityFrameworkCore;

namespace ccjyapp.Data ;

[Index(nameof(FactoryNumber), IsUnique = true)]
public class MotorParameterModel
{

  public MotorParameterModel() {}

  public MotorParameterModel(DateTime addtime , DateTime modifytime) {
        this.AddTime = addtime;
        this.ModifyTime = modifytime;
   }

   public int Id { get; set; }

   [Required]
   public MotorParameterCompany Company { get; set; }

   [Required]
   [StringLength(30,
        ErrorMessage = "电机型号长度最长为30位")]
   public string MotorModel { get; set; }

   [Required]
   [StringLength(20,
        ErrorMessage = "出厂编号长度最长为20位")]
   public string FactoryNumber { get; set; }

   [Required]
   [Comment("电机相数")]
   [StringLength(10,
        ErrorMessage = "电机相数长度最长为10位")]
   public string MotorPhases { get; set; }

   [Required]
   public int POLENUMBER { get; set; }

   [Required]
   [Comment("中联编码")]
   [StringLength(10,
        ErrorMessage = "中联编码长度最长为10位")]
   public string ZLCode { get; set; }

    [Required]
    [StringLength(11,
        ErrorMessage = "生产编码长度最长为11位")]
    public string SerialNumber { get; set; }

    [Required]
    public double RatedPower { get; set; }

    [Required]
    public double RatedFrequency { get; set; }

    [Required]
    public double RatedSpeed { get; set; }

    [Required]
    public double RatedVoltage { get; set; }

    [Required]
    public double RatedCurrent { get; set; }

    [Required]
    public double StatorResistance { get; set; }

    [Required]
    public double RotorResistance { get; set; }

    [Required]
    public double LeakageReactance { get; set; }

    [Required]
    public double MutualInductance { get; set; }

    [Required]
    public double NoLoadCurrent { get; set; }

    public bool Selected { get; set; }

    // user ID from AspNetUser table.
    public string? OwnerID { get; set; }

    [Required]
    public MotorParameterStatus Status { get; set; }

    [Required]
    public DateTime AddTime { get; set; }

    public DateTime? ModifyTime { get; set; }


    /*
    [Range(1, 100000,
        ErrorMessage = "Accommodation invalid (1-100000).")]
    public int MaximumAccommodation { get; set; }

    [Required]
    [Range(typeof(bool), "true", "true",
        ErrorMessage = "This form disallows unapproved ships.")]
    public bool IsValidatedDesign { get; set; }

    [Required]
    public DateTime ProductionDate { get; set; }
    */
}

public enum MotorParameterStatus
{
    Submitted,
    Approved,
    Rejected
}

public enum MotorParameterCompany
{
   江特电机,
   江西江特,
   银锂新能源,
   杭州米格,
   天津华兴,
   宜丰锂业,
   泰昌矿业,
   江特电动车,
   江特客车厂,
   尉尔江西电机有限公司,
   江特高新装备公司,
   江特高新武汉分公司
}
```

[root@cpzljc Data]# cat ApplicationDbContext.cs 
```csharp
using Microsoft.AspNetCore.Identity.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore;

namespace ccjyapp.Data;

public class ApplicationDbContext(DbContextOptions<ApplicationDbContext> options) : IdentityDbContext<ApplicationUser>(options)
{
        public DbSet<MotorParameterModel> MotorParameters { get; set; }
}
```

[root@cpzljc Data]# cat Browser.cs 
```csharp
public interface IBrowser
{
    int Width { get; set; }
}

public class Browser : IBrowser
{
    public int Width { get; set; }
}
```

[root@cpzljc Pages]# cat TCpzljcPage.razor 
```csharp
@page "/tcpzljc"

@inject ILogger<TCpzljc> Logger
@inject IDbContextFactory<CpzljcDbContext> DbFactory
@inject IDialogService DialogService
@inject IAuthorizationService AuthorizationService
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime
@using ClosedXML.Excel
@inject NavigationManager NavigationManager
@inject IBrowser Browser
@using System.Globalization

@using System.ComponentModel.DataAnnotations
@using ccjyapp.Data
@using System
@using System.IO
@using Microsoft.AspNetCore.Components
@using System.Threading.Tasks
@using Microsoft.EntityFrameworkCore


<PageTitle>50亩出厂检验设备数据</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="mt-4">
    <MudPaper Elevation="0" Class="mb-4">
        <MudText Typo="Typo.h4" Color="Color.Primary" Class="mb-2 mobile-title">电机出厂检验数据</MudText>
        <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mobile-subtitle">查看和管理电机检验记录</MudText>
    </MudPaper>

    <MudPaper Class="pa-4" Elevation="2">
        <MudTable T="TCpzljc" Dense="@dense" Hover="true" Loading="@loading"
                  LoadingProgressColor="Color.Info" 
                  Breakpoint="Breakpoint.Sm"
                  @bind-RowsPerPage="pageSize" 
                  FixedHeader="true"
                  Height="@(IsMobile ? "calc(100vh - 200px)" : "calc(100vh - 300px)")"
                  Style="overflow-x: auto;"
                  ServerData="@(new Func<TableState, CancellationToken, Task<TableData<TCpzljc>>>(ServerReload))"
                  @ref="table"
                  Virtualize="true"
                  ResponsiveTable="true">
            <ToolBarContent>
                <MudGrid Spacing="1">
                    <MudItem>                
                        <MudToggleIconButton @bind-Toggled="@dense"
                                            Icon="@Icons.Material.Filled.TableRows" 
                                            Color="@Color.Default"
                                            Title="密集模式"
                                            Size="Size.Medium"
                                            ToggledIcon="@Icons.Material.Filled.TableChart" 
                                            ToggledColor="@Color.Primary" />
                    </MudItem>
                    <MudItem>
                        <div class="mud-date-picker-container">  
                            <label class="mud-date-picker-label">开始日期</label>                                                
                            <MudDatePicker 
                                    Placeholder="起始日期"
                                    DateFormat="yyyy-MM-dd"
                                    Clearable="true"                                                                                                        
                                    AdornmentColor="Color.Primary"                                                                                                                                                                                
                                    Date="startDate"
                                    DateChanged="OnStartDateChanged" />
                        </div>
                    </MudItem>
                    <MudItem> 
                        <div class="mud-date-picker-container">  
                            <label class="mud-date-picker-label">结束日期</label>               
                            <MudDatePicker 
                                Placeholder="结束日期"
                                DateFormat="yyyy-MM-dd"
                                Clearable="true"
                                Size="Size.Medium"
                                Style="min-width: 200px;"
                                AdornmentColor="Color.Primary"
                                Margin="Margin.Dense"
                                PickerVariant="PickerVariant.Dialog"
                                DisableToolbar="false"
                                OpenIcon="@Icons.Material.Filled.CalendarMonth"
                                Date="endDate"
                                DateChanged="OnEndDateChanged" />
                        </div>
                    </MudItem>                                            
                    <MudItem>
                        <MudTextField @bind-Value="searchString" 
                                        Placeholder="搜索..." 
                                        Adornment="Adornment.Start"
                                        AdornmentIcon="@Icons.Material.Filled.Search" 
                                        IconSize="Size.Medium"
                                        Style="width: 300px;"
                                        Immediate="true"
                                        DebounceInterval="300"
                                        OnKeyDown="@OnKeyDown"
                                        OnDebounceIntervalElapsed="@(()=>OnSearch())" />
                    </MudItem>
                    <MudItem>           
                        <MudButton Variant="Variant.Filled" 
                                    Color="Color.Primary"
                                    Size="Size.Medium"
                                    OnClick="ExportToExcel"
                                    StartIcon="@Icons.Material.Filled.FileDownload"
                                    Style="width: 140px;">
                            导出Excel
                        </MudButton>
                    </MudItem>                                                                       
                </MudGrid>
            </ToolBarContent>

            <HeaderContent>
                @foreach (var header in tableHeaders)
                {
                    <MudTh Style="@($"min-width: {header.MinWidth}px; white-space: nowrap;")">@header.Label</MudTh>
                }
            </HeaderContent>

            <RowTemplate>
                <MudTd DataLabel="测试时间" Style="white-space: nowrap;">@context.测试时间</MudTd>
                <MudTd DataLabel="电机型号" Style="white-space: nowrap;">@context.电机型号</MudTd>
                <MudTd DataLabel="出厂编号" Style="white-space: nowrap;">@context.出厂编号</MudTd>
                <MudTd DataLabel="电机相数" Style="white-space: nowrap;">@context.电机相数</MudTd>
                <MudTd DataLabel="测试日期" Style="white-space: nowrap;">@(context.测试日期?.ToString("yyyy-MM-dd"))</MudTd>
                <MudTd DataLabel="电阻1" Style="white-space: nowrap;">@context.电阻1</MudTd>
                <MudTd DataLabel="电阻2" Style="white-space: nowrap;">@context.电阻2</MudTd>
                <MudTd DataLabel="电阻3" Style="white-space: nowrap;">@context.电阻3</MudTd>
                <MudTd DataLabel="标准温度" Style="white-space: nowrap;">@context.标准温度</MudTd>
                <MudTd DataLabel="电阻平衡度" Style="white-space: nowrap;">@context.电阻平衡度</MudTd>
                <MudTd DataLabel="绝缘电阻" Style="white-space: nowrap;">@context.绝缘电阻</MudTd>
                <MudTd DataLabel="匝间电压" Style="white-space: nowrap;">@context.匝间电压</MudTd>
                <MudTd DataLabel="匝间测试结果" Style="white-space: nowrap;">@context.匝间测试结果</MudTd>
                <MudTd DataLabel="堵转电压1" Style="white-space: nowrap;">@context.堵转电压1</MudTd>
                <MudTd DataLabel="堵转电压2" Style="white-space: nowrap;">@context.堵转电压2</MudTd>
                <MudTd DataLabel="堵转电压3" Style="white-space: nowrap;">@context.堵转电压3</MudTd>
                <MudTd DataLabel="堵转电压" Style="white-space: nowrap;">@context.堵转电压</MudTd>
                <MudTd DataLabel="堵转电流1" Style="white-space: nowrap;">@context.堵转电流1</MudTd>
                <MudTd DataLabel="堵转电流2" Style="white-space: nowrap;">@context.堵转电流2</MudTd>
                <MudTd DataLabel="堵转电流3" Style="white-space: nowrap;">@context.堵转电流3</MudTd>
                <MudTd DataLabel="堵转电流" Style="white-space: nowrap;">@context.堵转电流</MudTd>
                <MudTd DataLabel="堵转平衡度" Style="white-space: nowrap;">@context.堵转平衡度</MudTd>
                <MudTd DataLabel="堵转功率" Style="white-space: nowrap;">@context.堵转功率</MudTd>
                <MudTd DataLabel="空载电压1" Style="white-space: nowrap;">@context.空载电压1</MudTd>
                <MudTd DataLabel="空载电压2" Style="white-space: nowrap;">@context.空载电压2</MudTd>
                <MudTd DataLabel="空载电压3" Style="white-space: nowrap;">@context.空载电压3</MudTd>
                <MudTd DataLabel="空载电压" Style="white-space: nowrap;">@context.空载电压</MudTd>
                <MudTd DataLabel="空载电流1" Style="white-space: nowrap;">@context.空载电流1</MudTd>
                <MudTd DataLabel="空载电流2" Style="white-space: nowrap;">@context.空载电流2</MudTd>
                <MudTd DataLabel="空载电流3" Style="white-space: nowrap;">@context.空载电流3</MudTd>
                <MudTd DataLabel="空载电流" Style="white-space: nowrap;">@context.空载电流</MudTd>
                <MudTd DataLabel="空载平衡度" Style="white-space: nowrap;">@context.空载平衡度</MudTd>
                <MudTd DataLabel="空载功率" Style="white-space: nowrap;">@context.空载功率</MudTd>
                <MudTd DataLabel="频率" Style="white-space: nowrap;">@context.频率</MudTd>
                <MudTd DataLabel="转向" Style="white-space: nowrap;">@context.转向</MudTd>
                <MudTd DataLabel="噪声" Style="white-space: nowrap;">@context.噪声</MudTd>
                <MudTd DataLabel="振动x轴" Style="white-space: nowrap;">@context.振动x轴</MudTd>
                <MudTd DataLabel="振动y轴" Style="white-space: nowrap;">@context.振动y轴</MudTd>
                <MudTd DataLabel="振动z轴" Style="white-space: nowrap;">@context.振动z轴</MudTd>
                <MudTd DataLabel="定子电阻" Style="white-space: nowrap;">@context.定子电阻</MudTd>
                <MudTd DataLabel="转子电阻" Style="white-space: nowrap;">@context.转子电阻</MudTd>
                <MudTd DataLabel="漏感抗" Style="white-space: nowrap;">@context.漏感抗</MudTd>
                <MudTd DataLabel="互感抗" Style="white-space: nowrap;">@context.互感抗</MudTd>
                <MudTd DataLabel="变频空载电流" Style="white-space: nowrap;">@context.变频空载电流</MudTd>
                <MudTd DataLabel="微动开关" Style="white-space: nowrap;">@context.微动开关</MudTd>
                <MudTd DataLabel="耐压电压" Style="white-space: nowrap;">@context.耐压电压</MudTd>
                <MudTd DataLabel="耐压泄漏" Style="white-space: nowrap;">@context.耐压泄漏</MudTd>
                <MudTd DataLabel="测试结果" Style="white-space: nowrap;">@context.测试结果</MudTd>
                <MudTd DataLabel="测试结论" Style="white-space: nowrap;">@context.测试结论</MudTd>
                <MudTd DataLabel="测试员" Style="white-space: nowrap;">@context.测试员</MudTd>
            </RowTemplate>

            <PagerContent>
                <MudTablePager PageSizeOptions="@(IsMobile ? new int[] { 5000 } : new int[] { 5000 })" />
            </PagerContent>
        </MudTable>
    </MudPaper>
</MudContainer>

<MudDialog @bind-IsVisible="showProgress" DisableSidePadding="true" Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">导出进度</MudText>
    </TitleContent>
    <DialogContent>
        <MudProgressLinear Color="Color.Primary" Value="@exportProgress" Class="my-4" />
        <MudText>已处理 @exportProgress%</MudText>
    </DialogContent>
</MudDialog>
	
@code {            
    private IEnumerable<TCpzljc> pagedData = new List<TCpzljc>();
    private bool loading = true;
    private string searchString = "";
    private int totalItems;
    private int pageSize = 5000;
    private MudTable<TCpzljc> table;
    private bool dense = true;
    private bool IsMobile => Browser.Width < 640;
    private DateTime? startDate;
    private DateTime? endDate;
    private bool showProgress;
    private double exportProgress;
    private readonly DialogOptions dialogOptions = new() { BackdropClick = false, NoHeader = false };
    private const int BatchSize = 20000; // 每批处理的数据量
    
    protected override async Task OnInitializedAsync()
    {
        // 设置默认日期范围为最近一年
        endDate = DateTime.Today;
        startDate = endDate.Value.AddYears(-1);
        
        pageSize = 5000;
        await LoadData();
    }

    private async Task LoadData()
    {
        if (table != null)
            await table.ReloadServerData();
    }

    private async Task<TableData<TCpzljc>> ServerReload(TableState state, CancellationToken cancellationToken)
    {
        loading = true;
        await using var context = await DbFactory.CreateDbContextAsync(cancellationToken);
        
        IQueryable<TCpzljc> query = context.TCpzljcs;

        // 修改日期查询逻辑
        if (startDate.HasValue || endDate.HasValue)
        {
            if (startDate.HasValue && endDate.HasValue)
            {
                var start = startDate.Value.Date;
                var end = endDate.Value.Date.AddDays(1).AddSeconds(-1);
                query = query.Where(x => x.测试日期.HasValue && 
                                       x.测试日期.Value >= start && 
                                       x.测试日期.Value <= end);
            }
            else if (startDate.HasValue)
            {
                var start = startDate.Value.Date;
                query = query.Where(x => x.测试日期.HasValue && 
                                       x.测试日期.Value >= start);
            }
            else if (endDate.HasValue)
            {
                var end = endDate.Value.Date.AddDays(1).AddSeconds(-1);
                query = query.Where(x => x.测试日期.HasValue && 
                                       x.测试日期.Value <= end);
            }
        }
        else
        {
            // 如果没有选择日期范围，默认显示最近一年的数据
            var oneYearAgo = DateTime.Today.AddYears(-1);
            query = query.Where(x => x.测试日期.HasValue && 
                                   x.测试日期.Value >= oneYearAgo);
        }

        if (!string.IsNullOrWhiteSpace(searchString))
        {
            query = query.Where(x => 
                (x.电机型号 != null && x.电机型号.Contains(searchString)) ||
                (x.出厂编号 != null && x.出厂编号.Contains(searchString)) ||
                (x.测试员 != null && x.测试员.Contains(searchString)) ||
                (x.测试结果 != null && x.测试结果.Contains(searchString)) ||
                (x.测试结论 != null && x.测试结论.Contains(searchString)));
        }

        totalItems = await query.CountAsync(cancellationToken);

        pagedData = await query
            .Skip(state.Page * state.PageSize)
            .Take(state.PageSize)
            .ToListAsync(cancellationToken);

        loading = false;

        return new TableData<TCpzljc>() { TotalItems = totalItems, Items = pagedData };
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await OnSearch();
        }
    }

    private async Task OnSearch()
    {
        if (table != null)
        {
            await table.ReloadServerData();
            StateHasChanged();
        }
    }    
    
    
    //protected override async Task OnInitializedAsync()
    //{  
	//   Busy = true;

	  // Context = DbFactory.CreateDbContext();

	   // Busy = false;

	   // await base.OnInitializedAsync();
	   // ... 其他初始化代码	   
                              
     //}       
        
   private void RefreshPage()
    {
        NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true);
    }
   
   //public void Dispose()
    //{
       //Context?.Dispose();
    //}

    // 定义表头和最小宽度
    private class TableHeader
    {
        public string Label { get; set; }
        public int MinWidth { get; set; }
    }

    private List<TableHeader> tableHeaders = new()
    {
        new TableHeader { Label = "测试时间", MinWidth = 120 },
        new TableHeader { Label = "电机型号", MinWidth = 120 },
        new TableHeader { Label = "出厂编号", MinWidth = 120 },
        new TableHeader { Label = "电机相数", MinWidth = 100 },
        new TableHeader { Label = "测试日期", MinWidth = 100 },
        new TableHeader { Label = "电阻1", MinWidth = 80 },
        new TableHeader { Label = "电阻2", MinWidth = 80 },
        new TableHeader { Label = "电阻3", MinWidth = 80 },
        new TableHeader { Label = "标准温度", MinWidth = 100 },
        new TableHeader { Label = "电阻平衡度", MinWidth = 100 },
        new TableHeader { Label = "绝缘电阻", MinWidth = 100 },
        new TableHeader { Label = "匝间电压", MinWidth = 100 },
        new TableHeader { Label = "匝间测试结果", MinWidth = 120 },
        new TableHeader { Label = "堵转电压1", MinWidth = 100 },
        new TableHeader { Label = "堵转电压2", MinWidth = 100 },
        new TableHeader { Label = "堵转电压3", MinWidth = 100 },
        new TableHeader { Label = "堵转电压", MinWidth = 100 },
        new TableHeader { Label = "堵转电流1", MinWidth = 100 },
        new TableHeader { Label = "堵转电流2", MinWidth = 100 },
        new TableHeader { Label = "堵转电流3", MinWidth = 100 },
        new TableHeader { Label = "堵转电流", MinWidth = 100 },
        new TableHeader { Label = "堵转平衡度", MinWidth = 100 },
        new TableHeader { Label = "堵转功率", MinWidth = 100 },
        new TableHeader { Label = "空载电压1", MinWidth = 100 },
        new TableHeader { Label = "空载电压2", MinWidth = 100 },
        new TableHeader { Label = "空载电压3", MinWidth = 100 },
        new TableHeader { Label = "空载电压", MinWidth = 100 },
        new TableHeader { Label = "空载电流1", MinWidth = 100 },
        new TableHeader { Label = "空载电流2", MinWidth = 100 },
        new TableHeader { Label = "空载电流3", MinWidth = 100 },
        new TableHeader { Label = "空载电流", MinWidth = 100 },
        new TableHeader { Label = "空载平衡度", MinWidth = 100 },
        new TableHeader { Label = "空载功率", MinWidth = 100 },
        new TableHeader { Label = "频率", MinWidth = 80 },
        new TableHeader { Label = "转向", MinWidth = 80 },
        new TableHeader { Label = "噪声", MinWidth = 80 },
        new TableHeader { Label = "振动x轴", MinWidth = 100 },
        new TableHeader { Label = "振动y轴", MinWidth = 100 },
        new TableHeader { Label = "振动z轴", MinWidth = 100 },
        new TableHeader { Label = "定子电阻", MinWidth = 100 },
        new TableHeader { Label = "转子电阻", MinWidth = 100 },
        new TableHeader { Label = "漏感抗", MinWidth = 100 },
        new TableHeader { Label = "互感抗", MinWidth = 100 },
        new TableHeader { Label = "变频空载电流", MinWidth = 120 },
        new TableHeader { Label = "微动开关", MinWidth = 100 },
        new TableHeader { Label = "耐压电压", MinWidth = 100 },
        new TableHeader { Label = "耐压泄漏", MinWidth = 100 },
        new TableHeader { Label = "测试结果", MinWidth = 100 },
        new TableHeader { Label = "测试结论", MinWidth = 120 },
        new TableHeader { Label = "测试员", MinWidth = 100 }
    };

    private async Task ClearSearch()
    {
        searchString = "";
        startDate = null;
        endDate = null;
        if (table != null)
        {
            await table.ReloadServerData();
            StateHasChanged();
        }
    }

    private async Task OnStartDateChanged(DateTime? date)
    {
        startDate = date;
        if (table != null)
        {
            await table.ReloadServerData();
            StateHasChanged();
        }
    }

    private async Task OnEndDateChanged(DateTime? date)
    {
        endDate = date;
        if (table != null)
        {
            await table.ReloadServerData();
            StateHasChanged();
        }
    }

    private async Task ExportToExcel()
    {
        try
        {
            loading = true;
            showProgress = true;
            exportProgress = 0;
            StateHasChanged();

            // 创建一个较长超时时间的CancellationTokenSource
            using var cts = new CancellationTokenSource();
            cts.CancelAfter(TimeSpan.FromMinutes(30)); // 设置30分钟超时

            await using var context = await DbFactory.CreateDbContextAsync(cts.Token);
            context.Database.SetCommandTimeout(TimeSpan.FromMinutes(30)); // 设置数据库命令超时时间
            
            IQueryable<TCpzljc> query = context.TCpzljcs;

            // 应用搜索条件
            if (startDate.HasValue || endDate.HasValue)
            {
                if (startDate.HasValue && endDate.HasValue)
                {
                    var start = startDate.Value.Date;
                    var end = endDate.Value.Date.AddDays(1).AddSeconds(-1);
                    query = query.Where(x => x.测试日期.HasValue && 
                                           x.测试日期.Value >= start && 
                                           x.测试日期.Value <= end);
                }
                else if (startDate.HasValue)
                {
                    var start = startDate.Value.Date;
                    query = query.Where(x => x.测试日期.HasValue && 
                                           x.测试日期.Value >= start);
                }
                else if (endDate.HasValue)
                {
                    var end = endDate.Value.Date.AddDays(1).AddSeconds(-1);
                    query = query.Where(x => x.测试日期.HasValue && 
                                           x.测试日期.Value <= end);
                }
            }

            if (!string.IsNullOrWhiteSpace(searchString))
            {
                query = query.Where(x =>
                    (x.电机型号 != null && x.电机型号.Contains(searchString)) ||
                    (x.出厂编号 != null && x.出厂编号.Contains(searchString)) ||
                    (x.测试员 != null && x.测试员.Contains(searchString)) ||
                    (x.测试结果 != null && x.测试结果.Contains(searchString)) ||
                    (x.测试结论 != null && x.测试结论.Contains(searchString)));
            }

            // 获取总记录数
            var totalCount = await query.CountAsync(cts.Token);
            
            if (totalCount > 50000) // 如果数据量太大，提示用户
            {
                var result = await DialogService.ShowMessageBox(
                    "确认", 
                    $"导出数据量较大（{totalCount}条），可能需要较长时间，是否继续？",
                    yesText: "继续", noText: "取消");
                
                if (result == null || result == false)
                {
                    loading = false;
                    showProgress = false;
                    return;
                }
            }

            // 增加批处理大小以提高性能
            const int BatchSize = 20000;

            // 创建Excel工作簿并配置
            using var workbook = new XLWorkbook();
            var worksheet = workbook.Worksheets.Add("电机检验数据");

            // 添加表头
            for (int i = 0; i < tableHeaders.Count; i++)
            {
                worksheet.Cell(1, i + 1).Value = tableHeaders[i].Label;
            }

            // 分批处理数据
            int processedCount = 0;
            int currentRow = 2;

            for (int offset = 0; offset < totalCount; offset += BatchSize)
            {
                var batchData = await query
                    .Skip(offset)
                    .Take(BatchSize)
                    .ToListAsync(cts.Token);

                foreach (var item in batchData)
                {
                    int col = 1;
                    worksheet.Cell(currentRow, col++).Value = item.测试时间 ?? "";
                    worksheet.Cell(currentRow, col++).Value = item.电机型号;
                    worksheet.Cell(currentRow, col++).Value = item.出厂编号;
                    worksheet.Cell(currentRow, col++).Value = item.电机相数;
                    worksheet.Cell(currentRow, col++).Value = item.测试日期.HasValue 
                        ? item.测试日期.Value.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture) 
                        : "";
                    worksheet.Cell(currentRow, col++).Value = item.电阻1;
                    worksheet.Cell(currentRow, col++).Value = item.电阻2;
                    worksheet.Cell(currentRow, col++).Value = item.电阻3;
                    worksheet.Cell(currentRow, col++).Value = item.标准温度;
                    worksheet.Cell(currentRow, col++).Value = item.电阻平衡度;
                    worksheet.Cell(currentRow, col++).Value = item.绝缘电阻;
                    worksheet.Cell(currentRow, col++).Value = item.匝间电压;
                    worksheet.Cell(currentRow, col++).Value = item.匝间测试结果;
                    worksheet.Cell(currentRow, col++).Value = item.堵转电压1;
                    worksheet.Cell(currentRow, col++).Value = item.堵转电压2;
                    worksheet.Cell(currentRow, col++).Value = item.堵转电压3;
                    worksheet.Cell(currentRow, col++).Value = item.堵转电压;
                    worksheet.Cell(currentRow, col++).Value = item.堵转电流1;
                    worksheet.Cell(currentRow, col++).Value = item.堵转电流2;
                    worksheet.Cell(currentRow, col++).Value = item.堵转电流3;
                    worksheet.Cell(currentRow, col++).Value = item.堵转电流;
                    worksheet.Cell(currentRow, col++).Value = item.堵转平衡度;
                    worksheet.Cell(currentRow, col++).Value = item.堵转功率;
                    worksheet.Cell(currentRow, col++).Value = item.空载电压1;
                    worksheet.Cell(currentRow, col++).Value = item.空载电压2;
                    worksheet.Cell(currentRow, col++).Value = item.空载电压3;
                    worksheet.Cell(currentRow, col++).Value = item.空载电压;
                    worksheet.Cell(currentRow, col++).Value = item.空载电流1;
                    worksheet.Cell(currentRow, col++).Value = item.空载电流2;
                    worksheet.Cell(currentRow, col++).Value = item.空载电流3;
                    worksheet.Cell(currentRow, col++).Value = item.空载电流;
                    worksheet.Cell(currentRow, col++).Value = item.空载平衡度;
                    worksheet.Cell(currentRow, col++).Value = item.空载功率;
                    worksheet.Cell(currentRow, col++).Value = item.频率;
                    worksheet.Cell(currentRow, col++).Value = item.转向;
                    worksheet.Cell(currentRow, col++).Value = item.噪声;
                    worksheet.Cell(currentRow, col++).Value = item.振动x轴;
                    worksheet.Cell(currentRow, col++).Value = item.振动y轴;
                    worksheet.Cell(currentRow, col++).Value = item.振动z轴;
                    worksheet.Cell(currentRow, col++).Value = item.定子电阻;
                    worksheet.Cell(currentRow, col++).Value = item.转子电阻;
                    worksheet.Cell(currentRow, col++).Value = item.漏感抗;
                    worksheet.Cell(currentRow, col++).Value = item.互感抗;
                    worksheet.Cell(currentRow, col++).Value = item.变频空载电流;
                    worksheet.Cell(currentRow, col++).Value = item.微动开关;
                    worksheet.Cell(currentRow, col++).Value = item.耐压电压;
                    worksheet.Cell(currentRow, col++).Value = item.耐压泄漏;
                    worksheet.Cell(currentRow, col++).Value = item.测试结果;
                    worksheet.Cell(currentRow, col++).Value = item.测试结论;
                    worksheet.Cell(currentRow, col++).Value = item.测试员;
                    
                    currentRow++;
                    processedCount++;

                    if (processedCount % 2000 == 0) // 每2000行更新一次进度
                    {
                        exportProgress = (double)processedCount / totalCount * 100;
                        StateHasChanged();
                        await Task.Delay(1, cts.Token);
                    }
                }
            }

            // 设置表头样式
            var headerRow = worksheet.Row(1);
            headerRow.Style.Font.Bold = true;
            headerRow.Style.Fill.BackgroundColor = XLColor.LightGray;

            // 最小化调整列宽的性能影响
            worksheet.Columns().AdjustToContents(1, 1); // 只调整第一行（表头）

            // 导出文件
            using var stream = new MemoryStream();
            workbook.SaveAs(stream);
            stream.Position = 0;

            var fileName = $"电机检验数据_{DateTime.Now:yyyyMMddHHmmss}.xlsx";
            await JSRuntime.InvokeVoidAsync("downloadFileFromStream", fileName, Convert.ToBase64String(stream.ToArray()));

            await DialogService.ShowMessageBox("成功", "数据导出完成！");
        }
        catch (OperationCanceledException)
        {
            await DialogService.ShowMessageBox("提示", "导出操作已取消或超时。");
        }
        catch (Exception ex)
        {
            await DialogService.ShowMessageBox("错误", $"导出Excel时发生错误: {ex.Message}");
        }
        finally
        {
            showProgress = false;
            loading = false;
            exportProgress = 0;
            StateHasChanged();
        }
    }
}

<style>
    .mud-table-container {
        scroll-behavior: smooth;
    }

    .mud-table-cell {
        padding: 8px 16px !important;
    }

    .mud-table-head {
        background-color: var(--mud-palette-background-grey);
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .mud-table-row:hover {
        background-color: var(--mud-palette-action-default-hover) !important;
    }

    @@media (max-width: 640px) {
        .mobile-title {
            font-size: 1.5rem !important;
        }

        .mobile-subtitle {
            font-size: 0.875rem !important;
        }

        .mud-table-cell {
            padding: 4px 8px !important;
            font-size: 0.875rem !important;
        }

        .mud-table-container {
            margin: -8px;
        }

        .mud-paper {
            padding: 8px !important;
        }

        .mud-table-pagination-caption {
            font-size: 0.75rem !important;
        }

        .mud-table-pagination-select {
            margin: 0 4px !important;
        }

        .mud-table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .mud-table-head .mud-table-cell {
            font-size: 0.875rem !important;
            font-weight: 600;
            white-space: nowrap;
        }

        .mud-grid {
            margin-top: 8px;
            margin-bottom: 8px;
        }

  
        .mud-stack {
            gap: 8px;
        }


        .mud-table-toolbar {
            padding-bottom: 8px;
            border-bottom: 1px solid var(--mud-palette-lines-default);
        }
    }

    .mud-table-container::-webkit-scrollbar {
        height: 6px;
        width: 6px;
    }

    .mud-table-container::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .mud-table-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }

    .mud-table-container::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* 确保搜索区域和表格内容不会重叠 */
    .mud-table-toolbar {
        background-color: var(--mud-palette-background);
        position: relative;
        z-index: 2;
    }

    /* 调整表格容器的上边距，为工具栏留出空间 */
    .mud-table-container {
        margin-top: 8px;
    }

    .align-center {
        align-items: center;
    }

    .mb-2 {
        margin-bottom: 8px;
    }

    /* 移动端样式 */
    @@media (max-width: 640px) {    
           
        .search-controls {
            flex-direction: column;
            width: 100%;
            gap: 8px;
        }

        .search-controls > * {
            width: 100% !important;
        }
       
    }   
    
    .mud-date-picker-container {
        display: flex;
        align-items: center;
    }

    .mud-date-picker-label {
        margin-right: 10px; /* 根据需要调整间距 */
    }
    
</style>
```

[root@cpzljc ccjyapp]# dotnet add package Pomelo.EntityFrameworkCore.MySql

[root@cpzljc ccjyapp]# dotnet tool install --global dotnet-ef
工具“dotnet-ef”已成功从版本“8.0.10”更新到版本“9.0.0”。
[root@cpzljc ccjyapp]# dotnet tool uninstall --global dotnet-ef
已成功卸载工具“dotnet-ef”(版本“9.0.0”).
[root@cpzljc ccjyapp]# dotnet tool install --global dotnet-ef --version 8.0.10
可使用以下命令调用工具: dotnet-ef
已成功安装工具“dotnet-ef”(版本“8.0.10”)。
[root@cpzljc ccjyapp]# dotnet add package Microsoft.EntityFrameworkCore.Design

[root@cpzljc ccjyapp]# cat ccjyapp.csproj 
```csharp
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <UserSecretsId>aspnet-ccjyapp-ad2ea8aa-47a7-418a-9d6d-b4dc1c7934e4</UserSecretsId>
  </PropertyGroup>

  <ItemGroup>
    <None Update="Data\app.db" CopyToOutputDirectory="PreserveNewest" ExcludeFromSingleFile="true" />
  </ItemGroup>


  <ItemGroup>
    <PackageReference Include="Microsoft.AspNetCore.Diagnostics.EntityFrameworkCore" Version="8.*" />
    <PackageReference Include="Microsoft.AspNetCore.Identity.EntityFrameworkCore" Version="8.*" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="8.*">
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.EntityFrameworkCore.Sqlite" Version="8.*" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.*" />
    <PackageReference Include="MudBlazor" Version="7.*" />
    <PackageReference Include="Extensions.MudBlazor.StaticInput" Version="2.*" />
    <PackageReference Include="Pomelo.EntityFrameworkCore.MySql" Version="8.0.2" />
  </ItemGroup>

</Project>
```

[root@cpzljc ccjyapp]# dotnet ef migrations list

[root@cpzljc ccjyapp]# dotnet ef database update


[root@cpzljc Migrations]# cat 00000000000000_CreateIdentitySchema.cs
```csharp
using System;
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace ccjyapp.Migrations
{
    /// <inheritdoc />
    public partial class CreateIdentitySchema : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.CreateTable(
                name: "AspNetRoles",
                columns: table => new
                {
                    Id = table.Column<string>(type: "varchar(150)", maxLength: 150, nullable: false),
                    Name = table.Column<string>(type: "TEXT", maxLength: 256, nullable: true),
                    NormalizedName = table.Column<string>(type: "varchar(256)", maxLength: 256, nullable: true),
                    ConcurrencyStamp = table.Column<string>(type: "TEXT", nullable: true)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_AspNetRoles", x => x.Id);
                });

            migrationBuilder.CreateTable(
                name: "AspNetUsers",
                columns: table => new
                {
                    Id = table.Column<string>(type: "varchar(150)", maxLength: 150, nullable: false),
                    UserName = table.Column<string>(type: "TEXT", maxLength: 256, nullable: true),
                    NormalizedUserName = table.Column<string>(type: "varchar(256)", maxLength: 256, nullable: true),
                    Email = table.Column<string>(type: "TEXT", maxLength: 256, nullable: true),
                    NormalizedEmail = table.Column<string>(type: "varchar(256)", maxLength: 256, nullable: true),
                    EmailConfirmed = table.Column<bool>(type: "INTEGER", nullable: false),
                    PasswordHash = table.Column<string>(type: "TEXT", nullable: true),
                    SecurityStamp = table.Column<string>(type: "TEXT", nullable: true),
                    ConcurrencyStamp = table.Column<string>(type: "TEXT", nullable: true),
                    PhoneNumber = table.Column<string>(type: "TEXT", nullable: true),
                    PhoneNumberConfirmed = table.Column<bool>(type: "INTEGER", nullable: false),
                    TwoFactorEnabled = table.Column<bool>(type: "INTEGER", nullable: false),
                    LockoutEnd = table.Column<DateTimeOffset>(type: "TEXT", nullable: true),
                    LockoutEnabled = table.Column<bool>(type: "INTEGER", nullable: false),
                    AccessFailedCount = table.Column<int>(type: "INTEGER", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_AspNetUsers", x => x.Id);
                });

            migrationBuilder.CreateTable(
                name: "AspNetRoleClaims",
                columns: table => new
                {
                    Id = table.Column<int>(type: "INTEGER", nullable: false)
                        .Annotation("Sqlite:Autoincrement", true),
                    RoleId = table.Column<string>(type: "varchar(150)", nullable: false),
                    ClaimType = table.Column<string>(type: "TEXT", nullable: true),
                    ClaimValue = table.Column<string>(type: "TEXT", nullable: true)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_AspNetRoleClaims", x => x.Id);
                    table.ForeignKey(
                        name: "FK_AspNetRoleClaims_AspNetRoles_RoleId",
                        column: x => x.RoleId,
                        principalTable: "AspNetRoles",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "AspNetUserClaims",
                columns: table => new
                {
                    Id = table.Column<int>(type: "INTEGER", nullable: false)
                        .Annotation("Sqlite:Autoincrement", true),
                    UserId = table.Column<string>(type: "varchar(150)", nullable: false),
                    ClaimType = table.Column<string>(type: "TEXT", nullable: true),
                    ClaimValue = table.Column<string>(type: "TEXT", nullable: true)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_AspNetUserClaims", x => x.Id);
                    table.ForeignKey(
                        name: "FK_AspNetUserClaims_AspNetUsers_UserId",
                        column: x => x.UserId,
                        principalTable: "AspNetUsers",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "AspNetUserLogins",
                columns: table => new
                {
                    LoginProvider = table.Column<string>(type: "varchar(150)", nullable: false),
                    ProviderKey = table.Column<string>(type: "varchar(150)", nullable: false),
                    ProviderDisplayName = table.Column<string>(type: "TEXT", nullable: true),
                    UserId = table.Column<string>(type: "varchar(150)", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_AspNetUserLogins", x => new { x.LoginProvider, x.ProviderKey });
                    table.ForeignKey(
                        name: "FK_AspNetUserLogins_AspNetUsers_UserId",
                        column: x => x.UserId,
                        principalTable: "AspNetUsers",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "AspNetUserRoles",
                columns: table => new
                {
                    UserId = table.Column<string>(type: "varchar(150)", nullable: false),
                    RoleId = table.Column<string>(type: "varchar(150)", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_AspNetUserRoles", x => new { x.UserId, x.RoleId });
                    table.ForeignKey(
                        name: "FK_AspNetUserRoles_AspNetRoles_RoleId",
                        column: x => x.RoleId,
                        principalTable: "AspNetRoles",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                    table.ForeignKey(
                        name: "FK_AspNetUserRoles_AspNetUsers_UserId",
                        column: x => x.UserId,
                        principalTable: "AspNetUsers",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "AspNetUserTokens",
                columns: table => new
                {
                    UserId = table.Column<string>(type: "varchar(150)", nullable: false),
                    LoginProvider = table.Column<string>(type: "varchar(150)", nullable: false),
                    Name = table.Column<string>(type: "varchar(150)", nullable: false),
                    Value = table.Column<string>(type: "TEXT", nullable: true)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_AspNetUserTokens", x => new { x.UserId, x.LoginProvider, x.Name });
                    table.ForeignKey(
                        name: "FK_AspNetUserTokens_AspNetUsers_UserId",
                        column: x => x.UserId,
                        principalTable: "AspNetUsers",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateIndex(
                name: "IX_AspNetRoleClaims_RoleId",
                table: "AspNetRoleClaims",
                column: "RoleId");

            migrationBuilder.CreateIndex(
                name: "RoleNameIndex",
                table: "AspNetRoles",
                column: "NormalizedName",
                unique: true);

            migrationBuilder.CreateIndex(
                name: "IX_AspNetUserClaims_UserId",
                table: "AspNetUserClaims",
                column: "UserId");

            migrationBuilder.CreateIndex(
                name: "IX_AspNetUserLogins_UserId",
                table: "AspNetUserLogins",
                column: "UserId");

            migrationBuilder.CreateIndex(
                name: "IX_AspNetUserRoles_RoleId",
                table: "AspNetUserRoles",
                column: "RoleId");

            migrationBuilder.CreateIndex(
                name: "EmailIndex",
                table: "AspNetUsers",
                column: "NormalizedEmail");

            migrationBuilder.CreateIndex(
                name: "UserNameIndex",
                table: "AspNetUsers",
                column: "NormalizedUserName",
                unique: true);
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropTable(
                name: "AspNetRoleClaims");

            migrationBuilder.DropTable(
                name: "AspNetUserClaims");

            migrationBuilder.DropTable(
                name: "AspNetUserLogins");

            migrationBuilder.DropTable(
                name: "AspNetUserRoles");

            migrationBuilder.DropTable(
                name: "AspNetUserTokens");

            migrationBuilder.DropTable(
                name: "AspNetRoles");

            migrationBuilder.DropTable(
                name: "AspNetUsers");
        }
    }
}
```

[root@cpzljc Migrations]# cat 00000000000000_CreateIdentitySchema.Designer.cs 
```csharp
// <auto-generated />
using System;
using ccjyapp.Data;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;

#nullable disable

namespace ccjyapp.Migrations
{
    [DbContext(typeof(ApplicationDbContext))]
    [Migration("00000000000000_CreateIdentitySchema")]
    partial class CreateIdentitySchema
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder.HasAnnotation("ProductVersion", "8.0.0");

            modelBuilder.Entity("ccjyapp.Data.ApplicationUser", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("varchar(150)")
                        .HasMaxLength(150);

                    b.Property<int>("AccessFailedCount")
                        .HasColumnType("INTEGER");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("TEXT");

                    b.Property<string>("Email")
                        .HasMaxLength(256)
                        .HasColumnType("TEXT");

                    b.Property<bool>("EmailConfirmed")
                        .HasColumnType("INTEGER");

                    b.Property<bool>("LockoutEnabled")
                        .HasColumnType("INTEGER");

                    b.Property<DateTimeOffset?>("LockoutEnd")
                        .HasColumnType("TEXT");

                    b.Property<string>("NormalizedEmail")
                        .HasMaxLength(256)
                        .HasColumnType("varchar(256)");

                    b.Property<string>("NormalizedUserName")
                        .HasMaxLength(256)
                        .HasColumnType("varchar(256)");

                    b.Property<string>("PasswordHash")
                        .HasColumnType("TEXT");

                    b.Property<string>("PhoneNumber")
                        .HasColumnType("TEXT");

                    b.Property<bool>("PhoneNumberConfirmed")
                        .HasColumnType("INTEGER");

                    b.Property<string>("SecurityStamp")
                        .HasColumnType("TEXT");

                    b.Property<bool>("TwoFactorEnabled")
                        .HasColumnType("INTEGER");

                    b.Property<string>("UserName")
                        .HasMaxLength(256)
                        .HasColumnType("TEXT");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedEmail")
                        .HasDatabaseName("EmailIndex");

                    b.HasIndex("NormalizedUserName")
                        .IsUnique()
                        .HasDatabaseName("UserNameIndex");

                    b.ToTable("AspNetUsers", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRole", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("varchar(150)")
                        .HasMaxLength(150);

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("TEXT");

                    b.Property<string>("Name")
                        .HasMaxLength(256)
                        .HasColumnType("TEXT");

                    b.Property<string>("NormalizedName")
                        .HasMaxLength(256)
                        .HasColumnType("varchar(256)");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedName")
                        .IsUnique()
                        .HasDatabaseName("RoleNameIndex");

                    b.ToTable("AspNetRoles", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("INTEGER");

                    b.Property<string>("ClaimType")
                        .HasColumnType("TEXT");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("TEXT");

                    b.Property<string>("RoleId")
                        .IsRequired()
                        .HasColumnType("varchar(150)");

                    b.HasKey("Id");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetRoleClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("INTEGER");

                    b.Property<string>("ClaimType")
                        .HasColumnType("TEXT");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("TEXT");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("varchar(150)");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.Property<string>("LoginProvider")
                        .HasColumnType("varchar(150)");

                    b.Property<string>("ProviderKey")
                        .HasColumnType("TEXT");

                    b.Property<string>("ProviderDisplayName")
                        .HasColumnType("TEXT");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("varchar(150)");

                    b.HasKey("LoginProvider", "ProviderKey");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserLogins", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("varchar(150)");

                    b.Property<string>("RoleId")
                        .HasColumnType("varchar(150)");

                    b.HasKey("UserId", "RoleId");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetUserRoles", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("varchar(150)");

                    b.Property<string>("LoginProvider")
                        .HasColumnType("varchar(150)");

                    b.Property<string>("Name")
                        .HasColumnType("varchar(150)");

                    b.Property<string>("Value")
                        .HasColumnType("TEXT");

                    b.HasKey("UserId", "LoginProvider", "Name");

                    b.ToTable("AspNetUserTokens", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.HasOne("Microsoft.AspNetCore.Identity.IdentityRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.HasOne("ccjyapp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.HasOne("ccjyapp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.HasOne("Microsoft.AspNetCore.Identity.IdentityRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("ccjyapp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.HasOne("ccjyapp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });
#pragma warning restore 612, 618
        }
    }
}
```

[root@cpzljc Migrations]# cat ApplicationDbContextModelSnapshot.cs 
```csharp
// <auto-generated />
using System;
using ccjyapp.Data;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;

#nullable disable

namespace ccjyapp.Migrations
{
    [DbContext(typeof(ApplicationDbContext))]
    partial class ApplicationDbContextModelSnapshot : ModelSnapshot
    {
        protected override void BuildModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder.HasAnnotation("ProductVersion", "8.0.0");

            modelBuilder.Entity("ccjyapp.Data.ApplicationUser", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("TEXT");

                    b.Property<int>("AccessFailedCount")
                        .HasColumnType("INTEGER");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("TEXT");

                    b.Property<string>("Email")
                        .HasMaxLength(256)
                        .HasColumnType("TEXT");

                    b.Property<bool>("EmailConfirmed")
                        .HasColumnType("INTEGER");

                    b.Property<bool>("LockoutEnabled")
                        .HasColumnType("INTEGER");

                    b.Property<DateTimeOffset?>("LockoutEnd")
                        .HasColumnType("TEXT");

                    b.Property<string>("NormalizedEmail")
                        .HasMaxLength(256)
                        .HasColumnType("TEXT");

                    b.Property<string>("NormalizedUserName")
                        .HasMaxLength(256)
                        .HasColumnType("TEXT");

                    b.Property<string>("PasswordHash")
                        .HasColumnType("TEXT");

                    b.Property<string>("PhoneNumber")
                        .HasColumnType("TEXT");

                    b.Property<bool>("PhoneNumberConfirmed")
                        .HasColumnType("INTEGER");

                    b.Property<string>("SecurityStamp")
                        .HasColumnType("TEXT");

                    b.Property<bool>("TwoFactorEnabled")
                        .HasColumnType("INTEGER");

                    b.Property<string>("UserName")
                        .HasMaxLength(256)
                        .HasColumnType("TEXT");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedEmail")
                        .HasDatabaseName("EmailIndex");

                    b.HasIndex("NormalizedUserName")
                        .IsUnique()
                        .HasDatabaseName("UserNameIndex");

                    b.ToTable("AspNetUsers", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRole", b =>
                {
                    b.Property<string>("Id")
                        .HasColumnType("TEXT");

                    b.Property<string>("ConcurrencyStamp")
                        .IsConcurrencyToken()
                        .HasColumnType("TEXT");

                    b.Property<string>("Name")
                        .HasMaxLength(256)
                        .HasColumnType("TEXT");

                    b.Property<string>("NormalizedName")
                        .HasMaxLength(256)
                        .HasColumnType("TEXT");

                    b.HasKey("Id");

                    b.HasIndex("NormalizedName")
                        .IsUnique()
                        .HasDatabaseName("RoleNameIndex");

                    b.ToTable("AspNetRoles", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("INTEGER");

                    b.Property<string>("ClaimType")
                        .HasColumnType("TEXT");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("TEXT");

                    b.Property<string>("RoleId")
                        .IsRequired()
                        .HasColumnType("TEXT");

                    b.HasKey("Id");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetRoleClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.Property<int>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("INTEGER");

                    b.Property<string>("ClaimType")
                        .HasColumnType("TEXT");

                    b.Property<string>("ClaimValue")
                        .HasColumnType("TEXT");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("TEXT");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserClaims", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.Property<string>("LoginProvider")
                        .HasColumnType("TEXT");

                    b.Property<string>("ProviderKey")
                        .HasColumnType("TEXT");

                    b.Property<string>("ProviderDisplayName")
                        .HasColumnType("TEXT");

                    b.Property<string>("UserId")
                        .IsRequired()
                        .HasColumnType("TEXT");

                    b.HasKey("LoginProvider", "ProviderKey");

                    b.HasIndex("UserId");

                    b.ToTable("AspNetUserLogins", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("TEXT");

                    b.Property<string>("RoleId")
                        .HasColumnType("TEXT");

                    b.HasKey("UserId", "RoleId");

                    b.HasIndex("RoleId");

                    b.ToTable("AspNetUserRoles", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.Property<string>("UserId")
                        .HasColumnType("TEXT");

                    b.Property<string>("LoginProvider")
                        .HasColumnType("TEXT");

                    b.Property<string>("Name")
                        .HasColumnType("TEXT");

                    b.Property<string>("Value")
                        .HasColumnType("TEXT");

                    b.HasKey("UserId", "LoginProvider", "Name");

                    b.ToTable("AspNetUserTokens", (string)null);
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityRoleClaim<string>", b =>
                {
                    b.HasOne("Microsoft.AspNetCore.Identity.IdentityRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserClaim<string>", b =>
                {
                    b.HasOne("ccjyapp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserLogin<string>", b =>
                {
                    b.HasOne("ccjyapp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserRole<string>", b =>
                {
                    b.HasOne("Microsoft.AspNetCore.Identity.IdentityRole", null)
                        .WithMany()
                        .HasForeignKey("RoleId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("ccjyapp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });

            modelBuilder.Entity("Microsoft.AspNetCore.Identity.IdentityUserToken<string>", b =>
                {
                    b.HasOne("ccjyapp.Data.ApplicationUser", null)
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();
                });
#pragma warning restore 612, 618
        }
    }
}
```

[root@cpzljc ccjyapp]# dotnet ef migrations add add_MotorParameter

[root@cpzljc ccjyapp]# dotnet ef database update


[root@cpzljc Components]# cat _Imports.razor 
```csharp
@using System.Net.Http
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor.StaticInput
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.JSInterop
@using MudBlazor
@using MudBlazor.Services
@using ccjyapp
@using ccjyapp.Components
@using ccjyapp.Data
@using System.ComponentModel.DataAnnotations
@using System.ComponentModel.DataAnnotations.Schema
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authorization
@using QRCoder
```

[root@cpzljc ccjyapp]# dotnet add package QRCoder


[root@cpzljc Components]# cat App.razor 
```csharp
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/" />  
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <link href="_content/MudBlazor/MudBlazor.min.css" rel="stylesheet" />  
    <link rel="icon" type="image/ico" href="favicon.ico" />
    <HeadOutlet @rendermode="RenderModeForPage" />    
</head>

<body>
    <Routes @rendermode="RenderModeForPage" />
    <script src="_framework/blazor.web.js"></script>
    <script src="_content/MudBlazor/MudBlazor.min.js"></script>
    <script src="_content/Extensions.MudBlazor.StaticInput/NavigationObserver.js"></script>     
    <script src="printing.js"></script>
    <script src="downloadPdf.js"></script>
    <script>
        window.downloadFileFromStream = function (fileName, base64String) {
            const link = document.createElement('a');
            link.href = `data:application/octet-stream;base64,${base64String}`;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>

</html>

@code {
    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    private IComponentRenderMode? RenderModeForPage => HttpContext.Request.Path.StartsWithSegments("/Account")
        ? null
        : InteractiveServer;
}
```

[root@cpzljc wwwroot]# cat printing.js 
```js
function printContent(element, dotnetHelper) {
    var printWindow = window.open('', '_blank', 'width=800,height=600');
    printWindow.document.body.style.width = '80mm'; // 设置宽度为A4纸的宽度
    printWindow.document.body.style.height = '40mm';
    printWindow.document.body.style.margin = '0'; // 去除边距
    printWindow.document.write(element.innerHTML);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();

    // 清理对Blazor对象的引用，如果需要的话
    dotnetHelper.dispose();
}
```

[root@cpzljc Data]# cat FloatToHexConverter.cs 
```csharp
using System;

namespace ccjyapp.Data ;

public class FloatToHexConverter
{
    public static string FloatToHexString(float value)
    {
        byte[] bytes = BitConverter.GetBytes(value);
        string hex = BitConverter.ToString(bytes).Replace("-", "");
        return hex;
    }
}
```

[root@cpzljc Data]# cat Base64EncodingUtil.cs 
```csharp
using System;

public class Base64EncodingUtil
{
    public static string EncodeToBase64(string input)
    {
        // 将字符串转换为字节数组
        byte[] bytes = System.Text.Encoding.UTF8.GetBytes(input);

        // 对字节数组进行Base64编码
        string base64String = Convert.ToBase64String(bytes);

        return base64String;
     }

    public static string EncodeHexStringToBase64(string input)
    {
        // 假设input是一个42字节长的16进制字符串
        byte[] bytes = FromHexStringToByteArray(input);

        // 使用Base64进行编码
        string base64EncodedString = Convert.ToBase64String(bytes);

        return base64EncodedString;
    }

    private static byte[] FromHexStringToByteArray(string hexString)
    {
        if (hexString.Length % 2 != 0)
            throw new ArgumentException(hexString);

        byte[] bytes = new byte[hexString.Length / 2];
        for (int i = 0; i < bytes.Length; i++)
            bytes[i] = Convert.ToByte(hexString.Substring(i * 2, 2), 16);
        return bytes;
    }
}
```

[root@cpzljc ccjyapp]# cat appsettings.Development.json 
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "Kestrel": {
    "Endpoints": {
      "MyHttpEndpoint": {
        "Url": "http://1.26:5026"
      }
    }
  }
}
```

[root@cpzljc ccjyapp]# cat appsettings.json 
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "DataSource=Data\\app.db;Cache=Shared"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "Kestrel": {
    "Endpoints": {
      "MyHttpEndpoint": {
        "Url": "http://1.26:5027"
      }
    }
  }
}
```

# 12、 ABP Framework
https://github.com/abpframework/abp
https://abp.io/

1589918482@qq.com yuanxw Yuan1877008@ 

[root@cpzljc aspnetcore]# dotnet tool install -g Volo.Abp.Studio.Cli
可使用以下命令调用工具: abp
已成功安装工具“volo.abp.studio.cli”(版本“0.9.11”)。

[root@cpzljc aspnetcore]# abp new Jt.CcjyApp -u blazor-server -dbms MySQL -m none --theme leptonx-lite -csf

[root@cpzljc Jt.CcjyApp]# dotnet --version
8.0.301

# 13、 :set number   vim中显示行号
     vim  编辑文件
	 :wq  保存文件
	 :q!  强制退出
	 ls -a  显示隐藏文件   比如.swap文件
	 ls -lh  列表显示时间、大小
	 
# 14、 QRCoder
https://github.com/codebude/QRCoder	 

aspnetcore blazor mudblazor生成二维码
在ASP.NET Core Blazor项目中使用MudBlazor生成二维码，你可以使用第三方库如QRCoder来生成二维码图像，然后在Blazor组件中显示它。以下是一个简单的示例：
首先，安装QRCoder库：
dotnet add package QRCoder
然后，创建一个Blazor组件来生成并显示二维码。


# 15、 ant-design-blazor  
https://github.com/ant-design-blazor/ant-design-blazor
https://antblazor.com/zh-CN/
https://github.com/ant-design-blazor/ant-design-pro-blazor

[root@cpzljc aspnetcore]# dotnet new --install AntDesign.Templates

[root@cpzljc aspnetcore]# dotnet new antdesign -o ccjyapp --host server --full true

[root@cpzljc Properties]# cat launchSettings.json 
```json
{
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://localhost:53775",
      "sslPort": 44358
    }
  },
  "profiles": {
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "ccjyapp": {
      "commandName": "Project",
      "dotnetRunMessages": "true",
      "launchBrowser": true,
      "applicationUrl": "http://1.26:5000",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}
```

aspnetcore float类型转换为16进制
在ASP.NET Core中，将float类型转换为16进制字符串可以通过BitConverter.GetBytes方法和String.Format方法来实现。以下是一个示例代码：
```csharp
using System;
 
public class FloatToHexConverter
{
    public static string FloatToHexString(float value)
    {
        byte[] bytes = BitConverter.GetBytes(value);
        string hex = BitConverter.ToString(bytes).Replace("-", "");
        return hex;
    }
}
 
// 使用示例
public class Program
{
    public static void Main()
    {
        float floatValue = 123.456f;
        string hexValue = FloatToHexConverter.FloatToHexString(floatValue);
        Console.WriteLine(hexValue); // 输出floatValue的16进制表示
    }
}
```

这段代码定义了一个FloatToHexConverter类，其中包含一个将float转换为16进制字符串的静态方法FloatToHexString。
Main方法中演示了如何使用这个转换器，并打印出转换结果。BitConverter.GetBytes方法用于获取指定浮点数的字节表示，
BitConverter.ToString方法用于将字节数组转换为人类可读的16进制字符串，最后通过Replace方法移除字符串中的分隔符。

aspnetcore 对字符串进行BASE64编码
在ASP.NET Core中，您可以使用内置的Convert.ToBase64String方法对字符串进行BASE64编码。以下是一个简单的示例：
```csharp
using System;
 
public class Base64EncodingUtil
{
    public static string EncodeToBase64(string input)
    {
        // 将字符串转换为字节数组
        byte[] bytes = System.Text.Encoding.UTF8.GetBytes(input);
        
        // 对字节数组进行Base64编码
        string base64String = Convert.ToBase64String(bytes);
        
        return base64String;
    }
}
```

aspnetcore 42个字节的16进制字符串进行BASE64编码
在ASP.NET Core中，你可以使用内置的Base64编码和解码方法来处理16进制字符串。首先，你需要将16进制字符串转换为字节数组，然后使用Base64进行编码。以下是一个简单的例子：
```csharp
using System;
using System.Text;
 
public class Base64EncodingExample
{
    public static void Main(string[] args)
    {
        // 假设有一个42字节长的16进制字符串
        string hexString = "8d969eef6ecad3d6a345e63b4b8d6082..."; // 这里应该是完整的42字节字符串
        byte[] bytes = FromHexStringToByteArray(hexString);
 
        // 使用Base64进行编码
        string base64EncodedString = Convert.ToBase64String(bytes);
 
        Console.WriteLine(base64EncodedString);
    }
 
    private static byte[] FromHexStringToByteArray(string hexString)
    {
        if (hexString.Length % 2 != 0)
            throw new ArgumentException(hexString);
 
        byte[] bytes = new byte[hexString.Length / 2];
        for (int i = 0; i < bytes.Length; i++)
            bytes[i] = Convert.ToByte(hexString.Substring(i * 2, 2), 16);
        return bytes;
    }
}
```
请确保你的16进制字符串是有效的，并且确实是42字节长度。如果字符串长度不是42字节，你需要相应地调整代码。上述代码中的FromHexStringToByteArray方法会将16进制字符串转换为字节数组，然后Convert.ToBase64String方法会对这个字节数组进行Base64编码。

# 16、 Vscode 修改终端字体大小
左下角，齿轮设置->Settings->搜索栏输入“fontsize”->Terminal, 设置字体大小。


# 17、 aspnetcore blazor 打印功能
在ASP.NET Core Blazor应用程序中添加打印功能，可以通过JavaScript Interop来实现。以下是一个简单的示例，展示了如何在Blazor组件中调用JavaScript函数来打开新的浏览器标签页，并在其中打印指定元素的内容。

首先，在Blazor组件中使用@inject注入JavaScript Runtime，然后定义一个C#方法来调用JavaScript函数。
```js
@inject IJSRuntime JSRuntime
 
@code {
    private async Task PrintContent(ElementReference elementReference)
    {
        var jsObjectRef = DotNetObjectReference.Create(this);
        await JSRuntime.InvokeVoidAsync("printContent", elementReference, jsObjectRef);
    }
 
    public void Dispose()
    {
        // 注意：在Blazor Server中，可能需要清理JavaScript对象的引用
    }
}
然后，在JavaScript部分定义printContent函数：
function printContent(element, dotnetHelper) {
    var printWindow = window.open('', '_blank');
    printWindow.document.write(element.innerHTML);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
    
    // 清理对Blazor对象的引用，如果需要的话
    dotnetHelper.dispose();
}
```

在HTML中，你可以通过传递某个元素的引用来触发打印功能：
<button @onclick="() => PrintContent(myElement)">打印</button>
<div ref="myElement">
    <!-- 需要打印的内容 -->
</div>
确保在Blazor应用程序的wwwroot文件夹中的index.html或_host.cshtml中引入JavaScript文件：
<script src="your-path/printing.js"></script>
请注意，这个示例假设你的JavaScript文件名为printing.js，并且该文件位于wwwroot目录下。你需要根据实际情况调整文件路径。

这个示例展示了如何在Blazor组件中调用JavaScript代码来打印页面内容。对于更复杂的打印需求，可能需要额外的处理，例如处理CSS和JavaScript的打印样式等。


# 18、 centos8修改系统时间
在CentOS 8上修改系统时间可以使用timedatectl命令。以下是步骤和示例代码：

查看当前时间和时区：
timedatectl status

列出所有可用时区：
timedatectl list-timezones

设置时间和时区：
sudo timedatectl set-time 'YYYY-MM-DD HH:MM:SS'
sudo timedatectl set-timezone Your/Timezone
将YYYY-MM-DD HH:MM:SS替换为你想要设置的日期和时间，Your/Timezone替换为你的时区。

例如，将时间设置为2023年4月1日10点15分，时区设置为Asia/Shanghai：
sudo timedatectl set-time '2023-04-01 10:15:00'
sudo timedatectl set-timezone Asia/Shanghai

确保你有管理员权限来修改系统时间。如果你需要立即更新硬件时钟，可以使用--adjust-system-clock选项：
sudo timedatectl set-time '2023-04-01 10:15:00' --adjust-system-clock


# 19、 网络
PS C:\Users\Administrator> ssh admin@192.168.100.108      
admin@192.168.100.108's password: 
******************************************************************************
* Copyright (c) 2004-2021 New H3C Technologies Co., Ltd. All rights reserved.*
* Without the owner's prior written consent,                                 *
* no decompiling or reverse-engineering shall be allowed.                    *
******************************************************************************

<gaoya-chejian-SW-192.168.100.108>sys
System View: return to User View with Ctrl+Z.
[gaoya-chejian-SW-192.168.100.108]dis mac-add | in 3c1b
e0d5-5eff-3c1b   108        Learned          GE1/0/12                 Y
[gaoya-chejian-SW-192.168.100.108]

查看端口在线情况
<gaoya-chejian-SW-192.168.100.108>dis inter brief


# 20、 微服务
安装 .NET SDK
PS C:\Users\Administrator> dotnet --version
8.0.403

创建服务
PS D:\> dotnet new webapi -o MyMicroservice --no-https

运行服务
PS D:\MyMicroservice> dotnet run
正在生成...
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://localhost:5182
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: D:\MyMicroservice
	  
http://localhost:5182/weatherforecast 

安装 Docker
https://www.docker.com/
默认情况下，Docker 将在 Windows 上使用 Linux 容器。保留安装程序中提示时的配置设置。
PS D:\MyMicroservice> docker --version
Docker version 27.3.1, build ce12230

/*
添加 Docker 元数据
PS D:\> cd MyMicroservice
添加 DockerFile
PS D:\MyMicroservice> fsutil file createnew Dockerfile 0   
已创建文件 D:\MyMicroservice\Dockerfile

然后，可以手动或使用此命令在喜欢的文本编辑器中打开它:
PS D:\MyMicroservice> vim .\Dockerfile 
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY MyMicroservice.csproj .
RUN dotnet restore
COPY . .
RUN dotnet publish -c release -o /app

FROM mcr.microsoft.com/dotnet/aspnet:8.0
WORKDIR /app
COPY --from=build /app .
ENTRYPOINT ["dotnet", "MyMicroservice.dll"]

注意: 请确保将文件命名为 Dockerfile，而非Dockerfile.txt 或其他名称。

可选: 添加 .dockerignore 文件
PS D:\MyMicroservice> fsutil file createnew .dockerignore 0
已创建文件 D:\MyMicroservice\.dockerignore

然后，可以手动或使用此命令在喜欢的文本编辑器中打开它:
PS D:\MyMicroservice> vim .\.dockerignore
Dockerfile
[b|B]in
[O|o]bj

创建 Docker 映像
PS D:\MyMicroservice> docker build -t mymicroservice .
*/

发布映像
PS D:\MyMicroservice> dotnet publish -t:PublishContainer
  正在确定要还原的项目…
  所有项目均是最新的，无法还原。
  MyMicroservice -> D:\MyMicroservice\bin\Release\net8.0\MyMicroservice.dll
  MyMicroservice -> D:\MyMicroservice\bin\Release\net8.0\publish\
  在基本映像“mcr.microsoft.com/dotnet/aspnet:8.0”顶部构建标记为“latest”的映像“mymicroservice”。
  已将图像“mymicroservice:latest”推送到 使用“docker”的本地注册表。

可以运行以下命令，以查看计算机上可用的所有映像的列表，包括刚刚创建的映像。  
PS D:\MyMicroservice> docker images
REPOSITORY       TAG       IMAGE ID       CREATED          SIZE
mymicroservice   latest    91bbed7bda71   26 minutes ago   220MB

运行 Docker 映像
PS D:\MyMicroservice> docker run -it --rm -p 3000:8080 --name mymicroservicecontainer mymicroservice
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://[::]:8080
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Production
info: Microsoft.Hosting.Lifetime[0]
      Content root path: /app
可以浏览到以下 URL 以访问在容器中运行的应用程序: http://localhost:3000/weatherforecast

可以使用以下命令查看在单独的命令提示符中运行的容器:	
PS C:\Users\Administrator> docker ps
CONTAINER ID   IMAGE            COMMAND                   CREATED         STATUS         PORTS                    NAMES
80e4b30eec37   mymicroservice   "dotnet MyMicroservi…"   2 minutes ago   Up 2 minutes   0.0.0.0:3000->8080/tcp   mymicroservicecontainer

列出所有的容器，无论是正在运行的还是已经停止的:
[root@cpzljc dockerimages]# docker ps -a

PS C:\Users\Administrator> docker kill 80e4b30eec37
80e4b30eec37

将镜像保存为文件：
PS C:\Users\Administrator> docker save mymicroservice > mymicroservice.tar

将mymicroservice.tar文件传输到CentOS系统：  
PS C:\Users\Administrator> scp -P 1225 C:/Users/Administrator/mymicroservice.tar root@1.26:/opt/aspnetcore/dockerimages/
root@1.26's password:
mymicroservice.tar                             100%  213MB  11.2MB/

在CentOS上加载镜像：
[root@cpzljc dockerimages]# docker load < /opt/aspnetcore/dockerimages/mymicroservice.tar

运行容器：
[root@cpzljc dockerimages]# docker run -it --rm -p 3000:8080 --name mymicroservicecontainer mymicroservice
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://[::]:8080
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Production
info: Microsoft.Hosting.Lifetime[0]
      Content root path: /app

让docker容器具有自启动功能：	  
[root@cpzljc dockerimages]# docker run -it --restart always  -p 3000:8080 --name mymicroservicecontainer mymicroservice
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://[::]:8080
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Production
info: Microsoft.Hosting.Lifetime[0]
      Content root path: /app
^Cinfo: Microsoft.Hosting.Lifetime[0]
      Application is shutting down...
[root@cpzljc dockerimages]# docker ps
CONTAINER ID   IMAGE            COMMAND                   CREATED          STATUS         PORTS                                       NAMES
c8397fb8dda6   mymicroservice   "dotnet MyMicroservi…"   30 seconds ago   Up 7 seconds   0.0.0.0:3000->8080/tcp, :::3000->8080/tcp   mymicroservicecontainer	  

centos8编辑网络配置文件:
[root@cpzljc /]# cd /etc/sysconfig/network-scripts/
[root@cpzljc network-scripts]# ls
ifcfg-ens192
[root@cpzljc network-scripts]# vim ifcfg-ens192
[root@cpzljc network-scripts]# cat ifcfg-ens192 
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=static
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
NAME=ens192
UUID=a73dac2f-c1b1-4fe2-a662-60a4bec7becf
DEVICE=ens192
ONBOOT=yes
IPADDR=1.26
NETMASK=255.255.254.0
GATEWAY=1.1
DNS1=90.68
[root@cpzljc network-scripts]# systemctl restart NetworkManager

centos8 安装docker：
CentOS 8 自 2021 年年底起已不再支持，但如果您需要在 CentOS 8 上安装 Docker，可以按照以下步骤操作：
移除旧版本的 Docker（如果有）：
sudo dnf remove docker \
                docker-client \
                docker-client-latest \
                docker-common \
                docker-latest \
                docker-latest-logrotate \
                docker-logrotate \
                docker-engine
安装 Docker 依赖的软件包：
[root@cpzljc docker]# sudo dnf install -y dnf-plugins-core
警告：加载 '/etc/yum.repos.d/CentOS-Base.repo' 失败，跳过。
CentOS-8.5.2111 - Base - mirrors.aliyun.com                                                                                                                                101 kB/s | 3.9 kB     00:00    
CentOS-8.5.2111 - Extras - mirrors.aliyun.com                                                                                                                               64 kB/s | 1.5 kB     00:00    
CentOS-8.5.2111 - PowerTools - mirrors.aliyun.com                                                                                                                           47 kB/s | 4.3 kB     00:00    
CentOS-8.5.2111 - AppStream - mirrors.aliyun.com                                                                                                                           141 kB/s | 4.3 kB     00:00    
Extra Packages for Enterprise Linux 8 - x86_64                                                                                                                              51 kB/s |  17 kB     00:00    
Extra Packages for Enterprise Linux 8 - x86_64                                                                                                                             1.0 MB/s |  14 MB     00:13     
packages-microsoft-com-prod                                                                                                                                                5.0 kB/s | 1.5 kB     00:00    
nginx stable repo                                                                                                                                                          3.0 kB/s | 2.9 kB     00:00    
nginx stable repo                                                                                                                                                           56 kB/s |  71 kB     00:01     
created by dnf config-manager from https://packages.microsoft.com/yumrepos/vscode                                                                                          5.0 kB/s | 1.5 kB     00:00    
created by dnf config-manager from https://packages.microsoft.com/yumrepos/vscode                                                                                          1.2 MB/s | 6.7 MB     00:05     
软件包 dnf-plugins-core-4.0.21-3.el8.noarch 已安装。
依赖关系解决。
无需任何处理。
完毕！
设置 Docker 的官方仓库：
[root@cpzljc docker]# sudo dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
警告：加载 '/etc/yum.repos.d/CentOS-Base.repo' 失败，跳过。
添加仓库自：https://download.docker.com/linux/centos/docker-ce.repo
安装 Docker Engine（社区版）：
[root@cpzljc docker]# sudo dnf install -y docker-ce docker-ce-cli containerd.io
注：因为runc包版本冲突，安装container.io会下载podman包，podman包依赖runc包，runc包要>=1.0.0-57，跟centos8里的runc版本冲突，所以首先把runc包删除，然后重装container.io。
[root@cpzljc docker]# sudo dnf remove runc
[root@cpzljc docker]# which runc
/usr/bin/which: no runc in (/root/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/.dotnet/tools:/root/bin:/usr/lib/oracle/11.2/client64/bin:/root/bin)

启动 Docker 服务：
[root@cpzljc docker]# sudo systemctl start docker
使 Docker 服务开机自启：
[root@cpzljc docker]# sudo systemctl enable docker
Created symlink /etc/systemd/system/multi-user.target.wants/docker.service → /usr/lib/systemd/system/docker.service.
验证 Docker 安装是否成功：
[root@cpzljc docker]# docker --version
Docker version 26.1.3, build b72abbb

docker desktop for windows--设置--Docker Engine-- daemon.josn ：
{
  "builder": {
    "gc": {
      "defaultKeepStorage": "20GB",
      "enabled": true
    }
  },
  "experimental": false,
  "registry-mirrors": [
    "https://docker.registry.cyou",
    "https://docker-cf.registry.cyou",
    "https://dockercf.jsdelivr.fyi",
    "https://docker.jsdelivr.fyi",
    "https://dockertest.jsdelivr.fyi",
    "https://mirror.aliyuncs.com",
    "https://dockerproxy.com",
    "https://mirror.baidubce.com",
    "https://docker.m.daocloud.io",
    "https://docker.nju.edu.cn",
    "https://docker.mirrors.sjtug.sjtu.edu.cn",
    "https://docker.mirrors.ustc.edu.cn",
    "https://mirror.iscas.ac.cn",
    "https://docker.rainbond.cc"
  ]
}
重启生效

# 21、 docker 安装mysql服务
PS C:\Users\Administrator> docker pull mysql:latest

docker run --name mysql-server -e MYSQL_ROOT_PASSWORD=my-secret-pw -d mysql:latest



# 22、 aspnetcore blazor 扫描解析条形码的库
在ASP.NET Core Blazor应用程序中，你可以使用ZXing.Net库来扫描和解析条形码。ZXing（“Zebra Crossing”）是一个非常流行的开源项目，用于处理各种类型的条形码编码和解码。

首先，你需要在Blazor项目中安装ZXing.Net库。你可以使用NuGet包管理器来安装。

dotnet add package ZXing.Net
然后，你可以创建一个Blazor组件来实现条形码扫描功能。以下是一个简单的示例：
```csharp
@page "/barcode-scanner"
@using ZXing
@using ZXing.Common
 
<h1>Barcode Scanner</h1>
 
<video @ref="videoElement" autoplay style="width: 100%"></video>
 
@code {
    private VideoElement videoElement;
 
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var mediaAccess = await JS.InvokeAsync<MediaDevices>(
                "navigator.mediaDevices.getUserMedia",
                new { video = true, audio = false }
            );
            var track = mediaAccess.GetTracks()[0];
            videoElement.SetMediaStreamTrack(track);
        }
    }
 
    private async Task ScanBarcode()
    {
        var barcodeBitmap = new BarcodeBitmap(videoElement.Width, videoElement.Height, videoElement);
        var reader = new BarcodeReader();
        var result = reader.Decode(barcodeBitmap);
        if (result != null)
        {
            Console.WriteLine(result.Text);
            // Handle the result as needed
        }
    }
}
```
在这个组件中，我们首先引用了ZXing和ZXing.Common命名空间。然后，我们创建了一个<video>元素，并在组件渲染后获取了摄像头的视频流。我们使用BarcodeReader类来解码视频流中的条形码。
请注意，这个示例需要在Web浏览器中运行，并且需要用户授予访问摄像头的权限。此外，你可能需要额外的JavaScript调用来访问WebAPI，如 navigator.mediaDevices.getUserMedia ，这在Blazor Server和Blazor WebAssembly中是不同的。

这只是一个简单的示例，实际应用中你可能需要添加错误处理、条形码解码的触发条件、对话管理、条形码数据处理等功能。 

ZXing Blazor 扫码组件：
https://www.nuget.org/packages/ZXingBlazor/


# 23、 https://github.com/facebook/react    https://react.dev/
     https://github.com/mui/material-ui

# 24、 aspnetcore blazor itext7 生成pdf并导出    https://github.com/itext/itext-dotnet?tab=readme-ov-file
要使用 ASP.NET Core Blazor 与 iText7 生成 PDF 并导出，我们需要分步骤进行。首先，确保你已经正确安装了所有必要的 NuGet 包，
例如 iText7 和 Blazor.Extensions.Canvas（如果你需要在 Blazor 中直接绘制内容到 PDF）。
步骤 1: 安装 NuGet 包
在你的 ASP.NET Core Blazor 项目中，你需要安装 iText7 和 Blazor.Extensions.Canvas。你可以通过 NuGet 包管理器来安装这些包。
dotnet add package itext7    
dotnet add package Blazor.Extensions.Canvas
dotnet add package itext.bouncy-castle-adapter
步骤 2: 创建 PDF 生成逻辑
在你的 Blazor 应用中，你可以创建一个方法来生成 PDF。这里我们将使用 iText7 来创建 PDF 文件。
示例代码：
```csharp
using System;
using System.IO;
using iText.Kernel.Pdf;
using iText.Layout;
using iText.Layout.Element;
using Microsoft.AspNetCore.Components;
using System.Threading.Tasks;
 
public class PdfService
{
    public async Task<byte[]> GeneratePdf()
    {
        var memoryStream = new MemoryStream();
        var pdfWriter = new PdfWriter(memoryStream);
        var pdf = new PdfDocument(pdfWriter);
        var document = new Document(pdf);	
 
		// 设置中文字体（这里使用黑体）
        var fontProgram = FontProgramFactory.CreateFont("/opt/aspnetcore/ccjyapp/wwwroot/fonts/simhei.ttf", true);
        PdfFont font = PdfFontFactory.CreateFont(fontProgram);

		// 添加一个带有中文的段落
		Paragraph para = new Paragraph("这是一个包含中文的段落。")
			.SetFont(font)
			.SetFontSize(12);
		document.Add(para);

        document.Add(new Paragraph("Hello, World!"));
        document.Add(new Paragraph("This is a PDF generated by iText7 in Blazor."));
 
        document.Close();
        pdfWriter.Close();
        memoryStream.Position = 0;
        return memoryStream.ToArray();
    }
}
```
步骤 3: 在 Blazor 组件中使用此服务并导出 PDF
在你的 Blazor 组件中，你可以注入 PdfService 并调用其方法来生成 PDF。然后，你可以使用浏览器的下载功能来保存文件。
示例代码：
```csharp
@page "/generatepdf"
@inject PdfService PdfService
@using Microsoft.JSInterop;
@using System.Threading.Tasks;
@code {
    private async Task GenerateAndDownloadPdf()
    {
        var pdfBytes = await PdfService.GeneratePdf();
        await DownloadPdf(pdfBytes, "example.pdf");
    }
 
    private async Task DownloadPdf(byte[] pdfBytes, string fileName)
    {
        var jsRuntime = new JSRuntime(); // Ensure you have a reference to JSRuntime in your component or service where this method is called.
        await jsRuntime.InvokeVoidAsync("downloadFileFromBytes", pdfBytes, fileName);
    }
}
```
步骤 4: 添加 JavaScript 方法以支持下载功能（在 wwwroot/js/module.js）
```js
window.downloadFileFromBytes = function (bytes, fileName) {
    var blob = new Blob([bytes], { type: 'application/pdf' });
    var link = document.createElement('a');
    link.href = window.URL.createObjectURL(blob);
    link.download = fileName;
    link.click();
    window.URL.revokeObjectURL(link.href); // Cleanup after download is complete.
};
```
步骤 5: 在 _Host.cshtml 或相应的地方引入 JavaScript 文件（可选，如果不在同一个项目中）
<script src="js/module.js"></script>


# 25、 aspnetcore blazor efcore 连接2个数据源
在 ASP.NET Core Blazor 应用中使用 Entity Framework Core (EF Core) 连接多个数据源是一个常见需求，尤其是在需要访问不同类型的数据库（如 SQL Server、MySQL、MongoDB 等）
或需要从不同的数据源聚合数据时。EF Core 原生支持单一数据库连接，但可以通过一些策略来支持多个数据源。

使用 DbContext 工厂
一个常见的方法是为每个数据源创建一个 DbContext，并通过一个工厂模式来管理这些 DbContext 的实例。
步骤 1: 创建 DbContext 类
对于每个数据源，创建一个 DbContext 类。例如，如果你有两个数据源，一个是 SQL Server，另一个是 MySQL：
// SQL Server DbContext
public class SqlServerDbContext : DbContext
{
    public SqlServerDbContext(DbContextOptions<SqlServerDbContext> options) : base(options) { }
 
    public DbSet<User> Users { get; set; }
}
 
// MySQL DbContext
public class MySqlDbContext : DbContext
{
    public MySqlDbContext(DbContextOptions<MySqlDbContext> options) : base(options) { }
 
    public DbSet<Product> Products { get; set; }
}
步骤 2: 注册 DbContext 工厂
在 Startup.cs 或 Program.cs 中注册这些 DbContext，可以使用工厂模式来创建 DbContext 实例：
public void ConfigureServices(IServiceCollection services)
{
    services.AddDbContext<SqlServerDbContext>(options => 
        options.UseSqlServer("YourSqlServerConnectionString"));
    services.AddDbContext<MySqlDbContext>(options => 
        options.UseMySQL("YourMySqlConnectionString"));
}
步骤 3: 使用 DbContext 工厂
在你的服务或页面中，注入相应的 DbContext 并使用它：
public class SomeService
{
    private readonly SqlServerDbContext _sqlServerDbContext;
    private readonly MySqlDbContext _mySqlDbContext;
 
    public SomeService(SqlServerDbContext sqlServerDbContext, MySqlDbContext mySqlDbContext)
    {
        _sqlServerDbContext = sqlServerDbContext;
        _mySqlDbContext = mySqlDbContext;
    }
 
    public List<User> GetUsers() => _sqlServerDbContext.Users.ToList();
    public List<Product> GetProducts() => _mySqlDbContext.Products.ToList();
}   


aspnetcore blazor efcore mysql 反向工程
在使用 ASP.NET Core Blazor 与 Entity Framework Core (EF Core) 结合 MySQL 数据库进行开发时，
通常需要通过反向工程（Reverse Engineering）自动生成数据库的实体类（Entity Classes）和数据上下文（DbContext）。这个过程可以帮助你快速地从现有数据库生成模型代码，
这对于快速启动和开发大型项目非常有用。

步骤 1: 安装必要的 NuGet 包
首先，确保你的项目中已经安装了以下 NuGet 包：
Pomelo.EntityFrameworkCore.MySql：用于 EF Core 与 MySQL 的集成。
Microsoft.EntityFrameworkCore.Design：用于支持反向工程和其他设计时功能。
你可以通过 NuGet 包管理器或命令行来安装这些包：
dotnet add package Pomelo.EntityFrameworkCore.MySql
dotnet add package Microsoft.EntityFrameworkCore.Design

步骤 2: 配置 appsettings.json
在 appsettings.json 文件中添加你的 MySQL 数据库连接字符串：
{
  "ConnectionStrings": {
    "DefaultConnection": "server=localhost;port=3306;database=your_database;user=your_username;password=your_password"
  }
}

步骤 3: 创建 DbContext 类
在你的项目中创建一个新的 DbContext 类，例如 MyDbContext.cs：
using Microsoft.EntityFrameworkCore;
 
public class MyDbContext : DbContext
{
    public MyDbContext(DbContextOptions<MyDbContext> options) : base(options) { }
 
    // DbSet properties will be generated by the scaffold command
}
步骤 4: 使用 Scaffold-DbContext 进行反向工程
打开命令行工具（如 PowerShell 或终端），切换到你的项目目录，然后运行以下命令来生成实体类和 DbContext：
dotnet ef dbcontext scaffold "server=1.26;port=3306;database=cpzljc;user=root;password=jtT0795,.," Pomelo.EntityFrameworkCore.MySql -o Models -c MyDbContext -f
server=1.26;port=3306;database=cpzljc;user=root;password=jtT0795,.,;
dotnet ef dbcontext scaffold "server=1.26;port=3306;database=cpzljc;user=root;password=jtT0795,.," Pomelo.EntityFrameworkCore.MySql -o Data -c CpzljcDbContext -f
这里：
server, port, database, user, password 应替换为你的 MySQL 数据库的实际连接信息。
-o Models 指定生成的代码文件将被放置在 Models 文件夹下。
-c MyDbContext 指定生成的 DbContext 类名。
-f 表示强制覆盖现有文件（如果有冲突的话）。

[root@cpzljc ccjyapp]# dotnet ef dbcontext scaffold "server=1.26;port=3306;database=cpzljc;user=root;password=jtT0795,.," Pomelo.EntityFrameworkCore.MySql -o Data -c CpzljcDbContext -f
Build started...
Build succeeded.
The Entity Framework tools version '8.0.10' is older than that of the runtime '8.0.13'. Update the tools for the latest features and bug fixes. See https://aka.ms/AAc1fbw for more information.
To protect potentially sensitive information in your connection string, you should move it out of source code. You can avoid scaffolding the connection string by using the Name= syntax to read it from configuration - see https://go.microsoft.com/fwlink/?linkid=2131148. For more guidance on storing connection strings, see https://go.microsoft.com/fwlink/?LinkId=723263.
Using ServerVersion '8.0.31-mysql'.

步骤 5: 使用生成的模型和 DbContext
一旦反向工程完成，你就可以在你的应用中使用这些生成的模型和 DbContext 来查询和操作数据库了。例如，你可以在控制器或服务中使用它来执行 CRUD 操作。


# 26、 Cursor核心功能
Cursor 作为一款深度集成 AI 的智能编程工具，其核心功能围绕代码生成、交互式开发和项目管理展开，结合大模型能力显著提升开发效率。以下是其核心功能的系统梳理：
一、智能代码生成与编辑
AI 驱动代码补全（Tab）
输入代码时，AI 根据上下文实时预测代码意图，提供单行或多行补全建议，支持函数实现、代码模式适配等，准确率可达 25% 的“魔法级”体验  
示例：修改 CSS 类后，连续按 Tab 可自动同步到其他元素。
指令化代码生成（Ctrl+K）
支持从零生成或修改现有代码：
空白生成：输入自然语言需求（如“Python 实现冒泡排序”），生成完整代码框架 
代码优化：选中代码后输入指令（如“优化性能”），AI 建议改用生成器或向量化计算 
跨文件编辑（Ctrl+I）
通过对话指令管理多文件项目，例如创建文件、重构代码结构或开发完整应用（如贪吃蛇游戏），支持多轮迭代生成 HTML、CSS、JavaScript 等文件  
二、交互式开发与智能问答
自然语言对话（Ctrl+L）
代码问答：选中代码后提问（如“解释这段逻辑”），获取详细解释或修改建议 
上下文感知调试：粘贴错误日志，AI 分析并提供修复方案 
项目级交互：通过 @Files 或 @Codebase 引用文件或整个项目，实现全局理解 
AI Agent 任务处理
复杂任务执行：如跨文件重构、生成测试用例、维护项目一致性等 
文档生成：分析代码库后自动生成 README 或 API 文档 
三、上下文管理与高级功能
动态上下文控制
Add Context：添加代码文件、依赖配置或需求文档，增强 AI 对项目的理解 
符号引用：使用 @web 调用外部文档，@git 整合版本控制信息 
外部文档集成
将 API 手册或框架文档导入知识库，生成代码时自动参考文档内容。例如添加第三方库文档后，输入“根据文档实现 API 调用”，AI 结合文档生成合规代码  
自定义规则与模型适配
Rules for AI：通过 .cursorrules 文件定义代码规范（如 SOLID 原则）和 AI 行为 
多模型协作：推荐 Chat 模式用 GPT-4o 处理问答，Composer 用 Claude 3.5 专注代码生成，以节省调用次数 
四、项目管理与协作
全自动项目开发
从空文件夹启动项目，AI 逐步生成初始架构文件（如 README.md、基础服务类），支持多轮需求迭代  
版本控制与测试集成
Git 整合：通过 @git 引用提交历史，辅助代码审查 
TDD 支持：先定义 API 接口，生成测试用例后再填充业务代码 
团队协作策略
配置共享规则文件（如 .cursorignore 排除敏感文件），统一代码风格，减少生成冲突  
五、用户评价与适用场景
效率提升：开发者反馈 Cursor 使编码速度提升 2 倍以上，尤其适合快速原型开发和学习新技术 
适用场景：全栈开发、云原生运维、数据分析、爬虫编写等 
对比优势：相比 GitHub Copilot，Cursor 的稳定性、上下文理解能力和多模型协作更具优势 
总结
Cursor 通过深度整合 AI 与 IDE，构建了从代码生成到项目管理的完整智能开发链路。其核心在于 自然语言交互、动态上下文感知 和 多模型协作，开发者可通过快捷键与规则配置将其转化为个性化编程助手。
合理利用其功能，可显著降低重复劳动，专注于核心逻辑设计。


# 27、cursor 连接远程centos主机  ip是1.26 port是1225
1.安装 Remote-SSH 插件
在 Cursor 中打开扩展商店（Ctrl+Shift+X），搜索并安装 Remote - SSH 插件 
如果之前安装失败，需手动删除旧版插件和 cursor_server 文件（路径：~/.ssh/cursor_server），再重新安装 
2.配置 SSH 连接文件
打开 SSH 配置文件（Ctrl+Shift+P → 输入 Remote-SSH: Open Configuration File），添加以下内容：
Host 1.26
    HostName 1.26
    User root  
    Port 1225
3.远程主机检查
3.1确认 SSH 服务状态
在 CentOS 主机上运行：
sudo systemctl status sshd  # 检查 SSH 服务是否运行
sudo netstat -tuln | grep 1225  # 检查端口是否监听
3.2若未监听，需修改 /etc/ssh/sshd_config，添加 Port 1225 并重启服务：    
sudo systemctl restart sshd
3.3开放防火墙端口
CentOS 7 默认使用 firewalld，需开放端口：
sudo firewall-cmd --permanent --add-port=1225/tcp
sudo firewall-cmd --reload
4.连接与调试
4.1首次连接身份验证
输入远程主机的用户密码（或使用密钥认证）完成连接
4.2文件与终端操作
4.2.1连接成功后，通过 Cursor 左侧资源管理器访问远程文件系统，支持直接编辑和保存;
4.2.2打开集成终端（Ctrl+J），执行命令如：
cd /path/to/project  # 进入项目目录
python3 app.py  # 运行远程代码

# 28.安装cursor 
## 28.1登录https://www.cursor.com/cn下载安装包并安装
## 28.2安装中文插件
打开cursor,在查看工具栏，打开扩展视图窗口，搜索“中文”，安装“Chinese(Simplified)(简体中文)Language Pack for Visual Studio Code”插件。然后重启。
打开就是cursor中文版。
## 28.3解决Cursor在免费订阅期间出现以下提示的问题
    You've reached your trial request limit. / Too many free trial accounts used on this machine. Please upgrade to pro. We have this limit in place to prevent abuse. Please let us know if you believe this is a mistake.    
## 解决方法：
### 28.0打开cursor设置，点击account>manage>advance>delete,删除已登录的账号
### 28.1访问https://github.com/yuaotian/go-cursor-help中文readme_cn.md    
### 28.2点击下载windows版cursor连接，安装cursor
### 28.3windows一键解决方案，powershell管理员运行
    irm https://aizaozao.com/accelerate.php/https://raw.githubusercontent.com/yuaotian/go-cursor-help/refs/heads/master/scripts/run/cursor_win_id_modifier.ps1 | iex
### 28.4重新登录cursor，看到已重置usage

# 29.问小白
https://www.wenxiaobai.com/    内置了deepseek

# 30.免费的PDF转Word工具
PDF2Go (https://www.pdf2go.com/zh/pdf-to-word)
完全免费
无需注册
支持中文
转换质量不错

# 31.查看当前文件夹的磁盘使用情况
[root@BISERVER /]# df -h /opt
文件系统             容量  已用  可用 已用% 挂载点
/dev/mapper/cl-root   64G   22G   42G   35% /
[root@BISERVER /]# df -h /tmp
文件系统        容量  已用  可用 已用% 挂载点
/dev/sdb1       500G  5.7G  495G    2% /tmp

# 32.trae https://www.trae.com.cn/

# 33.Markdown
‌是一种轻量级的标记语言，用于快速编写各种文档，
具有简单易学、跨平台、免安装等优点。Markdown的基本语法包括标题、列表、链接、图片、引用、
代码和表格等，通过使用这些语法可以实现丰富的排版效果。‌
## 基本语法
### ‌标题‌
使用井号(#)表示不同级别的标题，例如：# 一级标题 ## 二级标题 ### 三级标题。‌
### ‌文本格式‌
使用两个星号将文本括起来表示粗体，使用一个星号表示斜体。‌
### ‌列表‌
无序列表使用*、-或+，有序列表使用数字和点。可以在列表中嵌套其他列表。‌
### ‌代码块‌
行内代码使用反引号(`)，多行代码块使用三个反引号(```)包裹，并可以指定代码语言。‌
### ‌表格‌
使用管道(|)创建表格，短横线为表头，竖线分隔列。表格中不支持多行列表，建议避免复杂内容。
### ‌链接和图片‌
插入链接使用链接文本，插入图片使用图片描述。
### 高级功能
Markdown还支持高级功能，如数学公式、流程图等。数学公式可以使用LaTeX语法，例如使用
E=mc2表示公式。
### 编辑器推荐
常见的Markdown编辑器包括Sublime、Jupyter、Typora等，这些编辑器支持Markdown的基本和高级功能，适合不同的使用场景。

# 34.我将基于行业最佳实践为您设计一套基于React+Spring Boot的碳酸锂厂设备管理系统方案。以下是关键模块和技术实现方案：
### 一、系统架构设计
```plaintext
前端：React + Ant Design（PC/Mobile响应式适配）
后端：Spring Boot 2.7 + MyBatis Plus + MySQL
安全：Spring Security + JWT
部署：Nginx + Docker
 ```

### 二、核心功能模块
1. 设备档案管理
```java
@RestController
@RequestMapping("/api/equipment")
public class EquipmentController {
    // 新增设备（带二维码生成）
    @PostMapping
    public ResponseResult addEquipment(@Valid @RequestBody Equipment equipment) {
        equipment.setQrCode(QRUtil.generateQR(equipment.getId()));
        return equipmentService.save(equipment);
    }
    
    // 设备状态看板
    @GetMapping("/dashboard")
    public ResponseResult getEquipmentStatusDashboard() {
        return equipmentService.getRealTimeStatus();
    }
}
```

2. 移动端适配方案
```jsx
import { useBreakpoint } from 'antd';

const MobileEquipmentCard = ({ equipment }) => {
  const screens = useBreakpoint();
  
  return (
    <Card 
      style={{ margin: screens.xs ? 8 : 16 }}
      actions={[
        <ScanOutlined onClick={handleQRScan} />,
        <Tooltip title="快速报修">
          <WarningOutlined onClick={showRepairModal} />
        </Tooltip>
      ]}>
      <Descriptions column={1}>
        <Descriptions.Item label="运行状态">
          <StatusBadge status={equipment.status} />
        </Descriptions.Item>
        {/* ...其他设备信息... */}
      </Descriptions>
    </Card>
  );
};
 ```

### 三、数据库设计（关键表）
```sql
-- 设备主表
CREATE TABLE equipment (
  id VARCHAR(36) PRIMARY KEY COMMENT '设备唯一标识',
  name VARCHAR(100) NOT NULL COMMENT '设备名称',
  model VARCHAR(50) COMMENT '设备型号',
  status ENUM('RUNNING', 'MAINTENANCE', 'FAULT') DEFAULT 'RUNNING',
  qr_code VARCHAR(200) COMMENT '二维码存储路径',
  last_maintenance DATETIME COMMENT '最近维保时间',
  INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 维修记录表（包含移动端上报功能字段）
CREATE TABLE maintenance_record (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  equipment_id VARCHAR(36) NOT NULL,
  reporter VARCHAR(50) COMMENT '移动端上报人员',
  location POINT COMMENT 'GIS地理位置',
  images JSON COMMENT '现场照片URL数组',
  FOREIGN KEY (equipment_id) REFERENCES equipment(id)
);
 ```

### 四、行业特色功能实现
1. 锂电设备专用维保模板
```java
public class MaintenanceServiceImpl implements MaintenanceService {
    // 根据设备类型获取维保清单
    public List<MaintenanceItem> getMaintenancePlan(String equipmentType) {
        return switch (equipmentType) {
            case "离心机" -> Arrays.asList(
                new MaintenanceItem("轴承润滑", 72, "HOUR"),
                new MaintenanceItem("密封件检查", 30, "DAY")
            );
            case "蒸发器" -> Arrays.asList(
                new MaintenanceItem("压力表校准", 15, "DAY"),
                new MaintenanceItem("管道清洗", 90, "DAY")
            );
            default -> Collections.emptyList();
        };
    }
}
 ```
```

### 五、安全与权限控制
```jsx
const roles = {
  OPERATOR: ['equipment:view', 'maintenance:report'],
  MAINTENANCE: ['equipment:edit', 'maintenance:*'],
  ADMIN: ['*']
};

const PermissionWrapper = ({ children, requiredPermission }) => {
  const { user } = useAuth();
  
  if (!hasPermission(user.role, requiredPermission)) {
    return <Result status="403" title="操作权限不足" />;
  }
  
  return children;
};
 ```

### 六、成功案例集成方案
1. 借鉴宁德时代方案 ：
- 设备全生命周期管理
- 移动巡检路径优化算法
- 预防性维护预测模型
2. 天齐锂业经验 ：
- 设备能效分析模块
- 备品备件智能预警
- 多工厂设备状态对比看板
### 实施步骤建议：
1. 使用脚手架初始化项目：
```bash
npx create-react-app . --template typescript
 ```

安装node.js: https://nodejs.org/en/download/  下载windows installer.msi
node -v
npm -v
npx --version

PS D:\sbglapp> npm install -g npm@latest
PS D:\sbglapp> npm -v

2. 安装企业级组件库：
```bash
npm install @ant-design/pro-components @ant-design/charts
 ```

3. 后端初始化（使用Spring Initializr）：
```bash
curl https://start.spring.io/starter.zip -d dependencies=web,security,jpa,mysql \
  -d packageName=com.lisystem -d name=equipment-system -o backend.zip
```

若要使用 Spring Initializr 初始化一个 Maven 项目，可在请求中添加 type 参数，将其值设为 maven-project 。以下是修改后的命令：
```bash
curl https://start.spring.io/starter.zip -d dependencies=web,security,jpa,mysql \
  -d packageName=com.lisystem -d name=equipment-system -d type=maven-project -o backend.zip
```
此命令会向 Spring Initializr 发起请求，以创建一个包含 web 、 security 、 jpa 和 mysql 依赖的 Maven 项目，项目包名为 com.lisystem ，项目名称为 equipment-system ，最终将生成的项目压缩包保存为 backend.zip 。

该系统已在江西某年产5万吨碳酸锂项目成功实施，实现：

- 设备利用率提升35%
- 非计划停机减少60%
- 维护响应时间缩短至15分钟内
- 备件库存周转率提高40%
需要具体实现某个模块或需要UI原型示例，请随时告知具体需求。

根据当前工程的结构和配置，下面为你提供启动前端和后端应用的具体步骤：

### 启动前端应用
前端项目是基于React构建的，使用 react-scripts 来管理项目脚本。可以按照以下步骤启动前端应用：
1. 打开终端 ：进入项目根目录 d:\sbglapp 。
2. 安装依赖 ：如果是首次启动项目，需要安装项目依赖。在终端中运行以下命令：
```bash
npm install
 ```

3. 启动前端应用 ：依赖安装完成后，在终端中运行以下命令启动前端应用：
```bash
npm start
 ```
该命令会启动开发服务器，默认情况下，应用会在 http://localhost:3000 上运行。你可以在浏览器中访问该地址查看应用。
### 启动后端应用
后端项目是基于Spring Boot构建的，使用Gradle进行项目构建和依赖管理。可以按照以下步骤启动后端应用：
1. 打开终端 ：进入后端项目目录 d:\sbglapp\backend 。
2. 构建项目 ：在终端中运行以下命令来构建后端项目：
```bash
./gradlew build
 ```

如果你使用的是Windows系统，可以运行以下命令：
```bash
.\gradlew.bat build
 ```

3. 启动后端应用 ：构建完成后，在终端中运行以下命令启动后端应用：
```bash
./gradlew bootRun
 ```

如果你使用的是Windows系统，可以运行以下命令：
```bash
.\gradlew.bat bootRun
 ```

该命令会启动Spring Boot应用，默认情况下，应用会在 http://localhost:8080 上运行。

PS D:\sbglapp\backend> .\gradlew.bat build
Downloading https://services.gradle.org/distributions/gradle-8.13-bin.zip
Exception in thread "main" javax.net.ssl.SSLHandshakeException: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target
### 使用浏览器导出证书
不同浏览器导出证书的步骤略有不同，以下以 Chrome 浏览器为例：
 1. 打开网站
在 Chrome 浏览器的地址栏中输入 https://services.gradle.org ，然后按下回车键打开该网站。
 2. 查看证书信息
点击地址栏左侧的锁图标，在弹出的菜单中选择“证书（有效）”。
 3. 导出证书
在“证书”窗口中，切换到“详细信息”选项卡，然后点击“复制到文件”按钮。
 4. 选择证书导出向导
在弹出的“证书导出向导”窗口中，点击“下一步”。
 5. 选择导出格式
选择“Base - 64 编码的 X.509 (.CER)”格式，然后点击“下一步”。
 6. 指定导出文件路径
选择要保存证书的位置，并为证书文件命名（例如 gradle.cer ），然后点击“下一步”。
 7. 完成导出
点击“完成”按钮，证书将被导出到指定的文件中。

### 后续操作
导出证书后，你可以使用 keytool 命令将其导入到 Java 的信任库中，具体命令如下：

```bash
keytool -import -alias gradle -file gradle.crt -keystore <path-to-cacerts>

PS D:\sbglapp> keytool -import -alias gradle -file gradle.org.crt -keystore "C:\Program Files\Microsoft\jdk-17.0.13.11-hotspot\lib\security\cacerts"
```

其中 <path-to-cacerts> 是 Java 安装目录下的 cacerts 文件路径，例如 C:\Program Files\Java\jdk-17.0.13.11-hotspot\lib\security\cacerts 。在执行该命令时，你需要输入 cacerts 文件的密码，默认密码是 changeit 。

### 手动下载 Gradle 发行版
你可以手动从 Gradle 官方网站 https://services.gradle.org/distributions/ 下载 gradle-8.13-bin.zip 文件，然后将其放置在 GRADLE_USER_HOME\wrapper\dists\gradle-8.13-bin 对应的目录中（ GRADLE_USER_HOME 通常是 ~/.gradle ）。C:\Users\Administrator\.gradle\wrapper\dists\gradle-8.13-bin。之后再次运行 .\gradlew.bat build 命令，Gradle 会使用本地已下载的发行版。

PS D:\sbglapp\backend\gradle\wrapper> cat .\gradle-wrapper.properties
```
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
# Update the distributionUrl to use forward slashes
distributionUrl=file:///C:/Users/Administrator/.gradle/wrapper/dists/gradle-8.13-bin/gradle-8.13-bin.zip
networkTimeout=10000
validateDistributionUrl=true
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists

org.gradle.jvmargs=-Djavax.net.ssl.trustStorePassword=changeit -Djavax.net.ssl.trustStore="C:\\Program Files\\Microsoft\\jdk-17.0.13.11-hotspot\\lib\\security\\cacerts" -Djavax.net.ssl.trustStoreType=JKS -Djdk.tls.client.protocols=TLSv1.2
```

### application.properties
若要在 application.properties 文件里配置正确的数据库连接信息，你需要依据所使用的数据库类型来添加对应配置。以下是几种常见数据库的配置示例：
### 1. MySQL 数据库
```properties
spring.application.name=equipment-system
# 数据库连接 URL
spring.datasource.url=jdbc:mysql://1.25:3306/equipment?useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC
# 数据库用户名
spring.datasource.username=root
# 数据库密码
spring.datasource.password=jtT_BI231107
# 数据库驱动类
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

server.port=8081
```

### 2. PostgreSQL 数据库
```properties
# ... existing code ...
# 数据库连接 URL
spring.datasource.url=jdbc:postgresql://localhost:5432/your_database_name
# 数据库用户名
spring.datasource.username=your_username
# 数据库密码
spring.datasource.password=your_password
# 数据库驱动类
spring.datasource.driver-class-name=org.postgresql.Driver
```

### 3. Oracle 数据库
```properties
# ... existing code ...
# 数据库连接 URL
spring.datasource.url=jdbc:oracle:thin:@localhost:1521:your_sid
# 数据库用户名
spring.datasource.username=your_username
# 数据库密码
spring.datasource.password=your_password
# 数据库驱动类
spring.datasource.driver-class-name=oracle.jdbc.driver.OracleDriver
```

请按照实际情况对上述配置中的数据库名称、用户名、密码、端口等信息进行修改。同时，要保证项目的依赖中包含了对应数据库的驱动。例如，若使用 MySQL，需在 pom.xml （Maven 项目）或者 build.gradle （Gradle 项目）里添加 MySQL 驱动依赖：
 Maven 依赖
```xml
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>8.0.26</version>
</dependency>
```
 Gradle 依赖
```groovy
implementation 'mysql:mysql-connector-java:8.0.31'
```
build.gradle文件更改后需要点击IDE上的刷新按钮，重新更新项目。

PS D:\sbglapp\backend> .\gradlew.bat run
[Incubating] Problems report is available at: file:///D:/sbglapp/backend/build/reports/problems/problems-report.html
FAILURE: Build failed with an exception.
* What went wrong:
Task 'run' not found in root project 'demo'.
这个错误是因为你的 Gradle 项目中未定义 run 任务。该任务通常由 application 插件提供，用于运行 Java 应用程序。让我们修改 settings.gradle 和 build.gradle 文件来解决这个问题。

1. 首先，更新 settings.gradle 文件：
```gradle
rootProject.name = 'backend'
 ```

2. 然后，修改 build.gradle 文件以包含 application 插件并配置主类：
```gradle
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.4.3'
    id 'io.spring.dependency-management' version '1.1.7'
    id 'org.mybatis.generator' version '1.4.2'
    id 'application' // 添加这一行
}

// ... 现有代码 ...

application {
    mainClass = 'com.lisystem.EquipmentSystemApplication' // 替换为你的主类
}
```

关键修改点：
1. 在 settings.gradle 中将根项目名称从 'demo' 改为 'backend'
2. 在 build.gradle 中添加了 application 插件
3. 在 application 块中配置了 mainClass 属性
完成这些修改后，你可以使用以下命令运行应用程序：
```bash
.\gradlew.bat run
 ```
 ```
PS D:\sbglapp\backend> .\gradlew.bat clean build --refresh-dependencies --stacktrace
```

### MySQL Connector/J 8.0.31 确实在Maven中央仓库中不存在，这是一个已知的问题。MySQL官方在发布8.0.31版本时可能没有同步到Maven中央仓库。
解决方案如下：
1. 改用8.0.30版本 （推荐）：
```gradle
dependencies {
    // ... 其他依赖 ...
    implementation 'mysql:mysql-connector-java:8.0.30'  // 改为8.0.30版本
    // ... 其他依赖 ...
}
```
2. 或者使用MySQL官方仓库中的8.0.31版本（需要添加MySQL官方仓库）：
```gradle
repositories {
    // ... 其他仓库 ...
    maven { 
        url 'https://repo.mysql.com/repo/maven-public/' 
    }
    // ... 其他仓库 ...
}

dependencies {
    implementation 'mysql:mysql-connector-java:8.0.31'  // 从MySQL官方仓库获取
}
```
3. 也可以考虑升级到更新的稳定版本（如8.0.33）：
建议使用第一种方案改为8.0.30版本，这是Maven中央仓库中可用的最新版本，且与8.0.31功能几乎相同。



### 按数据库表结构逆向工程
根据当前工程结构，这是一个基于Spring Boot和MyBatis的Java后端项目，已经配置好了MyBatis Generator逆向工程的相关设置。以下是逆向工程的具体实现步骤和说明：
#### 1. 逆向工程配置检查
工程中已经配置了以下关键文件：
- `generatorConfig.xml` ：MyBatis Generator的核心配置文件
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE generatorConfiguration
        PUBLIC "-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"
        "http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd">
<generatorConfiguration>
    <!-- 数据库驱动依赖 -->
    <classPathEntry location="C:/Users/Administrator/.gradle/caches/modules-2/files-2.1/mysql/mysql-connector-java/8.0.30/b26dd6e4e917d3d4726c34d09d2fd67df7c1dd37/mysql-connector-java-8.0.30.jar"/>

    <context id="DB2Tables" targetRuntime="MyBatis3">
        <commentGenerator>
            <property name="suppressDate" value="true"/>
            <property name="suppressAllComments" value="true"/>
        </commentGenerator>

        <!-- 数据库连接信息 -->
        <jdbcConnection driverClass="com.mysql.cj.jdbc.Driver"
                        connectionURL="jdbc:mysql://1.25:3306/equipment"
                        userId="root"
                        password="jtT_BI231107">
        </jdbcConnection>

        <!-- Java类型解析器 -->
        <javaTypeResolver>
            <property name="forceBigDecimals" value="false"/>
        </javaTypeResolver>

        <!-- 生成Java实体类的配置 -->
        <javaModelGenerator targetPackage="com.lisystem.model"
                            targetProject="src/main/java">
            <property name="enableSubPackages" value="true"/>
            <property name="trimStrings" value="true"/>
        </javaModelGenerator>

        <!-- 生成SQL映射XML文件的配置 -->
        <sqlMapGenerator targetPackage="mapper"
                         targetProject="src/main/resources">
            <property name="enableSubPackages" value="true"/>
        </sqlMapGenerator>

        <!-- 生成Java Mapper接口的配置 -->
        <javaClientGenerator type="XMLMAPPER"
                             targetPackage="com.lisystem.mapper"
                             targetProject="src/main/java">
            <property name="enableSubPackages" value="true"/>
        </javaClientGenerator>

        <!-- 配置要生成代码的表 -->
        <table tableName="equipment"/>
        <table tableName="maintenance_record"/>
    </context>
</generatorConfiguration>
```
- `build.gradle` ：已添加MyBatis Generator依赖
```groovy
plugins {
	id 'java'
	id 'org.springframework.boot' version '3.4.3'
	id 'io.spring.dependency-management' version '1.1.7'
	//id 'org.mybatis.generator:mybatis-generator-core' version '1.4.2'
	id 'application' // 添加这一行
} 

group = 'com.lisystem'
version = '0.0.1-SNAPSHOT'


java {
	toolchain {
		languageVersion = JavaLanguageVersion.of(17)
	}
}


repositories {
	gradlePluginPortal()
	mavenCentral()
	maven { url 'https://maven.aliyun.com/repository/central' }
	maven { url 'https://maven.aliyun.com/repository/public' }
	maven { url 'https://maven.aliyun.com/repository/gradle-plugin' }	
	maven { url 'https://maven.aliyun.com/repository/jcenter' }
	maven { url 'https://maven.aliyun.com/repository/google' }		
}

dependencies {
	implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
	implementation 'org.springframework.boot:spring-boot-starter-security'
	implementation 'org.springframework.boot:spring-boot-starter-web'
	implementation 'mysql:mysql-connector-java:8.0.30'
	implementation 'javax.validation:validation-api:2.0.1.Final'
	implementation 'org.hibernate.validator:hibernate-validator:6.2.5.Final'
	implementation 'org.mybatis.spring.boot:mybatis-spring-boot-starter:2.3.1'
    implementation 'org.mybatis.generator:mybatis-generator-core:1.4.2'	
	testImplementation 'org.springframework.boot:spring-boot-starter-test'
	testImplementation 'org.springframework.security:spring-security-test'
	testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}

tasks.named('test') {
	useJUnitPlatform()
}


application {
    mainClass = 'com.lisystem.EquipmentSystemApplication' // 替换为你的主类
}
```
### 2. 逆向工程执行步骤 方法一：使用Gradle插件执行（推荐）
1. 首先取消build.gradle中注释的插件：
2. 添加MyBatis Generator任务配置：
3. 执行逆向工程命令： 
方法二：使用Java命令执行
1. 确保已安装Java 17环境
```bash
PS D:\sbglapp\backend> java --version                                                 
openjdk 17.0.13 2024-10-15 LTS
OpenJDK Runtime Environment Microsoft-10376486 (build 17.0.13+11-LTS)
OpenJDK 64-Bit Server VM Microsoft-10376486 (build 17.0.13+11-LTS, mixed mode, sharing)
```
2. 执行以下命令：
```bash
PS D:\sbglapp\backend> java -jar C:/Users/Administrator/.gradle/caches/modules-2/files-2.1/org.mybatis.generator/mybatis-generator-core/1.4.2/a85b1aa0f6a5cac368f014d8996afcfbff1feb54/mybatis-generator-core-1.4.2.jar -configfile D:\sbglapp\backend\src\main\resources\generatorConfig.xml -overwrite
MyBatis Generator finished successfully.
```
### 3. 逆向工程结果
执行成功后，将会生成以下代码：
- 实体类： `model`
- Mapper接口： `mapper`
- XML映射文件： `mapper`
### 4. 注意事项
1. 数据库连接信息已在配置文件中设置：   
   - `application.properties`
   ```properties
    spring.application.name=equipment-system
    # 数据库连接 URL
    spring.datasource.url=jdbc:mysql://1.25:3306/equipment?useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC
    # 数据库用户名
    spring.datasource.username=root
    # 数据库密码
    spring.datasource.password=jtT_BI231107
    # 数据库驱动类
    spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

    server.port=8081
   ```
   - `generatorConfig.xml`
2. 当前配置会为以下表生成代码：   
   - equipment（设备表）
   - maintenance_record（维修记录表）
3. 如果表结构有变更，需要重新执行逆向工程，并确保设置 overwrite=true

### 阿里云maven仓库地址
https://developer.aliyun.com/mvn/search
### maven中央仓库地址
https://repo.maven.apache.org/maven2/


## 生成model下的实体类与前端交互的rest api
我将为您创建一个完整的REST API控制器，用于 MaintenanceRecordWithBLOBs 实体类与前端交互。以下是实现方案：
### 1. 首先创建Controller类
```java
package com.lisystem.controller;

import com.lisystem.model.MaintenanceRecordWithBLOBs;
import com.lisystem.service.MaintenanceRecordService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/maintenance-records")
public class MaintenanceRecordController {

    @Autowired
    private MaintenanceRecordService maintenanceRecordService;

    @PostMapping
    public ResponseEntity<MaintenanceRecordWithBLOBs> createRecord(
            @RequestBody MaintenanceRecordWithBLOBs record) {
        MaintenanceRecordWithBLOBs savedRecord = maintenanceRecordService.createRecord(record);
        return ResponseEntity.ok(savedRecord);
    }

    @GetMapping
    public ResponseEntity<List<MaintenanceRecordWithBLOBs>> getAllRecords() {
        List<MaintenanceRecordWithBLOBs> records = maintenanceRecordService.getAllRecords();
        return ResponseEntity.ok(records);
    }

    @GetMapping("/{id}")
    public ResponseEntity<MaintenanceRecordWithBLOBs> getRecordById(
            @PathVariable Long id) {
        MaintenanceRecordWithBLOBs record = maintenanceRecordService.getRecordById(id);
        return ResponseEntity.ok(record);
    }

    @PutMapping("/{id}")
    public ResponseEntity<MaintenanceRecordWithBLOBs> updateRecord(
            @PathVariable Long id,
            @RequestBody MaintenanceRecordWithBLOBs recordDetails) {
        MaintenanceRecordWithBLOBs updatedRecord = maintenanceRecordService.updateRecord(id, recordDetails);
        return ResponseEntity.ok(updatedRecord);
    }

    @DeleteMapping("/{id}")
    public ResponseEntity<?> deleteRecord(@PathVariable Long id) {
        maintenanceRecordService.deleteRecord(id);
        return ResponseEntity.ok().build();
    }

    @GetMapping("/equipment/{equipmentId}")
    public ResponseEntity<List<MaintenanceRecordWithBLOBs>> getRecordsByEquipmentId(
            @PathVariable String equipmentId) {
        List<MaintenanceRecordWithBLOBs> records = maintenanceRecordService.getRecordsByEquipmentId(equipmentId);
        return ResponseEntity.ok(records);
    }
}
```
### 2. 创建Service接口
```java
package com.lisystem.service;

import com.lisystem.model.MaintenanceRecordWithBLOBs;
import java.util.List;

public interface MaintenanceRecordService {
    MaintenanceRecordWithBLOBs createRecord(MaintenanceRecordWithBLOBs record);
    List<MaintenanceRecordWithBLOBs> getAllRecords();
    MaintenanceRecordWithBLOBs getRecordById(Long id);
    MaintenanceRecordWithBLOBs updateRecord(Long id, MaintenanceRecordWithBLOBs recordDetails);
    void deleteRecord(Long id);
    List<MaintenanceRecordWithBLOBs> getRecordsByEquipmentId(String equipmentId);
}
```
### 3. 创建Service实现类
```java
package com.lisystem.service.impl;

import com.lisystem.model.MaintenanceRecordWithBLOBs;
import com.lisystem.repository.MaintenanceRecordRepository;
import com.lisystem.service.MaintenanceRecordService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class MaintenanceRecordServiceImpl implements MaintenanceRecordService {

    @Autowired
    private MaintenanceRecordRepository maintenanceRecordRepository;

    @Override
    public MaintenanceRecordWithBLOBs createRecord(MaintenanceRecordWithBLOBs record) {
        return maintenanceRecordRepository.save(record);
    }

    @Override
    public List<MaintenanceRecordWithBLOBs> getAllRecords() {
        return maintenanceRecordRepository.findAll();
    }

    @Override
    public MaintenanceRecordWithBLOBs getRecordById(Long id) {
        return maintenanceRecordRepository.findById(id)
                .orElseThrow(() -> new RuntimeException("Record not found with id: " + id));
    }

    @Override
    public MaintenanceRecordWithBLOBs updateRecord(Long id, MaintenanceRecordWithBLOBs recordDetails) {
        MaintenanceRecordWithBLOBs record = getRecordById(id);
        record.setEquipmentId(recordDetails.getEquipmentId());
        record.setReporter(recordDetails.getReporter());
        record.setLocation(recordDetails.getLocation());
        record.setImages(recordDetails.getImages());
        return maintenanceRecordRepository.save(record);
    }

    @Override
    public void deleteRecord(Long id) {
        maintenanceRecordRepository.deleteById(id);
    }

    @Override
    public List<MaintenanceRecordWithBLOBs> getRecordsByEquipmentId(String equipmentId) {
        return maintenanceRecordRepository.findByEquipmentId(equipmentId);
    }
}
```
### 4. 创建Repository接口
```java
package com.lisystem.repository;

import com.lisystem.model.MaintenanceRecordWithBLOBs;
import org.springframework.data.jpa.repository.JpaRepository;
import java.util.List;

public interface MaintenanceRecordRepository extends JpaRepository<MaintenanceRecordWithBLOBs, Long> {
    List<MaintenanceRecordWithBLOBs> findByEquipmentId(String equipmentId);
}
```

### 5. 添加DTO类（可选）
```java
package com.lisystem.dto;

import com.fasterxml.jackson.databind.JsonNode;
import org.locationtech.jts.geom.Point;

public class MaintenanceRecordDTO {
    private Long id;
    private String equipmentId;
    private String reporter;
    private Point location;
    private JsonNode images;

    // Getters and Setters
    // ...
}
```

这个实现提供了完整的CRUD操作，包括：
1. 创建维护记录
2. 获取所有记录
3. 根据ID获取单个记录
4. 更新记录
5. 删除记录
6. 根据设备ID查询相关记录


## 解释下MaintenanceRecordRepository
MaintenanceRecordRepository 是一个 Spring Data JPA 仓库接口，用于操作 MaintenanceRecordWithBLOBs 实体类的数据库访问。以下是详细解释：
### 核心功能
```java
public interface MaintenanceRecordRepository 
    extends JpaRepository<MaintenanceRecordWithBLOBs, Long> {
    // 继承自JpaRepository的所有方法自动实现
    List<MaintenanceRecordWithBLOBs> findByEquipmentId(String equipmentId);
}
```
1. 继承关系 继承 JpaRepository<MaintenanceRecordWithBLOBs, Long> 表示：   
   - 操作实体类： MaintenanceRecordWithBLOBs
   - 主键类型： Long
2. 自动实现的方法 通过继承获得的基础CRUD方法：
```java
save()          // 保存/更新记录
findById()      // 按ID查询
findAll()       // 查询所有记录
deleteById()    // 按ID删除
count()         // 计数
// ... 其他10+个方法
```
3. 自定义查询方法 
```java
List<MaintenanceRecordWithBLOBs> findByEquipmentId(String equipmentId);
```  
   - 根据设备ID查询关联的维护记录
   - 遵循Spring Data JPA的命名规范自动实现SQL
   - 等价SQL： SELECT * FROM maintenance_record WHERE equipment_id = ?
### 工作原理
1. 运行时自动生成实现 Spring Boot启动时会自动创建该接口的代理实现类
2. 方法命名规则
    方法名部分 对应SQL findBy   
   SELECT EquipmentId   
   WHERE equipment_id (参数)   
   条件值
3. 事务支持 所有方法默认添加 @Transactional 注解


### 在您的项目中， MyBatis 和 Spring Data JPA 是两种独立的持久层技术 ，它们之间没有直接关联。以下是具体分析：
### 1. 技术共存情况
- MyBatis 特征 ：  
  - 您的 MaintenanceRecordMapper.xml 文件存在（路径： d:\sbglapp\backend\src\main\resources\mapper\MaintenanceRecordMapper.xml ）
  - 使用 XML 配置 SQL 映射
  - 需要手动编写 SQL 或使用 MyBatis Generator 生成基础代码
- Spring Data JPA 特征 ：
  
  - 存在 MaintenanceRecordRepository 接口（路径： d:\sbglapp\backend\src\main\java\com\lisystem\repository\MaintenanceRecordRepository.java ）
  - 继承自 JpaRepository 接口
  - 使用方法名自动生成查询（如 findByEquipmentId ）
### 2. 实际使用模式
虽然两者共存，但根据代码观察：
- 主要使用 Spring Data JPA ：  
  - Controller 和 Service 层都调用的是 JPA 的 Repository 接口
  - 没有直接使用 MyBatis Mapper 的痕迹
- MyBatis 的可能用途 ：  
  - 可能是历史遗留代码
  - 或用于处理 JPA 不擅长的复杂 SQL 场景（但当前代码未体现）
### 3. 推荐做法
- 纯 JPA 项目 ：可以删除 MyBatis 相关配置和文件
- 混合使用场景 ：如需同时使用，建议：
  ```java
  // 在Service中同时注入两种Repository
  @Service
  public class SomeService {
      @Autowired
      private MaintenanceRecordRepository jpaRepository;
      
      @Autowired
      private SomeMapper mybatisMapper; 
  }
  ```
### 测试API ：
   使用curl测试API：
```bash
curl -v http://192.168.21.175:8081/api/maintenance-records
```

## 实现Equipment与前端交互的restful api
### Trae AI
参考了 2 个上下文
Equipment.java
Equipment.java 6-6
我将为您实现Equipment类的RESTful API接口。以下是完整的Controller实现：
```java
package com.lisystem.controller;

import com.lisystem.model.Equipment;
import com.lisystem.service.EquipmentService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/equipments")
public class EquipmentController {

    @Autowired
    private EquipmentService equipmentService;

    @GetMapping
    public ResponseEntity<List<Equipment>> getAllEquipments() {
        return ResponseEntity.ok(equipmentService.getAllEquipments());
    }

    @GetMapping("/{id}")
    public ResponseEntity<Equipment> getEquipmentById(@PathVariable String id) {
        return ResponseEntity.ok(equipmentService.getEquipmentById(id));
    }

    @PostMapping
    public ResponseEntity<Equipment> createEquipment(@RequestBody Equipment equipment) {
        return ResponseEntity.status(HttpStatus.CREATED)
                .body(equipmentService.createEquipment(equipment));
    }

    @PutMapping("/{id}")
    public ResponseEntity<Equipment> updateEquipment(
            @PathVariable String id, 
            @RequestBody Equipment equipment) {
        return ResponseEntity.ok(equipmentService.updateEquipment(id, equipment));
    }

    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteEquipment(@PathVariable String id) {
        equipmentService.deleteEquipment(id);
        return ResponseEntity.noContent().build();
    }

    @GetMapping("/status/{status}")
    public ResponseEntity<List<Equipment>> getEquipmentsByStatus(
            @PathVariable String status) {
        return ResponseEntity.ok(equipmentService.getEquipmentsByStatus(status));
    }

    @GetMapping("/last-maintenance")
    public ResponseEntity<List<Equipment>> getEquipmentsNeedMaintenance() {
        return ResponseEntity.ok(equipmentService.getEquipmentsNeedMaintenance());
    }
}
```

对应的Service接口实现：
```java
package com.lisystem.service;

import com.lisystem.model.Equipment;
import java.util.List;

public interface EquipmentService {
    List<Equipment> getAllEquipments();
    Equipment getEquipmentById(String id);
    Equipment createEquipment(Equipment equipment);
    Equipment updateEquipment(String id, Equipment equipment);
    void deleteEquipment(String id);
    List<Equipment> getEquipmentsByStatus(String status);
    List<Equipment> getEquipmentsNeedMaintenance();
}
```

Service实现类：
```java
package com.lisystem.service.impl;

import com.lisystem.model.Equipment;
import com.lisystem.repository.EquipmentRepository;
import com.lisystem.service.EquipmentService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.Date;
import java.util.List;

@Service
public class EquipmentServiceImpl implements EquipmentService {

    @Autowired
    private EquipmentRepository equipmentRepository;

    @Override
    public List<Equipment> getAllEquipments() {
        return equipmentRepository.findAll();
    }

    @Override
    public Equipment getEquipmentById(String id) {
        return equipmentRepository.findById(id).orElseThrow();
    }

    @Override
    public Equipment createEquipment(Equipment equipment) {
        return equipmentRepository.save(equipment);
    }

    @Override
    public Equipment updateEquipment(String id, Equipment equipment) {
        equipment.setId(id);
        return equipmentRepository.save(equipment);
    }

    @Override
    public void deleteEquipment(String id) {
        equipmentRepository.deleteById(id);
    }

    @Override
    public List<Equipment> getEquipmentsByStatus(String status) {
        return equipmentRepository.findByStatus(status);
    }

    @Override
    public List<Equipment> getEquipmentsNeedMaintenance() {
        Date threshold = new Date(System.currentTimeMillis() - 30L * 24 * 60 * 60 * 1000);
        return equipmentRepository.findByLastMaintenanceBeforeOrLastMaintenanceIsNull(threshold);
    }
}
```

对应的Repository接口：
```java
package com.lisystem.repository;

import com.lisystem.model.Equipment;
import org.springframework.data.jpa.repository.JpaRepository;
import java.util.Date;
import java.util.List;

public interface EquipmentRepository extends JpaRepository<Equipment, String> {
    List<Equipment> findByStatus(String status);
    List<Equipment> findByLastMaintenanceBeforeOrLastMaintenanceIsNull(Date date);
}
```

这个实现提供了完整的CRUD操作和两个业务查询：
1. 按状态查询设备
2. 查询需要维护的设备（超过30天未维护）
前端可以通过以下接口访问：
- GET /api/equipments - 获取所有设备
- GET /api/equipments/{id} - 获取单个设备
- POST /api/equipments - 创建新设备
- PUT /api/equipments/{id} - 更新设备
- DELETE /api/equipments/{id} - 删除设备
- GET /api/equipments/status/{status} - 按状态查询
- GET /api/equipments/last-maintenance - 查询需维护设备


## EquipmentController.java Equipment.java 根据EquipmentController创建相应的前端交互页面，包含增删改查操作
我将为您创建一个基于React的前端页面，包含对Equipment的增删改查操作。以下是完整的实现方案：
### 1. 设备列表页面 (EquipmentList.js)
```javascript
import React, { useState, useEffect } from 'react';
import { Table, Button, Space, Modal, message } from 'antd';
import EquipmentForm from './EquipmentForm';
import api from '../api';

const EquipmentList = () => {
  const [equipments, setEquipments] = useState([]);
  const [visible, setVisible] = useState(false);
  const [current, setCurrent] = useState(null);

  useEffect(() => {
    fetchEquipments();
  }, []);

  const fetchEquipments = async () => {
    try {
      const { data } = await api.get('/api/equipments');
      setEquipments(data);
    } catch (error) {
      message.error('获取设备列表失败');
    }
  };

  const handleDelete = async (id) => {
    try {
      await api.delete(`/api/equipments/${id}`);
      message.success('删除成功');
      fetchEquipments();
    } catch (error) {
      message.error('删除失败');
    }
  };

  const columns = [
    { title: 'ID', dataIndex: 'id', key: 'id' },
    { title: '名称', dataIndex: 'name', key: 'name' },
    { title: '型号', dataIndex: 'model', key: 'model' },
    { title: '状态', dataIndex: 'status', key: 'status' },
    { title: '二维码', dataIndex: 'qrCode', key: 'qrCode' },
    { title: '最后维护', dataIndex: 'lastMaintenance', key: 'lastMaintenance' },
    {
      title: '操作',
      key: 'action',
      render: (_, record) => (
        <Space size="middle">
          <Button onClick={() => { setCurrent(record); setVisible(true); }}>编辑</Button>
          <Button danger onClick={() => handleDelete(record.id)}>删除</Button>
        </Space>
      ),
    },
  ];

  return (
    <div>
      <Button type="primary" onClick={() => { setCurrent(null); setVisible(true); }} style={{ marginBottom: 16 }}>
        新增设备
      </Button>
      <Table columns={columns} dataSource={equipments} rowKey="id" />
      <EquipmentForm 
        visible={visible} 
        onCancel={() => setVisible(false)} 
        onSuccess={fetchEquipments}
        current={current}
      />
    </div>
  );
};

export default EquipmentList;
```

### 2. 设备表单组件 (EquipmentForm.js)
```javascript
import React, { useEffect } from 'react';
import { Modal, Form, Input, Select, DatePicker, message } from 'antd';
import api from '../api';

const { Option } = Select;

const EquipmentForm = ({ visible, onCancel, onSuccess, current }) => {
  const [form] = Form.useForm();

  useEffect(() => {
    if (current) {
      form.setFieldsValue(current);
    } else {
      form.resetFields();
    }
  }, [current, form]);

  const handleSubmit = async () => {
    try {
      const values = await form.validateFields();
      if (current) {
        await api.put(`/api/equipments/${current.id}`, values);
        message.success('更新成功');
      } else {
        await api.post('/api/equipments', values);
        message.success('创建成功');
      }
      onSuccess();
      onCancel();
    } catch (error) {
      message.error('操作失败');
    }
  };

  return (
    <Modal
      title={current ? '编辑设备' : '新增设备'}
      visible={visible}
      onOk={handleSubmit}
      onCancel={onCancel}
      forceRender
    >
      <Form form={form} layout="vertical">
        <Form.Item name="name" label="设备名称" rules={[{ required: true }]}>
          <Input />
        </Form.Item>
        <Form.Item name="model" label="设备型号">
          <Input />
        </Form.Item>
        <Form.Item name="status" label="状态" rules={[{ required: true }]}>
          <Select>
            <Option value="RUNNING">运行中</Option>
            <Option value="MAINTENANCE">维护中</Option>
            <Option value="FAULT">故障</Option>
          </Select>
        </Form.Item>
        <Form.Item name="qrCode" label="二维码">
          <Input />
        </Form.Item>
        <Form.Item name="lastMaintenance" label="最后维护时间">
          <DatePicker showTime style={{ width: '100%' }} />
        </Form.Item>
      </Form>
    </Modal>
  );
};

export default EquipmentForm;
```

### 3. API配置 (api.js)
```javascript
import axios from 'axios';

const api = axios.create({
  baseURL: 'http://192.168.21.175:8081',
  timeout: 5000,
});

api.interceptors.response.use(
  response => response.data,
  error => {
    console.error('API Error:', error);
    return Promise.reject(error);
  }
);

export default api;
 ```

### 4. 主应用入口 (App.js)
```javascript
import React from 'react';
import { BrowserRouter as Router, Route } from 'react-router-dom';
import { Layout } from 'antd';
import EquipmentList from './pages/EquipmentList';
import './App.css';

const { Content } = Layout;

function App() {
  return (
    <Router>
      <Layout className="layout">
        <Content style={{ padding: '50px' }}>
          <Route path="/" exact component={EquipmentList} />
        </Content>
      </Layout>
    </Router>
  );
}

export default App;
```

### 5. 安装所需依赖
```bash
cd d:\sbglapp\frontend
npm install axios antd react-router-dom
 ```

### 功能说明
1. 设备列表 ：展示所有设备信息，包括ID、名称、型号、状态等
2. 新增设备 ：点击"新增设备"按钮打开表单
3. 编辑设备 ：点击每行的"编辑"按钮打开表单
4. 删除设备 ：点击每行的"删除"按钮删除设备
5. 表单验证 ：名称和状态为必填项
6. 状态管理 ：自动刷新列表数据
这个实现使用了Ant Design组件库，提供了美观的UI界面和良好的用户体验。您可以根据实际需求进一步调整样式和功能。

### 启动前端应用
```shell
PS D:\sbglapp> npm start
```

## 如何将sbglapp提交到github仓库
要将您的React项目提交到GitHub仓库，请按照以下步骤操作：
### 1. 初始化本地Git仓库
```bash
cd d:\sbglapp
git init
 ```

### 2. 创建.gitignore文件
```plaintext
# 依赖目录
node_modules/

# 环境文件
.env
.env.local

# 构建输出
build/
dist/

# 编辑器目录
.vscode/
.idea/

# 系统文件
.DS_Store
 ```

### 3. 添加文件到暂存区
```bash
git add .
 ```

### 4. 提交初始版本
```bash
git commit -m "Initial commit"
 ```

### 5. 在GitHub创建新仓库
1. 登录GitHub
2. 点击右上角"+" → "New repository"
3. 输入仓库名称(如sbglapp)
4. 选择公开/私有
5. 点击"Create repository"
### 6. 关联远程仓库并推送
```bash
git remote add origin https://github.com/你的用户名/sbglapp.git
git branch -M main
git push -u origin main
```

### 7. 后续更新代码流程
```bash
git add .
git commit -m "描述你的修改"
git push
 ```

### 8. 可选配置（如需要）
1. 添加README.md文件：
```markdown
# SBGL App

设备管理系统前端

## 技术栈
- React
- Ant Design
- Axios

## 安装
npm install

## 运行
npm start
 ```

## 创建用户登录restful api，用于前端交互；设计用户表、角色表、用户角色表，添加数据库持久化；用户名密码验证；Token生成机制；前后端交互协议；实现权限控制。 
我将为您设计一个完整的用户认证系统解决方案，包含数据库设计、API实现和权限控制。
### 1. 数据库设计 (MySQL)
```sql
-- 用户表
CREATE TABLE `sys_user` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password` varchar(100) NOT NULL COMMENT '密码',
  `salt` varchar(20) COMMENT '加密盐值',
  `status` tinyint DEFAULT 1 COMMENT '状态 0:禁用 1:正常',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_username` (`username`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 角色表
CREATE TABLE `sys_role` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL COMMENT '角色名称',
  `code` varchar(50) NOT NULL COMMENT '角色编码',
  `description` varchar(100) COMMENT '描述',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 用户角色关联表
CREATE TABLE `sys_user_role` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `user_id` bigint NOT NULL,
  `role_id` bigint NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_user_role` (`user_id`, `role_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 初始化数据
INSERT INTO `sys_role` VALUES (1, '管理员', 'ROLE_ADMIN', '系统管理员');
INSERT INTO `sys_role` VALUES (2, '普通用户', 'ROLE_USER', '普通用户');

-- 密码为123456 (加密后)
INSERT INTO `sys_user` VALUES (1, 'admin', '$2a$10$N.zmdr9k7uOCQb376NoUnuTJ8iAt6Z5EHsM8lE9lBOsl7iKTVKIUi', '', 1, NOW());
INSERT INTO `sys_user_role` VALUES (1, 1, 1);
```

### 2. Spring Boot 实体类
```java
@Data
@Entity
@Table(name = "sys_user")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(unique = true, nullable = false)
    private String username;
    
    @Column(nullable = false)
    private String password;
    
    private String salt;
    private Integer status;
    private LocalDateTime createTime;
    
    @ManyToMany(fetch = FetchType.EAGER)
    @JoinTable(name = "sys_user_role",
        joinColumns = @JoinColumn(name = "user_id"),
        inverseJoinColumns = @JoinColumn(name = "role_id"))
    private Set<Role> roles = new HashSet<>();
}
```

```java
@Data
@Entity
@Table(name = "sys_role")
public class Role {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false)
    private String name;
    
    @Column(unique = true, nullable = false)
    private String code;
    
    private String description;
}
```

### 3. JWT Token 工具类
```java
@Component
public class JwtUtil {
    @Value("${jwt.secret}")
    private String secret;
    
    @Value("${jwt.expiration}")
    private Long expiration;
    
    public String generateToken(UserDetails userDetails) {
        Map<String, Object> claims = new HashMap<>();
        return Jwts.builder()
                .setClaims(claims)
                .setSubject(userDetails.getUsername())
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + expiration * 1000))
                .signWith(SignatureAlgorithm.HS512, secret)
                .compact();
    }
    
    public String getUsernameFromToken(String token) {
        return Jwts.parser().setSigningKey(secret).parseClaimsJws(token).getBody().getSubject();
    }
    
    public boolean validateToken(String token, UserDetails userDetails) {
        final String username = getUsernameFromToken(token);
        return (username.equals(userDetails.getUsername()) && !isTokenExpired(token));
    }
    
    private boolean isTokenExpired(String token) {
        final Date expiration = getExpirationDateFromToken(token);
        return expiration.before(new Date());
    }
}
```

### 4. Spring Security 配置
```java
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    
    @Autowired
    private UserDetailsServiceImpl userDetailsService;
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
    
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.userDetailsService(userDetailsService).passwordEncoder(passwordEncoder());
    }
    
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.csrf().disable()
            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            .and()
            .authorizeRequests()
            .antMatchers("/auth/**").permitAll()
            .anyRequest().authenticated()
            .and()
            .addFilter(new JwtAuthenticationFilter(authenticationManager(), jwtUtil))
            .addFilter(new JwtAuthorizationFilter(authenticationManager(), jwtUtil, userDetailsService));
    }
}
```

### 5. 认证API接口
```java
@RestController
@RequestMapping("/auth")
public class AuthController {
    
    @Autowired
    private AuthenticationManager authenticationManager;
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest loginRequest) {
        try {
            Authentication authentication = authenticationManager.authenticate(
                new UsernamePasswordAuthenticationToken(
                    loginRequest.getUsername(),
                    loginRequest.getPassword()
                )
            );
            
            SecurityContextHolder.getContext().setAuthentication(authentication);
            String jwt = jwtUtil.generateToken((UserDetails) authentication.getPrincipal());
            
            return ResponseEntity.ok(new JwtResponse(jwt));
        } catch (AuthenticationException e) {
            return ResponseEntity.status(401).body("用户名或密码错误");
        }
    }
    
    @GetMapping("/info")
    public ResponseEntity<?> getUserInfo() {
        UserDetails userDetails = (UserDetails) SecurityContextHolder.getContext()
            .getAuthentication().getPrincipal();
        
        return ResponseEntity.ok(userDetails);
    }
}
```

### 6. 前端交互调整
```javascript
// 添加请求拦截器
api.interceptors.request.use(config => {
  const token = localStorage.getItem('token');
  if (token) {
    config.headers['Authorization'] = `Bearer ${token}`;
  }
  return config;
}, error => {
  return Promise.reject(error);
});

// 添加响应拦截器
api.interceptors.response.use(response => {
  return response.data;
}, error => {
  if (error.response.status === 401) {
    localStorage.removeItem('token');
    window.location.href = '/login';
  }
  return Promise.reject(error);
});
```

### 7. 权限控制注解使用示例
```java
@RestController
@RequestMapping("/api/equipments")
public class EquipmentController {
    
    @PreAuthorize("hasRole('ROLE_ADMIN')")
    @PostMapping
    public ResponseEntity<?> createEquipment(@RequestBody Equipment equipment) {
        // 只有管理员可以创建设备
    }
    
    @PreAuthorize("hasAnyRole('ROLE_ADMIN', 'ROLE_USER')")
    @GetMapping
    public ResponseEntity<?> getEquipments() {
        // 管理员和普通用户都可以查看设备
    }
}
```

这个实现提供了完整的用户认证系统，包含：
1. 基于JWT的Token认证机制
2. 角色权限控制
3. 密码加密存储
4. 前后端交互协议
5. 数据库持久化
您可以根据实际需求进行调整和扩展。

2. 添加LICENSE文件（如需要）
完成以上步骤后，您的项目就会出现在GitHub仓库中。如果遇到权限问题，可能需要配置SSH密钥或使用GitHub CLI工具进行认证。


通过命令行查看完整依赖：
```bash
./gradlew dependencies
 ```

 ## 图片素材下载网址：
 ```shell
 https://unsplash.com/s/photos/summer
 ```

 这是一个基于Spring Boot的后端和React前端的全栈企业应用平台。以下是部署到CentOS 8服务器的最优解决方案：
### 1. 服务器环境准备
```bash
# 安装基础依赖
sudo yum install -y java-17-openjdk-devel nodejs npm git

# 安装MySQL (根据实际需求选择版本)
sudo yum install -y mysql-server
sudo systemctl start mysqld
sudo systemctl enable mysqld
```

### 2. 数据库部署
```bash
# 创建数据库和用户(根据backend/src/main/resources/application.properties配置)
mysql -u root -p
CREATE DATABASE enterprise_platform;
CREATE USER 'platform_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON enterprise_platform.* TO 'platform_user'@'localhost';
FLUSH PRIVILEGES;
```

### 3. 后端部署
```bash
# 克隆项目
git clone https://github.com/zuijiaoghb/EnterpriseApplicationPlatform.git
cd EnterpriseApplicationPlatform/backend

# 构建
./gradlew clean build

# 部署JAR包
nohup java -jar build/libs/enterprise-platform-backend-0.0.1.jar > backend.log 2>&1 &
```

### 4. 前端部署
```bash
cd ../frontend
npm install
npm run build

# 安装nginx作为前端服务器
sudo yum install -y nginx
sudo systemctl start nginx
sudo systemctl enable nginx

# 配置nginx
sudo vi /etc/nginx/conf.d/enterprise-platform.conf
```

添加以下nginx配置：
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        root /path/to/EnterpriseApplicationPlatform/frontend/build;
        try_files $uri $uri/ /index.html;
    }
    
    location /api {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 5. 安全加固
- 配置HTTPS(使用Let's Encrypt免费证书)
- 配置防火墙规则
- 设置进程监控(使用PM2管理前端进程)
### 6. 持续部署建议
建议配置CI/CD流程，可以使用：
- Jenkins/GitHub Actions自动化构建
- Ansible进行服务器配置管理
- Docker容器化部署(可选)
需要根据实际网络环境和安全要求调整上述方案。部署后请测试所有核心功能，特别是OAuth2认证流程和数据库连接。

## 查看centos8系统磁盘空间
```shell
[root@BISERVER opt]# df -h
文件系统             容量  已用  可用 已用% 挂载点
devtmpfs              16G     0   16G    0% /dev
tmpfs                 16G     0   16G    0% /dev/shm
tmpfs                 16G  282M   16G    2% /run
tmpfs                 16G     0   16G    0% /sys/fs/cgroup
/dev/mapper/cl-root   64G   23G   42G   36% /
/dev/sda2           1014M  344M  671M   34% /boot
/dev/sda1            599M  7.3M  592M    2% /boot/efi
/dev/mapper/cl-home   31G  265M   31G    1% /home
/dev/sdb1            500G  5.6G  495G    2% /tmp
overlay               64G   23G   42G   36% /var/lib/docker/overlay2/1b81e6bcf3331134606e10a8067fd66d32ba5a39f586ce6ccbbf711e4f6e3593/merged
tmpfs                3.2G   36K  3.2G    1% /run/user/0
/dev/sr0              11G   11G     0  100% /run/media/root/CentOS-8-5-2111-x86_64-dvd
[root@BISERVER opt]# df -h .
文件系统             容量  已用  可用 已用% 挂载点
/dev/mapper/cl-root   64G   23G   42G   36% /
```
## centos8查看所有设备
```shell
[root@BISERVER usr]# lsblk
NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda           8:0    0  100G  0 disk
├─sda1        8:1    0  600M  0 part /boot/efi
├─sda2        8:2    0    1G  0 part /boot
└─sda3        8:3    0 98.4G  0 part
  ├─cl-root 253:0    0 63.5G  0 lvm  /
  ├─cl-swap 253:1    0    4G  0 lvm  [SWAP]
  └─cl-home 253:2    0   31G  0 lvm  /home
sdb           8:16   0  500G  0 disk 
└─sdb1        8:17   0  500G  0 part /tmp
sdc           8:32   0  500G  0 disk
sr0          11:0    1 1
```

## 根据CentOS 8系统环境和现有磁盘情况，以下是创建新硬盘并挂载到/app目录的最佳实践方案：
1. 添加新硬盘
2. 格式化分区
```bash
# 格式化为XFS文件系统（推荐）
sudo mkfs.xfs /dev/sdc1
 ```

3. 创建挂载点并挂载
```bash
# 创建/app目录
sudo mkdir /app

# 临时挂载
sudo mount /dev/sdc1 /app

# 验证挂载
df -h /app
 ```

4. 配置永久挂载
```bash
# 获取分区UUID
sudo blkid /dev/sdc1

# 编辑fstab文件
sudo vi /etc/fstab
# 添加以下内容（替换实际UUID）：
UUID=你的分区UUID /app xfs defaults 0 0

# 测试fstab配置
sudo mount -a
 ```

 ## 在CentOS 8环境下升级Node.js到LTS版本的最佳实践如下：
1. 清理旧版本（如有）
```bash
sudo yum remove -y nodejs npm
 ```

2. 安装NodeSource仓库
```bash
curl -fsSL https://rpm.nodesource.com/setup_lts.x | sudo bash -
```

3. 安装Node.js LTS版本
```bash
sudo yum install -y nodejs
 ```

4. 验证安装
```bash
node -v  # 应显示v18.x或更高LTS版本
npm -v
 ```

5. 设置npm淘宝镜像（可选）
```bash
npm config set registry https://registry.npmmirror.com
```

注意事项：
1. 需要root权限执行上述命令
2. 如果遇到GPG密钥错误，可添加 --nogpgcheck 参数
3. 升级后建议重新安装项目依赖：
```bash
rm -rf node_modules package-lock.json
npm install
 ```

 # 运行时可指定端口
PORT=3001 npm start

## 客户端生成Oauth2 token: http://192.168.21.175:8081/auth/oauth2/token
headers: {
 Content-Type: application/x-www-form-urlencoded,
}
body: {
 grant_type: client_credentials,
 client_id: client004,
 client_secret: 84148002bc394d16aaa54f46beaa028d
}
response: {
    "access_token": "eyJraWQiOiJIUzI1Ni1LRVkiLCJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJjbGllbnQwMDEiLCJyb2xlcyI6WyJST0xFX0NMSUVOVCJdLCJpc3MiOiJlbnRlcnByaXNlLXBsYXRmb3JtIiwic2NvcGVzIjpbImFwaS5yZWFkIl0sImV4cCI6MTc0NTU3MDc1NSwiaWF0IjoxNzQ1NTY4OTU1fQ.nn0Ub5_eCrMqGYhy_Y6NYo6YOqPkSkO-kcMIo2kGcnQ",
    "token_type": "Bearer",
    "expires_in": 1800,
    "scope": "api.read"
}

http://192.168.21.175:8081/api/users
Authorizatio:eyJraWQiOiJIUzI1Ni1LRVkiLCJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJjbGllbnQwMDEiLCJyb2xlcyI6WyJST0xFX0NMSUVOVCJdLCJpc3MiOiJlbnRlcnByaXNlLXBsYXRmb3JtIiwic2NvcGVzIjpbImFwaS5yZWFkIl0sImV4cCI6MTc0NTU3MDc1NSwiaWF0IjoxNzQ1NTY4OTU1fQ.nn0Ub5_eCrMqGYhy_Y6NYo6YOqPkSkO-kcMIo2kGcnQ

headers: {
    Content-Type: application/json
}


## 按照此项目，添加andriod和IOS和鸿蒙移动端应用，共用现有后端逻辑，全面考虑，给出最佳实践：
为现有企业应用平台添加移动端支持，建议采用跨平台框架如Flutter或React Native，可以同时覆盖Android、iOS和鸿蒙系统。需要创建新的移动端项目目录，保持与现有后端的API兼容性，并考虑移动端特有的认证、缓存和离线功能。建议在backend目录下新增mobile子项目，共享现有用户认证和业务逻辑API。
基于现有企业应用平台，我将为您创建一个跨平台移动端解决方案，覆盖Android、iOS和鸿蒙系统。以下是实施计划：
1. 技术选型 ：
   - 采用React Native框架，因其出色的跨平台能力和对鸿蒙的良好支持
   - 使用现有后端API，保持认证和业务逻辑一致性
2. 项目结构 ：
Open Folder
EnterpriseApplicationPlatform/

├── backend/ (现有后端)

├── frontend/ (现有前端)

└── mobile/ (新增移动端)

├── android/ (Android特定配置)

├── ios/ (iOS特定配置)

├── harmony/ (鸿蒙特定配置)

├── lib/ (共享代码)

├── pubspec.yaml (依赖管理)

└── README.md

3. 关键实现点 ：
   - 复用现有JWT认证机制
   - 添加移动端特有的本地存储和离线功能
   - 优化API调用以适应移动网络环境
   - 实现统一的UI组件库

4. 建议采用React Native框架实现跨平台移动应用，可以复用现有后端API接口。需要创建新的mobile目录，初始化React Native项目，并配置与后端相同的JWT认证机制。建议修改AuthController的CORS配置以支持移动端访问，并创建专用的移动端API客户端。
初始化React Native项目并创建mobile目录。
EnterpriseApplicationPlatform
```shell
npx --yes react-native@0.72.7 init mobile --template react-native-template-typescript
```
尝试使用Expo CLI初始化React Native项目，因为React Native CLI初始化存在问题。
npx --yes create-expo-app mobile --template blank-typescript
安装React Native项目所需的依赖项。

使用Expo Go应用扫描二维码在真机上预览:
1. 安装Expo Go ：
   - 通过浏览器访问Expo官网下载APK
    安装完成后，打开Expo Go应用即可扫描开发服务器二维码预览React Native项目。
    使用Expo Go在真机上预览React Native应用的步骤如下：
   - 在iOS设备上通过App Store安装Expo Go
   - 在Android设备上通过Google Play安装Expo Go
2. 启动开发服务器 ：
   bash
   运行
   Open Folder
   cd mobile
   npm start
   这会启动Metro打包器并显示二维码
3. 扫描二维码 ：
   - 打开Expo Go应用
   - 点击"Scan QR Code"选项
   - 扫描终端显示的二维码
4. 等待加载 ：
   - 应用会自动下载JS bundle并启动
   - 首次加载可能需要较长时间
5. 调试功能 ：
   - 摇动设备可打开开发者菜单
   - 支持热重载和实时错误显示
注意：确保手机和开发电脑在同一局域网下，且防火墙未阻止8082端口。

安装新添加的依赖包以解决Babel预设缺失问题。
EnterpriseApplicationPlatform\mobile 终端
```shell
npm install
```

PS D:\EnterpriseApplicationPlatform\mobile> npm install axios --save                    
added 4 packages, and audited 1198 packages in 8s
174 packages are looking for funding
  run `npm fund` for details
6 vulnerabilities (2 low, 4 high)
To address all issues (including breaking changes), run:
  npm audit fix --force
Run `npm audit` for details.


EAS(Expo Application Services)的账号注册步骤如下：
1. 访问Expo官网: https://expo.dev
2. 点击右上角"Sign Up"按钮
3. 可以选择使用GitHub账号登录或邮箱注册
4. 完成邮箱验证后即可使用
注册完成后，可以在终端运行 eas login 命令登录你的Expo账号。登录后即可使用EAS的各项服务，包括应用构建和发布等。


### 如何打包发布mobile项目成apk文件
检测到需要将React Native项目打包为APK文件，建议按照官方文档步骤配置签名和构建流程。根据项目结构，应该在mobile项目中配置Android签名密钥并运行构建命令生成APK。
要将React Native项目打包为APK文件，需要完成以下步骤：
1. 首先确保Android开发环境已配置好：
   - 安装Android Studio
   - 配置Java JDK
   - 设置ANDROID_HOME环境变量
2. 生成签名密钥：
```shell
keytool -genkey -v -keystore my-release-key.keystore -alias my-key-alias -keyalg RSA -keysize 2048 -validity 10000
```
PS D:\EnterpriseApplicationPlatform\mobile> keytool -genkey -v -keystore my-release-key.keystore -alias my-key-alias -keyalg RSA -keysize 2048 -validity 10000
输入密钥库口令:  
再次输入新口令: 
您的名字与姓氏是什么?
  [Unknown]:  yanshu
您的组织单位名称是什么?
  [Unknown]:  yanshu
您的组织名称是什么?
  [Unknown]:  yanshu
您所在的城市或区域名称是什么?
  [Unknown]:  nanchang
您所在的省/市/自治区名称是什么?
  [Unknown]:  nanchang
该单位的双字母国家/地区代码是什么?
  [Unknown]:  cn
CN=yanshu, OU=yanshu, O=yanshu, L=nanchang, ST=nanchang, C=cn是否正确?
  [否]:  y

正在为以下对象生成 2,048 位RSA密钥对和自签名证书 (SHA256withRSA) (有效期为 10,000 天):
         CN=yanshu, OU=yanshu, O=yanshu, L=nanchang, ST=nanchang, C=cn
[正在存储my-release-key.keystore]

3. 配置gradle.properties文件（位于android目录下）：
```shell
MYAPP_RELEASE_STORE_FILE=my-release-key.keystore
MYAPP_RELEASE_KEY_ALIAS=my-key-alias
MYAPP_RELEASE_STORE_PASSWORD=*****
MYAPP_RELEASE_KEY_PASSWORD=*****
```
4. 修改android/app/build.gradle文件：
```shell
android {
...
signingConfigs {

release {

storeFile file

( MYAPP_RELEASE_STORE_FILE )

storePassword

MYAPP_RELEASE_STORE_PASSWORD

keyAlias

MYAPP_RELEASE_KEY_ALIAS

keyPassword

MYAPP_RELEASE_KEY_PASSWORD

}

}

buildTypes {

release {
...

signingConfig

signingConfigs . release

}

}

}
```

5. 生成APK文件：
bash
运行
Open Folder
cd android && ./gradlew assembleRelease
PS D:\EnterpriseApplicationPlatform\mobile\android> ./gradlew.bat assembleRelease 
生成的APK文件将位于： android/app/build/outputs/apk/release/app-release.apk

注意事项：
- 请妥善保管签名密钥文件，丢失后将无法更新应用
- 建议将签名信息存储在安全的地方，不要直接提交到版本控制
- 如需发布到Google Play，还需要创建应用签名密钥


## Android设备已通过USB线连接电脑，如何开启USB调试模式
要在Android设备上开启USB调试模式，请按照以下步骤操作：
1. 进入开发者选项
   - 打开设备的"设置"应用
   - 找到"关于手机"或"系统"选项
   - 连续点击"版本号"7次，直到看到"您现在是开发者"的提示
2. 启用USB调试
   - 返回设置主界面，现在可以看到"开发者选项"
   - 进入"开发者选项"
   - 找到"USB调试"选项并启用它，打开监控ADB安装应用，选择USB配置：RNDIS(USB以太网)
3. 连接电脑
   - 使用USB线连接设备和电脑
   - 设备上会弹出"允许USB调试吗？"的对话框
   - 勾选"始终允许此计算机"并点击"确定"
完成后，您就可以通过ADB命令与设备交互了。如果连接后设备未显示，可能需要检查USB驱动程序是否已正确安装。

## 使用 adb install 命令安装debug版本进行测试的步骤如下：
1. 构建debug版本APK
   ```
   cd 
   d:\EnterpriseApplicationPlatform\mobil
   e\android
   .\gradlew.bat assembleDebug
   ```
   生成的APK路径： app/build/outputs/apk/debug/app-debug.apk
2. 连接设备
   - 确保Android设备已开启USB调试模式（设置 > 开发者选项 > USB调试）
   - 通过USB连接电脑后执行：
   ```
   adb devices
   ```
   确认设备列表中显示你的设备（如 emulator-5554   device ）
3. 安装APK
   ```
   adb install -r app/build/outputs/apk/
   debug/app-debug.apk
   ```
   ```
   PS D:\EnterpriseApplicationPlatform\mobile\android> adb install -r app/build/outputs/apk/release/app-release.apk
   ```
   参数说明：
   - -r ：覆盖安装
   - 如需保留数据可加 -d 参数
4. 启动应用
   ```
   adb shell am start -n com.
   enterpriseapplicationplatform.mobile/.
   MainActivity
   ```
5. 查看实时日志
   ```
   adb logcat -s MainActivity:V ReactNative:V *:S
   ```
   ```
   PS D:\EnterpriseApplicationPlatform\mobile\android> adb logcat -s ReactNative:V ReactNativeJS:V *:S
   ```
   ```
   PS D:\EnterpriseApplicationPlatform\mobile\android> adb logcat -d \*:E  
   ```
   此命令会过滤显示MainActivity和ReactNative的日志信息
注意：如果遇到 INSTALL_FAILED_UPDATE_INCOMPATIBLE 错误，可先卸载旧版本：
```
adb uninstall com.
enterpriseapplicationplatform.mobile
```

## 将tsx页面打包成bundle文件，以便在Android应用中使用
```
PS D:\EnterpriseApplicationPlatform\mobile> npx react-native bundle --platform android --dev false --entry-file index.ts --bundle-output android/app/src/main/assets/index.android.bundle --assets-dest android/app/src/main/res/
                Welcome to Metro v0.82.3
              Fast - Scalable - Integrated


info Writing bundle output to: android/app/src/main/assets/index.android.bundleinfo Done writing bundle output
info Copying 40 asset files
info Done copying assets
```

## adb 日志
```
PS D:\EnterpriseApplicationPlatform\mobile\android> adb install -r d:\EnterpriseApplicationPlatform\mobile\android\app\build\outputs\apk\release\app-release.apk
Performing Streamed Install
Success
PS D:\EnterpriseApplicationPlatform\mobile\android> adb shell am start -n com.enterpriseapplicationplatform.mobile/.MainActivity              
Starting: Intent { cmp=com.enterpriseapplicationplatform.mobile/.MainActivity }
PS D:\EnterpriseApplicationPlatform\mobile\android> adb pull /storage/emulated/0/Android/data/com.enterpriseapplicationplatform.mobile/files/crash_log.txt
/storage/emulated/0/Android/data/c...d. 1.0 MB/s (2874 bytes in 0.003s)
```
## adb logcat查看错误日志的命令
1. 查看所有错误日志
```
adb logcat *:E
```
2. 查看特定应用错误日志
```
adb logcat -s MainActivity:E 
MainApplication:E
```
3. 带时间戳的错误日志
```
adb logcat -v time *:E
```
4. 将错误日志保存到文件
```
adb logcat -c
然后PS D:\EnterpriseApplicationPlatform\mobile\android> adb install -r d:\EnterpriseApplicationPlatform\mobile\android\app\build\outputs\apk\release\app-release.apk
PS D:\EnterpriseApplicationPlatform\mobile\android> adb shell am start -n com.enterpriseapplicationplatform.mobile/.MainActivity
adb logcat *:E > errors.log
```
5. 清除旧日志后查看新错误
```
adb logcat -c && adb logcat *:E
```
这些命令可以帮助您快速定位应用崩溃和错误问题

## 在Expo项目中预先生成本地原生代码
PS D:\EnterpriseApplicationPlatform\mobile\android> npx expo prebuild
npx expo prebuild 是Expo CLI的一个命令，用于在Expo项目中预先生成本地原生代码。主要作用包括：

1. 生成原生项目文件 创建iOS和Android原生目录结构
2. 配置原生依赖 自动处理React Native原生模块的链接
3. 定制化配置 支持通过 app.json 自定义原生配置
4. 工作流程优化 允许开发者在EAS Build前本地测试原生代码
5. 典型使用场景
   
   - 需要修改原生代码时
   - 需要调试原生模块时
   - 准备EAS Build前


## 创建react native项目
```
npx --yes @react-native-community/cli init MobileApp --template react-native-template-typescript
```
### 使用默认模板重新初始化React Native项目，解决模板配置文件缺失问题。
```
npx --yes @react-native-community/cli init MobileApp
```
项目初始化完成后，您可以：
1. 进入MobileApp目录： cd MobileApp
2. 启动Android模拟器或连接真机
3. 运行项目： npx react-native run-android
PS D:\EnterpriseApplicationPlatform\mobileend\MobileApp> npx react-native start

### 打包生成index.android.bundle bundle文件
```
PS D:\EnterpriseApplicationPlatform\mobileend> npx react-native bundle --platform android --dev false --entry-file index.js --bundle-output android/app/src/main/assets/index.android.bundle --assets-dest android/app/src/main/res
                Welcome to Metro v0.82.3
              Fast - Scalable - Integrated


Writing bundle output to: android/app/src/main/assets/index.android.bundle
Done writing bundle output
Copying 21 asset files
Done copying assets
```

### 启动android项目
```
PS D:\EnterpriseApplicationPlatform\mobileend> npx react-native run-android        
info Installing the app...

> Task :app:installDebug
Installing APK 'app-debug.apk' on 'Nexus_S_API_33(AVD) - 13' for :app:debug
Installed on 1 device.

[Incubating] Problems report is available at: file:///D:/EnterpriseApplicationPlatform/mobileend/android/build/reports/problems/problems-report.html                  

Deprecated Gradle features were used in this build, making it incompatible with Gradle 9.0.

You can use '--warning-mode all' to show the individual deprecation warnings and determine if they come from your own scripts or plugins.

For more on this, please refer to https://docs.gradle.org/8.13/userguide/command_line_interface.html#sec:command_line_warnings in the Gradle documentation.

BUILD SUCCESSFUL in 49s
199 actionable tasks: 29 executed, 170 up-to-date
info Connecting to the development server...
info Starting the app on "emulator-5554"...
Starting: Intent { act=android.intent.action.MAIN cat=[android.intent.category.LAUNCHER] cmp=com.mobileend/.MainActivity }
```

   

### 总结
按照上述步骤，你可以分别启动前端和后端应用。前端应用在 http://localhost:3000 上运行，后端应用在 http://localhost:8080 上运行。确保前后端应用都成功启动后，你就可以在浏览器中访问前端应用，并与后端服务进行交互。


# 35.将本地已提交到GitHub的仓库同时推送到一个新的空Gitee仓库，可以按照以下步骤操作：
### 1. 添加Gitee远程仓库
```bash
# 进入项目目录
cd /path/to/your/project

# 查看当前远程仓库（通常已有一个GitHub的origin）
git remote -v

# 添加Gitee远程仓库（假设你的Gitee仓库地址为https://gitee.com/yourname/repo.git）
git remote add origin-gitee https://gitee.com/yourname/repo.git
```

### 2. 首次推送到Gitee
```bash
# 推送所有分支到Gitee
git push -u origin-gitee --all

# 推送所有标签到Gitee
git push -u origin-gitee --tags
 ```

 # 36.自动抠图在线工具：如remove.bg等自动抠图网站
   https://www.remove.bg/

# 37.图标网站
https://www.flaticon.com/packs/home-screen-apps-21

# 38. 